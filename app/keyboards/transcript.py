"""
–ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞–º–∏.
"""
from typing import Dict, List
from uuid import UUID
from datetime import datetime
import logging

from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.utils.keyboard import InlineKeyboardBuilder

from app.utils.timezone import TimezoneUtils
from app.utils.uuid_utils import safe_uuid
from app.utils.datetime_utils import format_datetime_for_user


def get_transcript_menu_keyboard() -> InlineKeyboardMarkup:
    """
    –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –º–µ–Ω—é —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏
    """
    builder = InlineKeyboardBuilder()
    builder.row(
        InlineKeyboardButton(text="üé§ –ê—É–¥–∏–æ", callback_data="transcribe_audio"),
        InlineKeyboardButton(text="üìù –¢–µ–∫—Å—Ç", callback_data="transcribe_text")
    )
    builder.row(
        InlineKeyboardButton(text="üìú –ò—Å—Ç–æ—Ä–∏—è", callback_data="transcribe_history")
    )
    builder.row(
        InlineKeyboardButton(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_main")
    )
    return builder.as_markup()


async def get_transcripts_keyboard(transcripts: List[Dict], telegram_id: int) -> InlineKeyboardMarkup:
    """
    –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å–ø–∏—Å–∫–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–æ–≤
    
    Args:
        transcripts: –°–ø–∏—Å–æ–∫ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–æ–≤
        telegram_id: Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
    Returns:
        –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞–º–∏
    """
    builder = InlineKeyboardBuilder()
    
    for transcript in transcripts:
        # –ü–æ–ª—É—á–∞–µ–º created_at –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å —É—á–µ—Ç–æ–º —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        created_at = transcript.get("created_at")
        date_str = await format_datetime_for_user(created_at, telegram_id)
        
        source = transcript["metadata"].get("source", "unknown") if transcript.get("metadata") else "unknown"
        label = f"{'üé§' if source == 'audio' else 'üìÑ'} {date_str}"
        
        # –ë–µ–∑–æ–ø–∞—Å–Ω–æ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º UUID
        uuid_obj = safe_uuid(transcript['id'])
        if not uuid_obj:
            logging.error(f"Invalid UUID in transcript: {transcript['id']}")
            continue
            
        builder.add(
            InlineKeyboardButton(
                text=label, callback_data=f"transcribe_view_{str(uuid_obj)}"
            )
        )
    
    builder.row(        InlineKeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="transcribe_back_to_menu")    )
    
    return builder.as_markup()


def get_format_keyboard(transcript_id: str | UUID) -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –≤—ã–±–æ—Ä–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏"""
    uuid_obj = safe_uuid(transcript_id)
    if not uuid_obj:
        raise ValueError(f"Invalid UUID: {transcript_id}")
    transcript_id_str = str(uuid_obj)
    builder = InlineKeyboardBuilder()
    builder.row(
        InlineKeyboardButton(
            text="üìù –ö—Ä–∞—Ç–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ",
            callback_data=f"transcribe_format_{transcript_id_str}_summary",
        ),
        InlineKeyboardButton(
            text="‚úÖ –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á",
            callback_data=f"transcribe_format_{transcript_id_str}_todo",
        ),
    )
    builder.row(
        InlineKeyboardButton(
            text="üìä –ü—Ä–æ—Ç–æ–∫–æ–ª",
            callback_data=f"transcribe_format_{transcript_id_str}_protocol",
        ),
    )
    builder.row(
        InlineKeyboardButton(
            text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="transcribe_back_to_menu"
        )
    )
    return builder.as_markup()


def get_transcript_actions_keyboard(transcript_id: str | UUID) -> InlineKeyboardMarkup:
    """
    –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–µ–π—Å—Ç–≤–∏–π —Å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–æ–º
    
    Args:
        transcript_id: ID —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞ (—Å—Ç—Ä–æ–∫–∞ –∏–ª–∏ UUID)
        
    Returns:
        InlineKeyboardMarkup —Å –∫–Ω–æ–ø–∫–∞–º–∏ –¥–µ–π—Å—Ç–≤–∏–π
    """
    uuid_obj = safe_uuid(transcript_id)
    if not uuid_obj:
        raise ValueError(f"Invalid UUID: {transcript_id}")
    transcript_id_str = str(uuid_obj)
    builder = InlineKeyboardBuilder()
    builder.row(
        InlineKeyboardButton(
            text="üìù –ö—Ä–∞—Ç–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ",
            callback_data=f"transcript_summary_{transcript_id_str}"
        ),
        InlineKeyboardButton(
            text="‚úÖ –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á",
            callback_data=f"transcript_todo_{transcript_id_str}"
        )
    )
    builder.row(
        InlineKeyboardButton(
            text="üìä –ü—Ä–æ—Ç–æ–∫–æ–ª",
            callback_data=f"transcript_protocol_{transcript_id_str}"
        )
    )
    builder.row(
        InlineKeyboardButton(
            text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥",
            callback_data="transcribe_history"
        ),
        InlineKeyboardButton(
            text="üè† –í –º–µ–Ω—é",
            callback_data="transcribe_back_to_menu"
        )
    )
    return builder.as_markup()


def get_back_to_transcript_keyboard(transcript_id: str | UUID) -> InlineKeyboardMarkup:
    """
    –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
    
    Args:
        transcript_id: ID —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞ (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –æ—Å—Ç–∞–≤–ª–µ–Ω –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
        
    Returns:
        InlineKeyboardMarkup —Å –∫–Ω–æ–ø–∫–æ–π –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –º–µ–Ω—é
    """
    builder = InlineKeyboardBuilder()
    builder.row(
        InlineKeyboardButton(
            text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é",
            callback_data="transcribe_back_to_menu"
        )
    )
    return builder.as_markup()


def get_back_to_menu_keyboard() -> InlineKeyboardMarkup:
    """
    –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –º–µ–Ω—é
    """
    builder = InlineKeyboardBuilder()
    builder.row(
        InlineKeyboardButton(text="‚óÄÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", callback_data="transcribe_back_to_menu")
    )
    return builder.as_markup()

# üóÑÔ∏è –û—Ç—á–µ—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –∞–≤–∞—Ç–∞—Ä–æ–≤

## üö® –ü—Ä–æ–±–ª–µ–º–∞

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö –æ—à–∏–±–æ–∫ BaseService –ø–æ—è–≤–∏–ª–∞—Å—å –Ω–æ–≤–∞—è –æ—à–∏–±–∫–∞:

```
sqlalchemy.exc.ProgrammingError: relation "avatars" does not exist
```

**–ü—Ä–∏—á–∏–Ω–∞**: –¢–∞–±–ª–∏—Ü–∞ `avatars` –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö, —Ö–æ—Ç—è –º–æ–¥–µ–ª—å –±—ã–ª–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –≤ –∫–æ–¥–µ.

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π
```bash
$ alembic history
07aef818449d -> 291dbd04d153 (head), add_avatar_models_and_enums
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –º–∏–≥—Ä–∞—Ü–∏–∏
–ú–∏–≥—Ä–∞—Ü–∏—è `291dbd04d153` –±—ã–ª–∞ **–ø—É—Å—Ç–æ–π**:
```python
def upgrade() -> None:
    pass  # ‚ùå –ü—É—Å—Ç–∞—è –º–∏–≥—Ä–∞—Ü–∏—è!

def downgrade() -> None:
    pass
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–æ–¥–µ–ª–∏
–ú–æ–¥–µ–ª—å `Avatar` –±—ã–ª–∞ **–ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞** –≤ `aisha_v2/app/database/models.py`:
```python
class Avatar(Base):
    """–ú–æ–¥–µ–ª—å –∞–≤–∞—Ç–∞—Ä–∞ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–æ–º –¥–ª—è FAL AI"""
    __tablename__ = "avatars"
    
    id: Mapped[UUID] = mapped_column(PGUUID(as_uuid=True), primary_key=True, default=uuid4)
    user_id: Mapped[UUID] = mapped_column(PGUUID(as_uuid=True), ForeignKey("users.id"))
    # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
```

## üîß –†–µ—à–µ–Ω–∏–µ

### 1. –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏
–°–æ–∑–¥–∞–ª –º–∏–≥—Ä–∞—Ü–∏—é –≤—Ä—É—á–Ω—É—é: `20250523_1830_create_avatars_manually.py`

```python
def upgrade() -> None:
    # –°–æ–∑–¥–∞–µ–º ENUM —Ç–∏–ø—ã
    avatar_gender_enum = sa.Enum('male', 'female', 'other', name='avatargender')
    avatar_status_enum = sa.Enum('draft', 'uploading', 'ready', 'training', 'completed', 'error', 'cancelled', name='avatarstatus')
    avatar_type_enum = sa.Enum('character', 'style', 'custom', name='avatartype')
    photo_validation_status_enum = sa.Enum('pending', 'valid', 'invalid', 'duplicate', name='photovalidationstatus')
    
    # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—ã
    op.create_table('avatars', ...)
    op.create_table('avatar_photos', ...)
    
    # –°–æ–∑–¥–∞–µ–º –∏–Ω–¥–µ–∫—Å—ã
    op.create_index('ix_avatars_finetune_id', 'avatars', ['finetune_id'])
    op.create_index('ix_avatars_user_id', 'avatars', ['user_id'])
```

### 2. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏
```bash
$ alembic upgrade head
```

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü

### –¢–∞–±–ª–∏—Ü–∞ `avatars`
- **id** (UUID, PK) - –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
- **user_id** (UUID, FK) - –°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **name** (String) - –ù–∞–∑–≤–∞–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–∞
- **gender** (Enum) - –ü–æ–ª –∞–≤–∞—Ç–∞—Ä–∞
- **avatar_type** (Enum) - –¢–∏–ø –∞–≤–∞—Ç–∞—Ä–∞
- **status** (Enum) - –°—Ç–∞—Ç—É—Å –æ–±—É—á–µ–Ω–∏—è
- **finetune_id** (String) - ID –æ–±—É—á–µ–Ω–∏—è –≤ FAL AI
- **training_progress** (Integer) - –ü—Ä–æ–≥—Ä–µ—Å—Å –æ–±—É—á–µ–Ω–∏—è 0-100
- **fal_mode** (String) - –†–µ–∂–∏–º –æ–±—É—á–µ–Ω–∏—è
- **avatar_data** (JSON) - –î–∞–Ω–Ω—ã–µ –∞–≤–∞—Ç–∞—Ä–∞
- **training_config** (JSON) - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–±—É—á–µ–Ω–∏—è
- **photos_count** (Integer) - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
- **created_at/updated_at** (DateTime) - –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏

### –¢–∞–±–ª–∏—Ü–∞ `avatar_photos`
- **id** (UUID, PK) - –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
- **avatar_id** (UUID, FK) - –°—Å—ã–ª–∫–∞ –Ω–∞ –∞–≤–∞—Ç–∞—Ä
- **user_id** (UUID, FK) - –°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **minio_key** (String) - –ü—É—Ç—å –≤ MinIO
- **file_hash** (String) - –•–µ—à —Ñ–∞–π–ª–∞ –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏
- **validation_status** (Enum) - –°—Ç–∞—Ç—É—Å –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- **file_size** (Integer) - –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞
- **width/height** (Integer) - –†–∞–∑–º–µ—Ä—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
- **has_face** (Boolean) - –ï—Å—Ç—å –ª–∏ –ª–∏—Ü–æ
- **quality_score** (Float) - –û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞
- **photo_metadata** (JSON) - –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ç–æ

### ENUM —Ç–∏–ø—ã
- **AvatarGender**: male, female, other
- **AvatarStatus**: draft, uploading, ready, training, completed, error, cancelled
- **AvatarType**: character, style, custom
- **PhotoValidationStatus**: pending, valid, invalid, duplicate

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

### 1. –¢–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã —É—Å–ø–µ—à–Ω–æ
```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ PostgreSQL
SELECT table_name FROM information_schema.tables 
WHERE table_schema = 'public' AND table_name LIKE '%avatar%';

-- –†–µ–∑—É–ª—å—Ç–∞—Ç:
-- avatars
-- avatar_photos
```

### 2. –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –∞–≤–∞—Ç–∞—Ä–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –°–µ—Ä–≤–∏—Å `AvatarService` –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ –ë–î
- ‚úÖ –ó–∞–ø—Ä–æ—Å—ã `get_user_avatars()` –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- ‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∞–≤–∞—Ç–∞—Ä–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –ú–µ–Ω—é –∞–≤–∞—Ç–∞—Ä–æ–≤ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è

### 3. –¢–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
```bash
$ python -m pytest aisha_v2/tests/test_avatar_fixes.py::TestBaseServiceConstructors -v
================================ 4 passed ================================
```

## üõ°Ô∏è –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π
–î–æ–±–∞–≤–∏–ª –≤ `DEV_CHECKLIST.md`:
```markdown
### üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- [ ] ‚úÖ **–ü—Ä–æ–≤–µ—Ä—è–π –º–∏–≥—Ä–∞—Ü–∏–∏**: `alembic history` –∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–æ–≤
- [ ] ‚úÖ **–ù–µ —Å–æ–∑–¥–∞–≤–∞–π –ø—É—Å—Ç—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏**: –≤—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π `upgrade()` –∏ `downgrade()`
- [ ] ‚úÖ **–¢–µ—Å—Ç–∏—Ä—É–π –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î**: –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
```

### 2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
–°–æ–∑–¥–∞–ª —Ç–µ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü:
```python
def test_avatar_tables_exist():
    """–¢–µ—Å—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü –∞–≤–∞—Ç–∞—Ä–æ–≤"""
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ SQLAlchemy metadata
    assert 'avatars' in Base.metadata.tables
    assert 'avatar_photos' in Base.metadata.tables
```

## üéØ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–ü—Ä–æ–±–ª–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ—à–µ–Ω–∞!**

### –ö–ª—é—á–µ–≤—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
1. ‚úÖ **–°–æ–∑–¥–∞–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è** - —Ç–∞–±–ª–∏—Ü—ã –∞–≤–∞—Ç–∞—Ä–æ–≤ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
2. ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –≤—Å–µ –æ—à–∏–±–∫–∏ BaseService** - –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç
3. ‚úÖ **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –∞–≤–∞—Ç–∞—Ä–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç** - –º–µ–Ω—é –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
4. ‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏** - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º –≤ –±—É–¥—É—â–µ–º

### –†–µ–∑—É–ª—å—Ç–∞—Ç:
- **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Ç–æ–≤–∞** üóÑÔ∏è
- **–ê–≤–∞—Ç–∞—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç** üé≠
- **–¢–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç** ‚úÖ
- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞** üìö

–¢–µ–ø–µ—Ä—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç **—Å–æ–∑–¥–∞–≤–∞—Ç—å –∞–≤–∞—Ç–∞—Ä—ã –±–µ–∑ –æ—à–∏–±–æ–∫**! üéâ 
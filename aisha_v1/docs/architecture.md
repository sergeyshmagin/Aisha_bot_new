# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

> **–í–Ω–∏–º–∞–Ω–∏–µ! –í—Å–µ –º–æ–¥–µ–ª–∏ –ë–î –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ `database/models.py`. –ò–º–ø–æ—Ä—Ç—ã –º–æ–¥–µ–ª–µ–π ‚Äî —Ç–æ–ª—å–∫–æ `from database.models import ...`. –î—É–±–ª–∏—Ä—É—é—â–∏—Ö –º–æ–¥–µ–ª–µ–π –≤ –¥—Ä—É–≥–∏—Ö –ø–∞–ø–∫–∞—Ö –±—ã—Ç—å –Ω–µ –¥–æ–ª–∂–Ω–æ.**

## –û–±—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

–ü—Ä–æ–µ–∫—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø—É —á–∏—Å—Ç–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –Ω–∞ —Å–ª–æ–∏:

1. **Presentation Layer** (Telegram Bot)
   - –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
   - –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã
   - –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
   
   > **–í–∞–∂–Ω–æ:** –•–µ–Ω–¥–ª–µ—Ä—ã —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è –≤ –ø–æ—Ä—è–¥–∫–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ—Å—Ç–∏:
   > 1. –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Ö–µ–Ω–¥–ª–µ—Ä—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ transcribe.py) —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è –ø–µ—Ä–≤—ã–º–∏
   > 2. –û–±—â–∏–µ —Ö–µ–Ω–¥–ª–µ—Ä—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ general.py) —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏
   > 3. –ò–∑–±–µ–≥–∞–µ–º –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —Ö–µ–Ω–¥–ª–µ—Ä–æ–≤ –¥–ª—è –æ–¥–Ω–∏—Ö –∏ —Ç–µ—Ö –∂–µ –∫–æ–º–∞–Ω–¥/–∫–Ω–æ–ø–æ–∫

2. **Service Layer** (–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞)
   - UserService
   - AvatarService
   - TranscriptService
   - BalanceService
   - HistoryService

3. **Repository Layer** (–î–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º)
   - UserRepository
   - UserStateRepository
   - UserBalanceRepository
   - UserAvatarRepository
   - UserTranscriptRepository
   - TransactionRepository
   - UserHistoryRepository

4. **Data Layer**
   - PostgreSQL (–æ—Å–Ω–æ–≤–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ)
   - MinIO (—Ñ–∞–π–ª–æ–≤–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ)

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

> **–û—Å–Ω–æ–≤–Ω–∞—è —Ä–∞–±–æ—á–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: `aisha`. –ò–º—è –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∑–∞–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ .env –∏ alembic.ini.**

### –°—Ö–µ–º–∞ –¥–∞–Ω–Ω—ã—Ö

```mermaid
erDiagram
    UserProfile ||--o{ UserState : has
    UserProfile ||--o{ UserBalance : has
    UserProfile ||--o{ UserAvatar : has
    UserProfile ||--o{ UserTranscript : has
    UserProfile ||--o{ Transaction : has
    UserProfile ||--o{ UserHistory : has

    UserProfile {
        int user_id PK
        int telegram_id UK
        string first_name
        string last_name
        string username
        string language_code
        boolean is_premium
        datetime registered_at
        datetime updated_at
    }

    UserState {
        int id PK
        int user_id FK
        json state_data
        datetime created_at
        datetime updated_at
    }

    UserBalance {
        int id PK
        int user_id FK
        float coins
        datetime created_at
        datetime updated_at
    }

    UserAvatar {
        uuid id PK
        int user_id FK
        json avatar_data
        datetime created_at
        datetime updated_at
    }

    UserTranscript {
        uuid id PK
        int user_id FK
        json transcript_data
        datetime created_at
        datetime updated_at
    }

    Transaction {
        uuid id PK
        int user_id FK
        float amount
        string type
        text description
        datetime created_at
    }

    UserHistory {
        uuid id PK
        int user_id FK
        string action_type
        json action_data
        datetime created_at
        datetime updated_at
    }
```

### –ò–Ω–¥–µ–∫—Å—ã

1. **UserProfile**
   - `idx_user_telegram_id` (UNIQUE) –Ω–∞ `telegram_id`
   - `idx_user_username` –Ω–∞ `username`

2. **UserState**
   - `idx_user_state_user_id` –Ω–∞ `user_id`

3. **UserBalance**
   - `idx_user_balance_user_id` –Ω–∞ `user_id`

4. **UserAvatar**
   - `idx_user_avatar_user_id` –Ω–∞ `user_id`
   - `idx_user_avatar_created_at` –Ω–∞ `created_at`

5. **UserTranscript**
   - `idx_user_transcript_user_id` –Ω–∞ `user_id`
   - `idx_user_transcript_created_at` –Ω–∞ `created_at`

6. **Transaction**
   - `idx_transaction_user_id` –Ω–∞ `user_id`
   - `idx_transaction_created_at` –Ω–∞ `created_at`

7. **UserHistory**
   - `idx_user_history_user_id` –Ω–∞ `user_id`
   - `idx_user_history_action_type` –Ω–∞ `action_type`
   - `idx_user_history_created_at` –Ω–∞ `created_at`

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. **UserBalance**
   - `check_coins_positive`: coins >= 0

2. **Transaction**
   - `check_transaction_type`: type IN ('credit', 'debit')

3. **UserHistory**
   - `check_action_type`: action_type IN ('avatar_created', 'transcript_created', 'balance_updated', 'transaction_created')

4. **–í–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏**
   - –í—Å–µ –≤–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã —Å `

## –•—Ä–∞–Ω–µ–Ω–∏–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–æ–≤
- –í—Å–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç—ã (—Ç–µ–∫—Å—Ç–æ–≤—ã–µ –∏ –∞—É–¥–∏–æ) —Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ MinIO (bucket transcripts).
- –ö—ç—à –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω —á–µ—Ä–µ–∑ —Ç–∞–±–ª–∏—Ü—É user_transcript_cache (user_id, path=minio_key, created_at).
- –õ–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞–º.
- –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∏ —Ö–µ–Ω–¥–ª–µ—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç —Ç–æ–ª—å–∫–æ —Å MinIO-–∫–ª—é—á–∞–º–∏ –∏ –∫—ç—à–µ–º.
- –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è download_file(bucket, minio_key) –ø–æ –∫–ª—é—á—É –∏–∑ –∫—ç—à–∞.

## –ê–≤–∞—Ç–∞—Ä—ã: —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞

- –í—Å–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∞–≤–∞—Ç–∞—Ä–æ–≤ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ PostgreSQL (user_avatars, user_avatar_photos)
- –í—Å–µ —Ñ–æ—Ç–æ –∞–≤–∞—Ç–∞—Ä–æ–≤ ‚Äî —Ç–æ–ª—å–∫–æ –≤ MinIO (bucket avatars/)
- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏ –≥–∞–ª–µ—Ä–µ—è —Ä–∞–±–æ—Ç–∞—é—Ç —á–µ—Ä–µ–∑ –≤—ã–±–æ—Ä–∫—É –∏–∑ user_avatar_photos –∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –∏–∑ MinIO
- –ù–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã—Ö json-—Ñ–∞–π–ª–æ–≤, –Ω–µ—Ç legacy FSM
- –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ, —Ä–∞–±–æ—Ç–∞—é—Ç —á–µ—Ä–µ–∑ SQLAlchemy AsyncSession

### –ì–∞–ª–µ—Ä–µ—è –∞–≤–∞—Ç–∞—Ä–æ–≤

- –í—Å—è –ª–æ–≥–∏–∫–∞ –≥–∞–ª–µ—Ä–µ–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ –æ–¥–Ω–æ–º –º–æ–¥—É–ª–µ (handlers/avatar/gallery.py) —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –µ–¥–∏–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã.
- –°—Ç–∞—Ä—ã–µ (legacy) —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –≥–∞–ª–µ—Ä–µ–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–µ–Ω—ã –∏–∑ –ø—Ä–æ–µ–∫—Ç–∞.
- –í—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –ø—Ä–æ–≥—Ä–µ—Å—Å–±–∞—Ä, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –Ω–∞–≤–∏–≥–∞—Ü–∏—è, –∫–Ω–æ–ø–∫–∏ "‚≠ê", "‚úèÔ∏è", "üóë", "–í –º–µ–Ω—é", "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å", "–û—Ç–º–µ–Ω–∏—Ç—å".
- –î–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –≥–∞–ª–µ—Ä–µ–∏ –¥–æ–±–∞–≤–ª—è–π—Ç–µ –Ω–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏ –∏ –ª–æ–≥–∏–∫—É —Ç–æ–ª—å–∫–æ –≤ –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É.
- –ü–æ–¥–ø–∏—Å–∏ –∫ —Ñ–æ—Ç–æ (caption) —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ get_gallery_caption —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–±–∞—Ä–æ–º –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏.

## –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º (FSM)

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
1. –í—Å–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ PostgreSQL —á–µ—Ä–µ–∑ `StateRepository`
2. –ö–∞–∂–¥–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è —Å —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º —Ç—Ä–µ–±—É–µ—Ç `AsyncSession`
3. –°–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ UUID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∞ –Ω–µ –∫ Telegram ID

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
1. `StateRepository` - —Ä–∞–±–æ—Ç–∞ —Å –ë–î
2. `state_utils.py` - —É—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
3. `StateType` - —Ç–∏–ø—ã —Å–æ—Å—Ç–æ—è–Ω–∏–π (str –∏–ª–∏ Dict[str, Any])

### –ü—Ä–∞–≤–∏–ª–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
1. –í—Å–µ–≥–¥–∞ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å `session` –≤ —Ñ—É–Ω–∫—Ü–∏–∏:
   - `set_state(user_id, state, session)`
   - `get_state(user_id, session)`
   - `clear_state(user_id, session)`
2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å UUID –≤–º–µ—Å—Ç–æ Telegram ID
3. –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
4. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –æ—à–∏–±–∫–∏ –ë–î

### –ü—Ä–∏–º–µ—Ä—ã —Å–æ—Å—Ç–æ—è–Ω–∏–π
```python
class States:
    MAIN_MENU = "main_menu"
    AVATAR_CREATE = "avatar_create"
    AVATAR_EDIT = "avatar_edit"
    AVATAR_CONFIRM = "avatar_confirm"
    AVATAR_ENTER_NAME = "avatar_enter_name"
    TRANSCRIBE_TXT = "transcribe_txt"
    TRANSCRIBE_AUDIO = "transcribe_audio"
```

### –ú–∏–≥—Ä–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π
1. –í—Å–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ PostgreSQL
2. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `StateRepository` –¥–ª—è CRUD –æ–ø–µ—Ä–∞—Ü–∏–π
3. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —á–µ—Ä–µ–∑ –∞–ª–∏–∞—Å—ã

### FSM –¥–ª—è –∞–≤–∞—Ç–∞—Ä–æ–≤

#### –°–æ—Å—Ç–æ—è–Ω–∏—è
1. `avatar_create` - –Ω–∞—á–∞–ª–æ —Å–æ–∑–¥–∞–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–∞
2. `avatar_photo_upload` - –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ
3. `avatar_type_select` - –≤—ã–±–æ—Ä —Ç–∏–ø–∞ –∞–≤–∞—Ç–∞—Ä–∞
4. `avatar_enter_name` - –≤–≤–æ–¥ –∏–º–µ–Ω–∏
5. `avatar_confirm` - –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è
6. `avatar_edit` - —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–∞

#### –ü–µ—Ä–µ—Ö–æ–¥—ã
1. `avatar_create` ‚Üí `avatar_photo_upload`
   - –¢—Ä–∏–≥–≥–µ—Ä: –∫–æ–º–∞–Ω–¥–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–∞
   - –í–∞–ª–∏–¥–∞—Ü–∏—è: –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   
2. `avatar_photo_upload` ‚Üí `avatar_type_select`
   - –¢—Ä–∏–≥–≥–µ—Ä: –∑–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ñ–æ—Ç–æ
   - –í–∞–ª–∏–¥–∞—Ü–∏—è: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ç–æ –≤ MinIO
   
3. `avatar_type_select` ‚Üí `avatar_enter_name`
   - –¢—Ä–∏–≥–≥–µ—Ä: –≤—ã–±–æ—Ä —Ç–∏–ø–∞ –∞–≤–∞—Ç–∞—Ä–∞
   - –í–∞–ª–∏–¥–∞—Ü–∏—è: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–∞
   
4. `avatar_enter_name` ‚Üí `avatar_confirm`
   - –¢—Ä–∏–≥–≥–µ—Ä: –≤–≤–æ–¥ –∏–º–µ–Ω–∏
   - –í–∞–ª–∏–¥–∞—Ü–∏—è: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –∏–º–µ–Ω–∏
   
5. `avatar_confirm` ‚Üí `main_menu`
   - –¢—Ä–∏–≥–≥–µ—Ä: –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è
   - –í–∞–ª–∏–¥–∞—Ü–∏—è: –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –∞–≤–∞—Ç–∞—Ä–∞
   
6. `avatar_edit` ‚Üí `avatar_photo_upload`
   - –¢—Ä–∏–≥–≥–µ—Ä: –∫–æ–º–∞–Ω–¥–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
   - –í–∞–ª–∏–¥–∞—Ü–∏—è: –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

#### –í–∞–ª–∏–¥–∞—Ü–∏—è
1. –ù–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è:
   - –°—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–∞ –≤ –ë–î
   - –ü—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç—å –∞–≤–∞—Ç–∞—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
   - –ù–∞–ª–∏—á–∏–µ —Ñ–æ—Ç–æ –≤ MinIO
   - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–∞

2. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏–∏:
   - `validate_avatar_exists()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ë–î
   - `validate_avatar_photos()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ MinIO
   - `validate_avatar_state()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è

3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ—à–∏–±–æ–∫
   - –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
   - –í–æ–∑–≤—Ä–∞—Ç –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ

#### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
1. –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –∞–≤–∞—Ç–∞—Ä–∞–º–∏ —Ç—Ä–µ–±—É—é—Ç:
   - –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –ü—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
   - –í–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
   
2. –ó–∞—â–∏—Ç–∞ –æ—Ç:
   - –ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
   - –ò–∑–º–µ–Ω–µ–Ω–∏—è —á—É–∂–∏—Ö –∞–≤–∞—Ç–∞—Ä–æ–≤
   - –ü–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å–±–æ—è—Ö

## –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã
- –í—Å–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –∞–≤–∞—Ç–∞—Ä–∞–º–∏ (–≤—ã–±–æ—Ä —Ç–∏–ø–∞, —ç—Ç–∞–ø –∑–∞–≥—Ä—É–∑–∫–∏, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ, –≥–∞–ª–µ—Ä–µ—è –∏ –¥—Ä.), —Ä–∞–∑–º–µ—â–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ `frontend_bot/keyboards/avatar.py`.
- –í `frontend_bot/keyboards/common.py` –æ—Å—Ç–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ—Ç–º–µ–Ω–∞, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ —Ä–∞–∑–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö).
- –ò–º–ø–æ—Ä—Ç—ã –æ–±–Ω–æ–≤–ª—è—Ç—å –ø—Ä–∏ –ø–µ—Ä–µ–Ω–æ—Å–µ.

## –ë—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è —Ñ–æ—Ç–æ —á–µ—Ä–µ–∑ Redis

- –î–ª—è —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è race condition –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –º–Ω–æ–≥–æ–ø—Ä–æ—Ü–µ—Å—Å–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Redis-–±—É—Ñ–µ—Ä –¥–ª—è —Ñ–æ—Ç–æ.
- –í—Å–µ —Ñ–æ—Ç–æ, –ø—Ä–∏—à–µ–¥—à–∏–µ –¥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–∞ –≤ –ë–î, –≤—Ä–µ–º–µ–Ω–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ Redis (–∫–ª—é—á `photo_buffer:{user_id}`) —Å TTL 5 –º–∏–Ω—É—Ç.
- –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–∞ FSM –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ —Ñ–æ—Ç–æ –∏–∑ Redis-–±—É—Ñ–µ—Ä–∞.
- –ü—Ä–∏ –æ—Ç–º–µ–Ω–µ –≤–∏–∑–∞—Ä–¥–∞ –±—É—Ñ–µ—Ä –æ—á–∏—â–∞–µ—Ç—Å—è.
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç Redis (`frontend_bot/shared/redis_client.py`), –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –±–µ—Ä—É—Ç—Å—è –∏–∑ `.env` —á–µ—Ä–µ–∑ Pydantic-–∫–æ–Ω—Ñ–∏–≥.
- –ù–µ—Ç –ø–æ—Ç–µ—Ä–∏ —Ñ–æ—Ç–æ –ø—Ä–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å–∞, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ.
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è: Redis –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω, TTL –±—É—Ñ–µ—Ä–∞ ‚Äî 5 –º–∏–Ω—É—Ç (–º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å).

### –°—Ö–µ–º–∞ —Ä–∞–±–æ—Ç—ã:
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—É—Å–∫–∞–µ—Ç –≤–∏–∑–∞—Ä–¥ —Å–æ–∑–¥–∞–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–∞.
2. –ï—Å–ª–∏ —Ñ–æ—Ç–æ –ø—Ä–∏—Ö–æ–¥—è—Ç –¥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–∞ ‚Äî –æ–Ω–∏ –±—É—Ñ–µ—Ä–∏–∑—É—é—Ç—Å—è –≤ Redis.
3. –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–∞ FSM –∑–∞–±–∏—Ä–∞–µ—Ç –≤—Å–µ —Ñ–æ—Ç–æ –∏–∑ Redis –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏—Ö.
4. –ü—Ä–∏ –æ—Ç–º–µ–Ω–µ –≤–∏–∑–∞—Ä–¥–∞ –∏–ª–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Å–µ—Å—Å–∏–∏ –±—É—Ñ–µ—Ä –æ—á–∏—â–∞–µ—Ç—Å—è.

### Best practices:
- –í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã Redis —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤ –∫–æ–Ω—Ñ–∏–≥–µ.
- –ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è in-memory –∏ Redis-–±—É—Ñ–µ—Ä–∞.
- –î–ª—è production —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ Redis –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–∏–º–∏—Ç–æ–≤/TTL.

## [avatar] –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ

- –í—Å—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–æ—Ç–æ —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —Å–µ—Ä–≤–∏—Å–µ: `frontend_bot/services/avatar_workflow.py::handle_photo_upload`.
- –í —Ö–µ–Ω–¥–ª–µ—Ä–∞—Ö –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ñ—É–Ω–∫—Ü–∏–π —Å —Ç–∞–∫–∏–º –∂–µ –∏–º–µ–Ω–µ–º! –î–ª—è —à–∞–≥–æ–≤ –≤–∏–∑–∞—Ä–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ thin-–æ–±—ë—Ä—Ç–∫–∏ —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ –∏–º–µ–Ω–∞–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `handle_photo_upload_show_menu`).
- –õ—é–±–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –±—É—Ñ–µ—Ä–∞, –≤–∞–ª–∏–¥–∞—Ü–∏—è, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ‚Äî —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å.
- –≠—Ç–æ –∏—Å–∫–ª—é—á–∞–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø—É—Ç–∞–Ω–∏—Ü—É –º–µ–∂–¥—É —Å–ª–æ—è–º–∏.

## [storage] –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã —Å MinIO

- –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∏ —Ö–µ–Ω–¥–ª–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ç–æ–ª—å–∫–æ `frontend_bot/services/minio_client.py` –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å MinIO (upload, download, delete, generate_presigned_url, check_file_exists).
- –ü—Ä—è–º–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ Minio-–∫–ª–∏–µ–Ω—Ç–∞ (`Minio(...)`) –∏ –∏–º–ø–æ—Ä—Ç—ã –∏–∑ –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, shared_storage.storage_utils) –∑–∞–ø—Ä–µ—â–µ–Ω—ã.
- –í —Ç–µ—Å—Ç–∞—Ö –¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä—è–º–æ–π –∫–ª–∏–µ–Ω—Ç –∏–ª–∏ –º–æ–∫.
- –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –µ–¥–∏–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å –∏ –ø—Ä–æ—Å—Ç–æ—Ç—É –ø–æ–¥–¥–µ—Ä–∂–∫–∏.

## –†–∞–±–æ—Ç–∞ —Å MinIO

- –í—Å—è —Ä–∞–±–æ—Ç–∞ —Å MinIO (–∑–∞–≥—Ä—É–∑–∫–∞, —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è presigned URL –∏ —Ç.–¥.) –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –º–æ–¥—É–ª—å `frontend_bot/services/minio_client.py`.
- –ü—Ä—è–º–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–æ–≤ Minio, –¥—É–±–ª–∏—Ä—É—é—â–∏–µ singleton-–æ–±—ë—Ä—Ç–∫–∏ –∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ç–æ—á–∫–∏ –≤—Ö–æ–¥–∞ –∑–∞–ø—Ä–µ—â–µ–Ω—ã.
- –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–æ–ª–∂–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –∫–ª–∏–µ–Ω—Ç –∏–∑ —ç—Ç–æ–≥–æ –º–æ–¥—É–ª—è.
- –í —Ç–µ—Å—Ç–∞—Ö –∏ —Å–∫—Ä–∏–ø—Ç–∞—Ö –¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è —Å–æ–∑–¥–∞–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ Minio –¥–ª—è –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –Ω—É–∂–¥.

### –£–¥–∞–ª–µ–Ω–∏–µ legacy

- –§–∞–π–ª `shared_storage/storage_utils.py` —É–¥–∞–ª—ë–Ω –∫–∞–∫ —É—Å—Ç–∞—Ä–µ–≤—à–∏–π (legacy).
- –í—Å—è —Ä–∞–±–æ—Ç–∞ —Å MinIO (–∑–∞–≥—Ä—É–∑–∫–∞, —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ, presigned URL –∏ —Ç.–¥.) –≤–µ–¥—ë—Ç—Å—è —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –º–æ–¥—É–ª—å `frontend_bot/services/minio_client.py`.
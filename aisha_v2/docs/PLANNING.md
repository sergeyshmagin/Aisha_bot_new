# Планирование проекта Aisha v2

Текущий этап: Миграция функциональности из v1 в v2

## Результаты инвентаризации кода (22.05.2025)

### Общая структура проекта
```
aisha_v2/
├── alembic/            # Миграции базы данных
├── app/                # Основной код приложения
│   ├── core/           # Ядро приложения (конфиги, константы, исключения)
│   ├── database/       # Модели и репозитории
│   ├── handlers/       # Обработчики команд бота
│   ├── keyboards/      # Клавиатуры для бота
│   ├── prompts/        # Промпты для GPT
│   ├── services/       # Сервисы (бизнес-логика)
│   ├── texts/          # Тексты для пользовательского интерфейса
│   └── utils/          # Утилиты
├── docs/               # Документация
├── scripts/            # Вспомогательные скрипты
├── storage/            # Хранилище файлов
└── tests/              # Тесты
```

### Статус миграции функциональности транскрибации
Функциональность транскрибации полностью перенесена из v1 в v2 с улучшенной архитектурой:

#### Реализованные компоненты:
1. **Модели и репозитории**:
   - `UserTranscript`: Модель для хранения метаданных транскриптов
   - `TranscriptRepository`: Репозиторий для работы с транскриптами в БД

2. **Сервисы**:
   - `TranscriptService`: Для управления транскриптами (сохранение, получение, удаление)
   - `AudioProcessingService`: Для обработки аудио через Whisper API
   - `TextProcessingService`: Для обработки текста и генерации форматов

3. **Обработчики**:
   - `TranscriptHandler`: Главный обработчик команд транскрибации
   - Специализированные обработчики для просмотра и управления транскриптами

4. **Интерфейс**:
   - Клавиатуры для работы с транскриптами
   - Кнопки для различных действий с транскриптами

5. **Инфраструктура**:
   - Интеграция с MinIO для хранения файлов транскриптов
   - Кэширование с использованием Redis

#### Текущее состояние системы:
- **Архитектурный подход**: Чистая архитектура с разделением на репозитории, сервисы и обработчики
- **Паттерны проектирования**: Репозиторий, Фабрика, Стратегия
- **Хранение данных**: Метаданные в PostgreSQL, файлы в MinIO
- **Транскрибация**: Интеграция с Whisper API
- **Обработка текста**: Интеграция с GPT для генерации саммари, списков задач и протоколов

### Технический долг и проблемы
1. Отсутствие полного покрытия тестами
2. Необходимость рефакторинга обработчиков для лучшего разделения ответственности
3. Потребность в оптимизации работы с большими аудиофайлами
4. Требуется внедрение пагинации в списке транскриптов

### Запланированные улучшения
1. Написание unit-тестов для всех компонентов системы
2. Разделение класса TranscriptHandler на более специализированные обработчики
3. Создание механизма пагинации для истории транскриптов
4. Добавление поддержки других языков для транскрибации
5. Создание централизованного механизма обработки исключений
6. Улучшение логирования

### Зависимости и интеграции
1. Redis - для кэширования и FSM
2. PostgreSQL - для хранения метаданных
3. MinIO - для хранения файлов
4. OpenAI API (Whisper, GPT) - для транскрибации и обработки текста
5. FFmpeg - для обработки аудио

### Следующие шаги
1. Тестирование: Создание комплексных тестов для всей функциональности транскрибации
2. Рефакторинг: Улучшение структуры кода и разделение ответственности
3. Производительность: Оптимизация работы с большими файлами
4. UX: Улучшение пользовательского интерфейса и добавление новых функций

- Для корректной работы миграций переменная окружения `DATABASE_URL` должна быть определена (см. `.env`).
- Все модели должны быть импортированы в `app.database.models.Base` для поддержки autogenerate.
- Перед применением миграций делать бэкап БД.
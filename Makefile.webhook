# Makefile –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Webhook API
# –î–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä–∞ 192.168.0.10 (aibots.kz)

.PHONY: help build push deploy verify monitor status logs clean restart

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
PROD_SERVER = 192.168.0.10
PROD_USER = aisha
DEV_REGISTRY = 192.168.0.3:5000
COMPOSE_FILE = docker-compose.webhook.prod.yml
PROJECT_NAME = aisha-webhook-api

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN = \033[0;32m
YELLOW = \033[1;33m
RED = \033[0;31m
NC = \033[0m

help: ## –ü–æ–∫–∞–∑–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
	@echo "üöÄ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Aisha Webhook API"
	@echo "================================"
	@echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  $(GREEN)%-15s$(NC) %s\n", $$1, $$2}' $(MAKEFILE_LIST)

# ============================================================================
# –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∏ —Å–±–æ—Ä–∫–∞
# ============================================================================

build: ## –°–æ–±—Ä–∞—Ç—å –æ–±—Ä–∞–∑—ã –¥–ª—è webhook API
	@echo "$(YELLOW)üî® –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–æ–≤...$(NC)"
	docker build -t $(DEV_REGISTRY)/aisha-nginx-webhook:latest -f docker/nginx/Dockerfile docker/nginx/
	docker build -t $(DEV_REGISTRY)/aisha-webhook-api:latest -f docker/Dockerfile.webhook --target production .
	@echo "$(GREEN)‚úÖ –û–±—Ä–∞–∑—ã —Å–æ–±—Ä–∞–Ω—ã$(NC)"

push: ## –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–±—Ä–∞–∑—ã –≤ registry
	@echo "$(YELLOW)üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –æ–±—Ä–∞–∑–æ–≤ –≤ registry...$(NC)"
	docker push $(DEV_REGISTRY)/aisha-nginx-webhook:latest
	docker push $(DEV_REGISTRY)/aisha-webhook-api:latest
	@echo "$(GREEN)‚úÖ –û–±—Ä–∞–∑—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã$(NC)"

# ============================================================================
# –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
# ============================================================================

deploy: ## –ü–æ–ª–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω
	@echo "$(YELLOW)üöÄ –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è...$(NC)"
	./scripts/deploy-webhook-prod.sh full

deploy-quick: ## –ë—ã—Å—Ç—Ä–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ (—Ç–æ–ª—å–∫–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã)
	@echo "$(YELLOW)‚ö° –ë—ã—Å—Ç—Ä–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ...$(NC)"
	./scripts/deploy-webhook-prod.sh deploy

# ============================================================================
# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏
# ============================================================================

verify: ## –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
	@echo "$(YELLOW)üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è...$(NC)"
	@echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ HTTPS endpoint..."
	@curl -f -s https://aibots.kz:8443/health > /dev/null && echo "$(GREEN)‚úÖ HTTPS —Ä–∞–±–æ—Ç–∞–µ—Ç$(NC)" || echo "$(RED)‚ùå HTTPS –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω$(NC)"
	@echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
	@ssh $(PROD_USER)@$(PROD_SERVER) "cd /opt/aisha-webhook && docker-compose -f $(COMPOSE_FILE) ps"

status: ## –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
	@echo "$(YELLOW)üìä –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤$(NC)"
	@ssh $(PROD_USER)@$(PROD_SERVER) "cd /opt/aisha-webhook && docker-compose -f $(COMPOSE_FILE) ps"
	@echo "\n$(YELLOW)üîó –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å endpoints:$(NC)"
	@curl -f -s -o /dev/null -w "Health check: %{http_code}\n" https://aibots.kz:8443/health || echo "Health check: FAILED"
	@curl -f -s -o /dev/null -w "Webhook endpoint: %{http_code}\n" -X POST https://aibots.kz:8443/api/v1/avatar/test_webhook || echo "Webhook endpoint: FAILED"

logs: ## –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
	@echo "$(YELLOW)üìã –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤...$(NC)"
	ssh $(PROD_USER)@$(PROD_SERVER) "cd /opt/aisha-webhook && docker-compose -f $(COMPOSE_FILE) logs --tail=50"

logs-follow: ## –°–ª–µ–¥–∏—Ç—å –∑–∞ –ª–æ–≥–∞–º–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
	@echo "$(YELLOW)üìã –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤ (Ctrl+C –¥–ª—è –≤—ã—Ö–æ–¥–∞)...$(NC)"
	ssh $(PROD_USER)@$(PROD_SERVER) "cd /opt/aisha-webhook && docker-compose -f $(COMPOSE_FILE) logs -f"

logs-api: ## –ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ –ª–æ–≥–∏ API
	ssh $(PROD_USER)@$(PROD_SERVER) "cd /opt/aisha-webhook && docker-compose -f $(COMPOSE_FILE) logs --tail=50 webhook-api-1 webhook-api-2"

logs-nginx: ## –ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ –ª–æ–≥–∏ nginx
	ssh $(PROD_USER)@$(PROD_SERVER) "cd /opt/aisha-webhook && docker-compose -f $(COMPOSE_FILE) logs --tail=50 nginx"

# ============================================================================
# –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞–º–∏
# ============================================================================

restart: ## –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã
	@echo "$(YELLOW)üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤...$(NC)"
	ssh $(PROD_USER)@$(PROD_SERVER) "cd /opt/aisha-webhook && docker-compose -f $(COMPOSE_FILE) restart"
	@echo "$(GREEN)‚úÖ –°–µ—Ä–≤–∏—Å—ã –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω—ã$(NC)"

restart-api: ## –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ API —Å–µ—Ä–≤–∏—Å—ã
	@echo "$(YELLOW)üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ API...$(NC)"
	ssh $(PROD_USER)@$(PROD_SERVER) "cd /opt/aisha-webhook && docker-compose -f $(COMPOSE_FILE) restart webhook-api-1 webhook-api-2"

restart-nginx: ## –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ nginx
	@echo "$(YELLOW)üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ nginx...$(NC)"
	ssh $(PROD_USER)@$(PROD_SERVER) "cd /opt/aisha-webhook && docker-compose -f $(COMPOSE_FILE) restart nginx"

stop: ## –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã
	@echo "$(YELLOW)üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤...$(NC)"
	ssh $(PROD_USER)@$(PROD_SERVER) "cd /opt/aisha-webhook && docker-compose -f $(COMPOSE_FILE) stop"

start: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã
	@echo "$(YELLOW)‚ñ∂Ô∏è  –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤...$(NC)"
	ssh $(PROD_USER)@$(PROD_SERVER) "cd /opt/aisha-webhook && docker-compose -f $(COMPOSE_FILE) start"

# ============================================================================
# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
# ============================================================================

test-webhook: ## –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å webhook endpoint
	@echo "$(YELLOW)üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ webhook...$(NC)"
	@echo "–û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ webhook..."
	curl -X POST https://aibots.kz:8443/api/v1/avatar/test_webhook \
		-H "Content-Type: application/json" \
		-d '{"request_id": "test_$(shell date +%s)", "status": "completed"}' \
		-v

test-load: ## –¢–µ—Å—Ç –Ω–∞–≥—Ä—É–∑–∫–∏ (—Ç—Ä–µ–±—É–µ—Ç apache2-utils)
	@echo "$(YELLOW)‚ö° –¢–µ—Å—Ç –Ω–∞–≥—Ä—É–∑–∫–∏...$(NC)"
	@command -v ab >/dev/null 2>&1 || { echo "$(RED)–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ apache2-utils –¥–ª—è —Ç–µ—Å—Ç–æ–≤ –Ω–∞–≥—Ä—É–∑–∫–∏$(NC)"; exit 1; }
	ab -n 100 -c 10 https://aibots.kz:8443/health

# ============================================================================
# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –æ—Ç–ª–∞–¥–∫–∞
# ============================================================================

monitor: ## –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
	@echo "$(YELLOW)üìä –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞...$(NC)"
	./scripts/deploy-webhook-prod.sh monitor

health-check: ## –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–¥–æ—Ä–æ–≤—å–µ –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
	@echo "$(YELLOW)üè• –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–∏—Å—Ç–µ–º—ã...$(NC)"
	@echo "1. Webhook API endpoints:"
	@curl -f -s https://aibots.kz:8443/health && echo "  ‚úÖ Health OK" || echo "  ‚ùå Health FAILED"
	@echo "2. External services:"
	@echo "  Redis (192.168.0.3:6379)..."
	@nc -zv 192.168.0.3 6379 2>/dev/null && echo "  ‚úÖ Redis OK" || echo "  ‚ùå Redis FAILED"
	@echo "  PostgreSQL (192.168.0.4:5432)..."
	@nc -zv 192.168.0.4 5432 2>/dev/null && echo "  ‚úÖ PostgreSQL OK" || echo "  ‚ùå PostgreSQL FAILED"
	@echo "  MinIO (192.168.0.4:9000)..."
	@nc -zv 192.168.0.4 9000 2>/dev/null && echo "  ‚úÖ MinIO OK" || echo "  ‚ùå MinIO FAILED"

metrics: ## –ü–æ–∫–∞–∑–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
	@echo "$(YELLOW)üìà –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏$(NC)"
	@echo "Docker —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:"
	ssh $(PROD_USER)@$(PROD_SERVER) "docker stats --no-stream aisha-webhook-api-1 aisha-webhook-api-2 aisha-nginx-webhook 2>/dev/null || echo '–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –Ω–µ –∑–∞–ø—É—â–µ–Ω—ã'"
	@echo "\n–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞:"
	ssh $(PROD_USER)@$(PROD_SERVER) "df -h /opt/aisha-webhook"

# ============================================================================
# –û—á–∏—Å—Ç–∫–∞ –∏ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ
# ============================================================================

clean: ## –û—á–∏—Å—Ç–∏—Ç—å —Å–∏—Å—Ç–µ–º—É –æ—Ç –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤
	@echo "$(YELLOW)üßπ –û—á–∏—Å—Ç–∫–∞ —Å–∏—Å—Ç–µ–º—ã...$(NC)"
	ssh $(PROD_USER)@$(PROD_SERVER) "docker system prune -f"
	ssh $(PROD_USER)@$(PROD_SERVER) "cd /opt/aisha-webhook && rm -rf /tmp/nginx_cache/* /tmp/nginx_webhook/* 2>/dev/null || true"
	@echo "$(GREEN)‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞$(NC)"

update: ## –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥ –∏ –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å
	@echo "$(YELLOW)üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã...$(NC)"
	$(MAKE) build push deploy-quick verify
	@echo "$(GREEN)‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ$(NC)"

# ============================================================================
# –£—Ç–∏–ª–∏—Ç—ã
# ============================================================================

ssh: ## –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä—É
	ssh $(PROD_USER)@$(PROD_SERVER)

ssh-logs: ## –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∏ —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏
	ssh $(PROD_USER)@$(PROD_SERVER) "cd /opt/aisha-webhook && docker-compose -f $(COMPOSE_FILE) logs -f"

backup-config: ## –°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
	@echo "$(YELLOW)üíæ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏...$(NC)"
	mkdir -p backups/$(shell date +%Y%m%d_%H%M%S)
	cp $(COMPOSE_FILE) backups/$(shell date +%Y%m%d_%H%M%S)/
	cp docker/nginx/nginx.conf backups/$(shell date +%Y%m%d_%H%M%S)/
	cp docker/Dockerfile.webhook backups/$(shell date +%Y%m%d_%H%M%S)/
	@echo "$(GREEN)‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞$(NC)"

info: ## –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–∏—Å—Ç–µ–º–µ
	@echo "$(GREEN)üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ$(NC)"
	@echo "–ü—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä: $(PROD_SERVER)"
	@echo "Registry: $(DEV_REGISTRY)"
	@echo "Compose file: $(COMPOSE_FILE)"
	@echo "–ü—Ä–æ–µ–∫—Ç: $(PROJECT_NAME)"
	@echo ""
	@echo "Endpoints:"
	@echo "  üîó Webhook: https://aibots.kz:8443/api/v1/avatar/status_update"
	@echo "  üè• Health: https://aibots.kz:8443/health"
	@echo "  üìä Monitor: http://aibots.kz:9090"
	@echo ""
	@echo "–í–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã:"
	@echo "  üìä Redis: 192.168.0.3:6379"
	@echo "  üóÑÔ∏è  PostgreSQL: 192.168.0.4:5432"
	@echo "  üì¶ MinIO: 192.168.0.4:9000" 
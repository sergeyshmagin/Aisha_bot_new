#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ firewall –¥–ª—è Aisha Bot API —Å–µ—Ä–≤–µ—Ä–∞
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: sudo ./setup_firewall.sh

set -e

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1"
    exit 1
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ root
if [[ $EUID -ne 0 ]]; then
   error "–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è —Å –ø—Ä–∞–≤–∞–º–∏ root (sudo)"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è ufw
if ! command -v ufw &> /dev/null; then
    log "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ ufw..."
    apt update
    apt install -y ufw
fi

log "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ firewall –¥–ª—è Aisha Bot API —Å–µ—Ä–≤–µ—Ä–∞..."

# –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞
log "–¢–µ–∫—É—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞ firewall:"
ufw status

read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É firewall? –≠—Ç–æ –∏–∑–º–µ–Ω–∏—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞. (y/N): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    log "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ firewall –æ—Ç–º–µ–Ω–µ–Ω–∞"
    exit 0
fi

# –°–±—Ä–æ—Å –ø—Ä–∞–≤–∏–ª (–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ!)
warn "–°–±—Ä–æ—Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø—Ä–∞–≤–∏–ª firewall..."
ufw --force reset

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–∑–æ–≤—ã—Ö –ø—Ä–∞–≤–∏–ª
log "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–∑–æ–≤—ã—Ö –ø—Ä–∞–≤–∏–ª..."
ufw default deny incoming
ufw default allow outgoing

# SSH (–≤–∞–∂–Ω–æ!)
log "–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ SSH (–ø–æ—Ä—Ç 22)..."
ufw allow 22/tcp
ufw limit 22/tcp  # –ó–∞—â–∏—Ç–∞ –æ—Ç –±—Ä—É—Ç—Ñ–æ—Ä—Å–∞

# HTTP/HTTPS (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω –≤–µ–±-—Å–µ—Ä–≤–µ—Ä)
log "–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ HTTP/HTTPS..."
ufw allow 80/tcp
ufw allow 443/tcp

# API Server –Ω–∞ –ø–æ—Ä—Ç—É 8443 (—Ç–æ–ª—å–∫–æ –¥–ª—è FAL AI)
log "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ API —Å–µ—Ä–≤–µ—Ä—É (–ø–æ—Ä—Ç 8443)..."

# IP –∞–¥—Ä–µ—Å–∞ FAL AI (–ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏)
FAL_AI_IPS=(
    "185.199.108.0/22"
    "140.82.112.0/20"
)

for ip in "${FAL_AI_IPS[@]}"; do
    log "–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ —Å $ip –∫ –ø–æ—Ä—Ç—É 8443..."
    ufw allow from $ip to any port 8443
done

# –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ API —Å–µ—Ä–≤–µ—Ä—É (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
log "–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ API —Å–µ—Ä–≤–µ—Ä—É..."
ufw allow from 127.0.0.1 to any port 8443
ufw allow from 127.0.0.1 to any port 8000  # –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø–æ—Ä—Ç API

# –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä—è–º–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º—É –ø–æ—Ä—Ç—É API (8000) –∏–∑–≤–Ω–µ
log "–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤–Ω–µ—à–Ω–µ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–æ—Ä—Ç—É 8000..."
ufw deny 8000/tcp

# PostgreSQL - —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø
log "–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤–Ω–µ—à–Ω–µ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ PostgreSQL..."
ufw deny 5432/tcp

# –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ ping (ICMP)
log "–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ ping (ICMP)..."
ufw allow in on lo
ufw allow out on lo

# –ê–∫—Ç–∏–≤–∞—Ü–∏—è firewall
log "–ê–∫—Ç–∏–≤–∞—Ü–∏—è firewall..."
ufw --force enable

# –ü–æ–∫–∞–∑–∞—Ç—å –∏—Ç–æ–≥–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞
log "–ò—Ç–æ–≥–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞ firewall:"
ufw status numbered

log "üéâ Firewall –Ω–∞—Å—Ç—Ä–æ–µ–Ω!"
echo
log "–ù–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞:"
echo "‚úÖ SSH (–ø–æ—Ä—Ç 22) - —Ä–∞–∑—Ä–µ—à–µ–Ω —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –±—Ä—É—Ç—Ñ–æ—Ä—Å–∞"
echo "‚úÖ HTTP (–ø–æ—Ä—Ç 80) - —Ä–∞–∑—Ä–µ—à–µ–Ω"
echo "‚úÖ HTTPS (–ø–æ—Ä—Ç 443) - —Ä–∞–∑—Ä–µ—à–µ–Ω"
echo "‚úÖ API —Å–µ—Ä–≤–µ—Ä (–ø–æ—Ä—Ç 8443) - —Ä–∞–∑—Ä–µ—à–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è FAL AI"
echo "üö´ –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π API (–ø–æ—Ä—Ç 8000) - –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∏–∑–≤–Ω–µ"
echo "üö´ PostgreSQL (–ø–æ—Ä—Ç 5432) - –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∏–∑–≤–Ω–µ"
echo
log "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞:"
echo "- –õ–æ–∫–∞–ª—å–Ω–æ: curl http://localhost:8000/health"
echo "- –í–Ω–µ—à–Ω–∏–π (–¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å): curl https://aibots.kz:8443/health"
echo
warn "–í–ê–ñ–ù–û: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ SSH —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø—Ä–µ–∂–¥–µ —á–µ–º –æ—Ç–∫–ª—é—á–∞—Ç—å—Å—è –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞!" 
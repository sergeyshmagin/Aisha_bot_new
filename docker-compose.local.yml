version: '3.8'

# üöÄ Docker Compose –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ Aisha Bot
# –í–µ—Ä—Å–∏—è: 2.0 (2025-06-11)
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –≤–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã –∏ –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é

services:
  # ü§ñ –û—Å–Ω–æ–≤–Ω–æ–π –±–æ—Ç –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
  aisha-bot-dev:
    build:
      context: .
      dockerfile: docker/Dockerfile.bot
    container_name: aisha-bot-dev
    environment:
      # –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
      - PYTHONPATH=/app
      - INSTANCE_ID=bot-dev
      - BOT_MODE=polling
      - SET_POLLING=true
      
      # API –∫–ª—é—á–∏ (–∏–∑ .env —Ñ–∞–π–ª–∞)
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - FAL_API_KEY=${FAL_API_KEY}
      
      # –í–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã (—Ä–µ–∞–ª—å–Ω—ã–µ)
      - POSTGRES_HOST=192.168.0.4
      - POSTGRES_PORT=5432
      - POSTGRES_DB=aisha
      - POSTGRES_USER=aisha_user
      - POSTGRES_PASSWORD=KbZZGJHX09KSH7r9ev4m
      
      - REDIS_HOST=192.168.0.3
      - REDIS_PORT=6379
      - REDIS_PASSWORD=wd7QuwAbG0wtyoOOw3Sm
      
      - MINIO_ENDPOINT=192.168.0.4:9000
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=74rSbw9asQ1uMzcFeM5G
      - MINIO_SECURE=false
      
      # –†–∞–∑—Ä–∞–±–æ—Ç—á–µ—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
      - DEBUG=true
      - LOG_LEVEL=DEBUG
      - AVATAR_TEST_MODE=true
      
      # FAL AI –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
      - FAL_DEFAULT_QUALITY_PRESET=fast
      
    volumes:
      # –ú–æ–Ω—Ç–∏—Ä—É–µ–º –∫–æ–¥ –¥–ª—è live reload
      - ./app:/app/app:ro
      - ./alembic:/app/alembic:ro
      - ./main.py:/app/main.py:ro
      
      # –õ–æ–≥–∏ –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
      - ./temp/logs:/app/logs
      - ./temp/storage:/app/storage
      
    ports:
      # –î–ª—è –æ—Ç–ª–∞–¥–∫–∏ –µ—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è
      - "8080:8080"
      
    healthcheck:
      test: ["CMD", "pgrep", "-f", "python"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
      
    restart: unless-stopped
    
    # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –≤–Ω–µ—à–Ω–µ–π —Å–µ—Ç–∏ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–µ—Ä–≤–∏—Å–∞–º
    networks:
      - aisha_dev_network

  # üåê Webhook API –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  webhook-api-dev:
    build:
      context: .
      dockerfile: docker/Dockerfile.webhook
    container_name: webhook-api-dev
    environment:
      - PYTHONPATH=/app
      - DEBUG=true
      - LOG_LEVEL=DEBUG
      
      # –ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
      - POSTGRES_HOST=192.168.0.4
      - POSTGRES_PORT=5432
      - POSTGRES_DB=aisha
      - POSTGRES_USER=aisha_user
      - POSTGRES_PASSWORD=KbZZGJHX09KSH7r9ev4m
      
      - REDIS_HOST=192.168.0.3
      - REDIS_PORT=6379
      - REDIS_PASSWORD=wd7QuwAbG0wtyoOOw3Sm
      
    volumes:
      - ./api_server:/app/api_server:ro
      - ./app:/app/app:ro
      - ./temp/logs:/app/logs
      
    ports:
      - "8001:8000"
      
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
      
    restart: unless-stopped
    networks:
      - aisha_dev_network
      
    # –ó–∞–ø—É—Å–∫–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
    profiles:
      - webhook

# üåê –°–µ—Ç–∏
networks:
  aisha_dev_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

# üìÅ Volumes –¥–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è
volumes:
  dev_logs:
    driver: local
  dev_storage:
    driver: local 
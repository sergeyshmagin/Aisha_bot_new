# Лучшие практики разработки

## 1. Общие принципы

### 1.1. Структура проекта
- Используйте модульную структуру с четким разделением ответственности
- Следуйте принципу "один файл - одна ответственность"
- Максимальный размер файла - 500 строк
- Документируйте все публичные API и интерфейсы
- Размещайте общие утилиты в `shared/` директории
- Избегайте дублирования утилитарных функций

### 1.2. Код
- Следуйте PEP 8
- Используйте type hints
- Пишите docstrings для всех функций и классов
- Избегайте дублирования кода (DRY)
- Используйте константы вместо магических чисел
- Обрабатывайте все возможные исключения

### 1.3. Безопасность
- Никогда не храните секреты в коде
- Используйте переменные окружения для конфигурации
- Валидируйте все пользовательские входные данные
- Используйте безопасные методы хранения паролей
- Регулярно обновляйте зависимости

### 1.4. Утилиты и общие функции
- Размещайте общие утилиты в `shared/` директории
- Группируйте связанные утилиты в отдельные модули (например, `file_utils.py`, `image_utils.py`)
- Документируйте все параметры и возвращаемые значения
- Используйте type hints для всех функций
- Обрабатывайте все возможные исключения
- Пишите тесты для утилит
- Избегайте дублирования утилитарных функций
- Используйте единый стиль именования для утилит
- Следуйте принципу "один файл - одна группа утилит"
- Обновляйте импорты при перемещении функций
- Проверяйте все импорты после рефакторинга
- Используйте абсолютные импорты для утилит
- Документируйте зависимости между утилитами
- Следите за циклическими зависимостями

### 1.5. Ключи словарей и hashable-объекты
- Никогда не используйте list, dict, set в качестве ключей словаря или элементов set.
- Для составных ключей используйте tuple или строку с разделителем (например, f"{user_id}:{avatar_id}").
- После рефакторинга структуры ключей выполните поиск по коду на предмет старых паттернов.
- Добавляйте тесты, которые явно проверяют работу с ключами словарей.

## 2. Тестирование

### 2.1. Общие принципы тестирования
- Тесты должны быть независимыми и изолированными
- Каждый тест должен проверять одну конкретную функциональность
- Используйте фикстуры для подготовки тестового окружения
- Следуйте паттерну AAA (Arrange-Act-Assert)
- Поддерживайте тесты в актуальном состоянии

### 2.2. Моки и стабы
- Всегда мокайте внешние зависимости (API, базы данных, файловая система)
- Используйте `AsyncMock` для асинхронных функций
- Создавайте фикстуры для часто используемых моков
- Проверяйте вызовы моков с правильными параметрами
- Используйте `autouse=True` для глобальных моков (например, API клиентов)

### 2.3. Фикстуры
- Размещайте общие фикстуры в `conftest.py`
- Используйте `scope` для оптимизации выполнения тестов
- Создавайте фикстуры для тестовых данных
- Очищайте состояние после каждого теста
- Документируйте назначение фикстур

### 2.4. Асинхронное тестирование
- Используйте `pytest-asyncio` для асинхронных тестов
- Мокайте асинхронные контекстные менеджеры
- Используйте `AsyncMock` для асинхронных методов
- Проверяйте асинхронные вызовы с `await`
- Обрабатывайте асинхронные исключения

### 2.5. Изоляция тестов
- Каждый тест должен работать с изолированным окружением
- Очищайте состояние между тестами
- Используйте временные файлы и директории
- Мокайте системные вызовы
- Избегайте зависимостей между тестами

### 2.6. Покрытие кода
- Стремитесь к покрытию кода > 80%
- Тестируйте граничные случаи
- Проверяйте обработку ошибок
- Тестируйте асинхронные операции
- Включайте интеграционные тесты

### 2.7. Организация тестов
- Группируйте тесты по функциональности
- Используйте понятные имена тестов
- Документируйте тестовые сценарии
- Следуйте структуре проекта в тестах
- Используйте маркеры для категоризации тестов

### 2.8. Отладка тестов
- Используйте `pytest -v` для подробного вывода
- Включайте отладочные сообщения в тесты
- Проверяйте состояние моков
- Используйте `pdb` для отладки
- Логируйте важные операции

### 2.9. CI/CD
- Запускайте тесты в CI/CD пайплайне
- Проверяйте покрытие кода
- Используйте линтеры и форматтеры
- Автоматизируйте проверку типов
- Отслеживайте производительность тестов

### 2.10. Антипаттерны
- Избегайте тестов, зависящих от порядка выполнения
- Не используйте реальные API в тестах
- Не создавайте тесты, зависящие от времени
- Не используйте глобальное состояние
- Не игнорируйте ошибки в тестах

## 3. Работа с API

### 3.1. REST API
- Используйте семантическую версионизацию
- Документируйте все эндпоинты
- Используйте правильные HTTP методы
- Обрабатывайте ошибки с правильными кодами
- Используйте пагинацию для больших наборов данных

### 3.2. Аутентификация
- Используйте JWT для аутентификации
- Храните токены безопасно
- Реализуйте механизм обновления токенов
- Проверяйте права доступа
- Логируйте попытки доступа

### 3.3. Безопасность API
- Используйте HTTPS
- Валидируйте все входные данные
- Защищайте от CSRF атак
- Ограничивайте частоту запросов
- Мониторьте подозрительную активность

## 4. Работа с базой данных

### 4.1. Модели
- Используйте миграции для изменений схемы
- Индексируйте часто используемые поля
- Используйте внешние ключи
- Валидируйте данные на уровне БД
- Оптимизируйте запросы

### 4.2. Запросы
- Используйте ORM для простых запросов
- Оптимизируйте сложные запросы
- Используйте транзакции
- Обрабатывайте ошибки БД
- Логируйте медленные запросы

## 5. Логирование

### 5.1. Общие принципы
- Используйте структурированное логирование
- Логируйте все важные операции
- Включайте контекст в логи
- Используйте разные уровни логирования
- Ротируйте логи

### 5.2. Мониторинг
- Настройте алерты
- Отслеживайте метрики
- Мониторьте производительность
- Логируйте ошибки
- Анализируйте логи

## 6. Документация

### 6.1. Код
- Документируйте все публичные API
- Используйте docstrings
- Включайте примеры использования
- Документируйте исключения
- Поддерживайте документацию в актуальном состоянии

### 6.2. API
- Документируйте все эндпоинты
- Включайте примеры запросов и ответов
- Описывайте параметры
- Документируйте ошибки
- Используйте OpenAPI/Swagger

### 6.3. Развертывание
- Документируйте процесс развертывания
- Включайте требования к окружению
- Описывайте конфигурацию
- Документируйте переменные окружения
- Включайте инструкции по устранению неполадок

## Best practice: обработка reply-кнопок в Telegram-боте

- Для reply-кнопок всегда используйте точное сравнение текста:
  ```python
  @bot.message_handler(func=lambda m: m.text == "Сводка на 1 страницу")
  async def send_short_summary(message):
      ...
  ```
- Не используйте фильтры вида `"mom" in m.text.lower()` или `func=lambda m: True` для reply-кнопок — это приводит к ошибкам маршрутизации и невозможности обработки других кнопок.
- Для универсальных хендлеров используйте только явную фильтрацию по FSM-состоянию внутри функции, а не в фильтре.
- Все catch-all хендлеры должны быть либо удалены, либо максимально ограничены по области применения.

**Пример правильной регистрации:**
```python
@bot.message_handler(func=lambda m: m.text == "Сформировать MoM")
async def send_mom(message):
    ...
```

**Пример неправильной регистрации (НЕ ДЕЛАТЬ):**
```python
@bot.message_handler(func=lambda m: "mom" in m.text.lower())
async def send_mom(message):
    ...
``` 
#!/bin/bash

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï STANDBY –ë–û–¢–ê AISHA
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ: –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ standby –±–æ—Ç–∞ –¥–ª—è —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è polling –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞
# –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ: —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è true standby —Ä–µ–∂–∏–º–∞
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

set -euo pipefail

# –¶–≤–µ—Ç–∞
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
PROD_SERVER="192.168.0.10"
PROD_USER="aisha"

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
log_info() { echo -e "${GREEN}[INFO]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }
log_section() { echo -e "${CYAN}[===]${NC} $1"; }

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å—Ç–∞—Ç—É—Å–∞
check_current_status() {
    log_section "üìä –¢–ï–ö–£–©–ò–ô –°–¢–ê–¢–£–° –ë–û–¢–û–í"
    
    ssh ${PROD_USER}@${PROD_SERVER} '
        echo "üì¶ –í—Å–µ –±–æ—Ç-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã:"
        docker ps --filter "name=aisha-bot" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
        
        echo
        echo "üìä –°—Ç–∞—Ç—É—Å polling –±–æ—Ç–æ–≤:"
        if docker ps -q --filter "name=aisha-bot-polling-1" | grep -q .; then
            echo "‚úÖ –û—Å–Ω–æ–≤–Ω–æ–π –±–æ—Ç (polling-1): RUNNING"
        else
            echo "‚ùå –û—Å–Ω–æ–≤–Ω–æ–π –±–æ—Ç (polling-1): STOPPED"
        fi
        
        if docker ps -q --filter "name=aisha-bot-polling-2" | grep -q .; then
            echo "‚ö†Ô∏è Standby –±–æ—Ç (polling-2): RUNNING (–ö–û–ù–§–õ–ò–ö–¢!)"
        else
            echo "‚úÖ Standby –±–æ—Ç (polling-2): STOPPED (–Ω–æ—Ä–º–∞)"
        fi
    '
}

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ standby –±–æ—Ç–∞ (–≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ)
stop_standby_bot() {
    log_section "üõë –û–°–¢–ê–ù–û–í–ö–ê STANDBY –ë–û–¢–ê"
    
    ssh ${PROD_USER}@${PROD_SERVER} '
        echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ standby –±–æ—Ç–∞ –¥–ª—è —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞..."
        
        if docker ps -q --filter "name=aisha-bot-polling-2" | grep -q .; then
            echo "–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º aisha-bot-polling-2..."
            docker stop aisha-bot-polling-2
            echo "‚úÖ Standby –±–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        else
            echo "‚ÑπÔ∏è Standby –±–æ—Ç —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        fi
        
        echo
        echo "üìä –ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å:"
        docker ps --filter "name=aisha-bot" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
    '
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–æ—Ç–∞
check_main_bot_logs() {
    log_section "üìù –ü–†–û–í–ï–†–ö–ê –û–°–ù–û–í–ù–û–ì–û –ë–û–¢–ê"
    
    ssh ${PROD_USER}@${PROD_SERVER} '
        echo "üìù –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å—Ç—Ä–æ–∫ –ª–æ–≥–æ–≤ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–æ—Ç–∞:"
        docker logs aisha-bot-polling-1 --tail 10
        
        echo
        echo "üîç –ü–æ–∏—Å–∫ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ polling:"
        if docker logs aisha-bot-polling-1 2>&1 | grep -i "conflict\|409\|too many requests" | tail -5; then
            echo "‚ö†Ô∏è –ù–∞–π–¥–µ–Ω—ã –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã polling"
        else
            echo "‚úÖ –ö–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ polling –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ"
        fi
    '
}

# –†–µ–∞–ª–∏–∑–∞—Ü–∏—è true standby —Ä–µ–∂–∏–º–∞ (–ø–ª–∞–Ω–∏—Ä—É–µ–º–æ–µ)
plan_true_standby() {
    log_section "üìã –ü–õ–ê–ù –†–ï–ê–õ–ò–ó–ê–¶–ò–ò TRUE STANDBY"
    
    log_info "–î–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ standby —Ä–µ–∂–∏–º–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ:"
    echo "1. üíì Health Check —Å–∏—Å—Ç–µ–º–∞:"
    echo "   - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–æ—Ç–∞"
    echo "   - –ü—Ä–æ–≤–µ—Ä–∫–∞ API Telegram –Ω–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å"
    echo "   - Heartbeat –º–µ–∂–¥—É –∏–Ω—Å—Ç–∞–Ω—Å–∞–º–∏"
    echo ""
    echo "2. üîÑ Failover –º–µ—Ö–∞–Ω–∏–∑–º:"
    echo "   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ standby –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ"
    echo "   - Graceful shutdown –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º standby"
    echo "   - –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —á–µ—Ä–µ–∑ Redis"
    echo ""
    echo "3. üéõÔ∏è –¶–µ–Ω—Ç—Ä —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:"
    echo "   - API –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–µ–∂–¥—É –∏–Ω—Å—Ç–∞–Ω—Å–∞–º–∏"
    echo "   - –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞"
    echo "   - –ê–ª–µ—Ä—Ç—ã –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö"
    echo ""
    log_warn "–ü–æ–∫–∞ —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ (–æ–¥–∏–Ω –∞–∫—Ç–∏–≤–Ω—ã–π –±–æ—Ç)"
}

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
test_bot_functionality() {
    log_section "üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –§–£–ù–ö–¶–ò–û–ù–ê–õ–¨–ù–û–°–¢–ò"
    
    log_info "–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ —Ç–µ—Å—Ç—ã:"
    echo "1. üí¨ –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç—É"
    echo "2. üé§ –û—Ç–ø—Ä–∞–≤—å—Ç–µ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (—Ç–µ—Å—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏)"
    echo "3. üìù –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: ssh aisha@192.168.0.10 'docker logs aisha-bot-polling-1 --follow'"
    echo ""
    log_info "–û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:"
    echo "‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ polling"
    echo "‚úÖ –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç (–ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è —Å ffmpeg)"
    echo "‚úÖ –ë—ã—Å—Ç—Ä—ã–π –æ—Ç–∫–ª–∏–∫ –±–æ—Ç–∞"
}

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
monitor_after_fix() {
    log_section "üìä –ú–û–ù–ò–¢–û–†–ò–ù–ì –ü–û–°–õ–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø"
    
    ssh ${PROD_USER}@${PROD_SERVER} '
        echo "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –º–∏–Ω—É—Ç:"
        
        # –ü–æ–¥—Å—á–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        handled_count=$(docker logs aisha-bot-polling-1 --since 5m 2>&1 | grep -c "is handled" || echo 0)
        error_count=$(docker logs aisha-bot-polling-1 --since 5m 2>&1 | grep -c "ERROR" || echo 0)
        conflict_count=$(docker logs aisha-bot-polling-1 --since 5m 2>&1 | grep -i -c "conflict\|409" || echo 0)
        
        echo "   ‚Ä¢ –û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è: $handled_count"
        echo "   ‚Ä¢ –û—à–∏–±–∫–∏: $error_count"
        echo "   ‚Ä¢ –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã polling: $conflict_count"
        
        if [[ $conflict_count -eq 0 ]]; then
            echo "‚úÖ –û–¢–õ–ò–ß–ù–û: –ö–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ polling –Ω–µ—Ç"
        else
            echo "‚ùå –ü–†–û–ë–õ–ï–ú–ê: –ù–∞–π–¥–µ–Ω—ã –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã polling ($conflict_count)"
        fi
        
        if [[ $handled_count -gt 0 ]]; then
            echo "‚úÖ –•–û–†–û–®–û: –ë–æ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è"
        else
            echo "‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞ 5 –º–∏–Ω—É—Ç"
        fi
    '
}

# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
main() {
    local action="${1:-fix}"
    
    log_info "üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ standby –±–æ—Ç–∞ Aisha"
    log_info "üìç –°–µ—Ä–≤–µ—Ä: ${PROD_USER}@${PROD_SERVER}"
    log_info "üïí $(date)"
    echo
    
    case "$action" in
        "status"|"s")
            check_current_status
            ;;
        "stop")
            check_current_status
            echo
            stop_standby_bot
            echo
            check_main_bot_logs
            ;;
        "test"|"t")
            test_bot_functionality
            ;;
        "monitor"|"m")
            monitor_after_fix
            ;;
        "plan"|"p")
            plan_true_standby
            ;;
        "fix"|*)
            check_current_status
            echo
            stop_standby_bot
            echo
            check_main_bot_logs
            echo
            monitor_after_fix
            echo
            test_bot_functionality
            echo
            plan_true_standby
            ;;
    esac
    
    echo
    log_info "‚úÖ –û–ø–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
}

# –°–ø—Ä–∞–≤–∫–∞
if [[ "${1:-}" == "--help" || "${1:-}" == "-h" ]]; then
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 [–¥–µ–π—Å—Ç–≤–∏–µ]"
    echo
    echo "–î–µ–π—Å—Ç–≤–∏—è:"
    echo "  fix           - –ü–æ–ª–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)"
    echo "  status, s     - –¢–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞"
    echo "  stop          - –¢–æ–ª—å–∫–æ –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ standby –±–æ—Ç–∞"
    echo "  test, t       - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"
    echo "  monitor, m    - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è"
    echo "  plan, p       - –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ true standby"
    echo
    echo "–ü—Ä–∏–º–µ—Ä—ã:"
    echo "  $0            # –ü–æ–ª–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ"
    echo "  $0 status     # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞"
    echo "  $0 stop       # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ standby"
    exit 0
fi

# –ó–∞–ø—É—Å–∫
main "$@" 
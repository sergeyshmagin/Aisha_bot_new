#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ firewall –ø–æ—Å–ª–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: sudo ./enable_firewall_correct.sh

set -e

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1"
    exit 1
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ root
if [[ $EUID -ne 0 ]]; then
   error "–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è —Å –ø—Ä–∞–≤–∞–º–∏ root (sudo)"
fi

log "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ firewall —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏..."

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è ufw
if ! command -v ufw &> /dev/null; then
    log "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ ufw..."
    apt update
    apt install -y ufw
fi

# –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
log "–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ firewall:"
ufw status

echo
log "–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º firewall –¥–ª—è —Ä–∞–±–æ—Ç—ã API —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –ø–æ—Ä—Ç—É 8443"
echo

# –°–±—Ä–æ—Å –ø—Ä–∞–≤–∏–ª –¥–ª—è —á–∏—Å—Ç–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
warn "–°–±—Ä–æ—Å —Ç–µ–∫—É—â–∏—Ö –ø—Ä–∞–≤–∏–ª firewall..."
ufw --force reset

# –ë–∞–∑–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞
log "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–∞–∑–æ–≤—ã—Ö –ø—Ä–∞–≤–∏–ª..."
ufw default deny incoming
ufw default allow outgoing

# SSH (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ!)
log "–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ SSH (–ø–æ—Ä—Ç 22)..."
ufw allow 22/tcp
ufw limit 22/tcp  # –ó–∞—â–∏—Ç–∞ –æ—Ç –±—Ä—É—Ç—Ñ–æ—Ä—Å–∞

# HTTP/HTTPS (–¥–ª—è –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞)
log "–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ HTTP/HTTPS..."
ufw allow 80/tcp
ufw allow 443/tcp

# API —Å–µ—Ä–≤–µ—Ä - –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –¥–ª—è –≤—Å–µ—Ö (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
log "–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –∫ API —Å–µ—Ä–≤–µ—Ä—É (–ø–æ—Ä—Ç 8443) –¥–ª—è –≤—Å–µ—Ö..."
warn "–í–ù–ò–ú–ê–ù–ò–ï: –ü–æ—Ä—Ç 8443 –æ—Ç–∫—Ä—ã—Ç –¥–ª—è –≤—Å–µ—Ö IP! –≠—Ç–æ –≤—Ä–µ–º–µ–Ω–Ω–∞—è –º–µ—Ä–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è."
ufw allow 8443/tcp

# –õ–æ–∫–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø
log "–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞..."
ufw allow from 127.0.0.1 to any port 8000  # –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π API

# –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä—è–º–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º—É API (8000) –∏–∑–≤–Ω–µ
log "–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤–Ω–µ—à–Ω–µ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º—É API (–ø–æ—Ä—Ç 8000)..."
ufw deny 8000/tcp

# PostgreSQL - —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø
log "–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤–Ω–µ—à–Ω–µ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ PostgreSQL..."
ufw deny 5432/tcp

# Ping
log "–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ ping..."
ufw allow in on lo
ufw allow out on lo

# –ê–∫—Ç–∏–≤–∞—Ü–∏—è firewall
log "–ê–∫—Ç–∏–≤–∞—Ü–∏—è firewall..."
ufw --force enable

# –ü–æ–∫–∞–∑–∞—Ç—å –∏—Ç–æ–≥–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞
log "–ò—Ç–æ–≥–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞ firewall:"
ufw status numbered

log "üéâ Firewall –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!"
echo
log "–ù–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞:"
echo "‚úÖ SSH (–ø–æ—Ä—Ç 22) - —Ä–∞–∑—Ä–µ—à–µ–Ω —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –±—Ä—É—Ç—Ñ–æ—Ä—Å–∞"
echo "‚úÖ HTTP (–ø–æ—Ä—Ç 80) - —Ä–∞–∑—Ä–µ—à–µ–Ω"
echo "‚úÖ HTTPS (–ø–æ—Ä—Ç 443) - —Ä–∞–∑—Ä–µ—à–µ–Ω"
echo "‚ö†Ô∏è  API —Å–µ—Ä–≤–µ—Ä (–ø–æ—Ä—Ç 8443) - –í–†–ï–ú–ï–ù–ù–û –æ—Ç–∫—Ä—ã—Ç –¥–ª—è –≤—Å–µ—Ö"
echo "üö´ –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π API (–ø–æ—Ä—Ç 8000) - –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∏–∑–≤–Ω–µ"
echo "üö´ PostgreSQL (–ø–æ—Ä—Ç 5432) - –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∏–∑–≤–Ω–µ"
echo
log "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API:"
echo "curl https://aibots.kz:8443/health"
echo
warn "–í–ê–ñ–ù–û: –ü–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã –æ–≥—Ä–∞–Ω–∏—á—å—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –ø–æ—Ä—Ç—É 8443!"
log "–î–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:"
echo "sudo ufw delete allow 8443/tcp"
echo "sudo ufw allow from TRUSTED_IP to any port 8443" 
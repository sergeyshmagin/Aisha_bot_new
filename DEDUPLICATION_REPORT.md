# üìã –û—Ç—á–µ—Ç –æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ –ø—Ä–∞–≤–∏–ª–∞–º

## üîç **–í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã**

### **1. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ "–ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ–º–ø—Ç" ‚ùå**

**–ü—Ä–æ–±–ª–µ–º–∞:** –û–¥–∏–Ω–∞–∫–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –±—ã–ª–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ –¥–≤—É—Ö –º–µ—Å—Ç–∞—Ö:
- `app/handlers/generation/generation_monitor.py` (—Å—Ç—Ä–æ–∫–∞ 423) - 60+ —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞
- `app/handlers/gallery/management/prompt_viewer.py` (—Å—Ç—Ä–æ–∫–∞ 18) - 175 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞

**–ù–∞—Ä—É—à–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª:**
- ‚ùå **DRY –ø—Ä–∏–Ω—Ü–∏–ø**: –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ ~100 —Å—Ç—Ä–æ–∫ –ª–æ–≥–∏–∫–∏
- ‚ùå **–†–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã**: HTML vs Markdown –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
- ‚ùå **–†–∞–∑–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**: –Ω–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
- ‚ùå **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ DB –∑–∞–ø—Ä–æ—Å—ã**: `_get_generation_by_id` –≤ –æ–±–µ–∏—Ö —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è—Ö

### **2. –ù–∞—Ä—É—à–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤—ã—Ö –ª–∏–º–∏—Ç–æ–≤ ‚ö†Ô∏è**

- `generation_monitor.py`: 484 —Å—Ç—Ä–æ–∫–∏ (–ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç 500)
- `prompt_viewer.py`: 175 —Å—Ç—Ä–æ–∫ (–≤ –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö –ø—Ä–µ–¥–µ–ª–∞—Ö)

### **3. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –µ–¥–∏–Ω–æ–π —Ç–æ—á–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è**

- –ù–µ—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π —É—Ç–∏–ª–∏—Ç—ã –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø—Ä–æ–º–ø—Ç–æ–≤
- –†–∞–∑–Ω—ã–µ callback handlers –¥–ª—è –æ–¥–Ω–æ–π –∏ —Ç–æ–π –∂–µ —Ñ—É–Ω–∫—Ü–∏–∏

## ‚úÖ **–ü—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è**

### **1. –°–æ–∑–¥–∞–Ω –µ–¥–∏–Ω—ã–π —Å–µ—Ä–≤–∏—Å `PromptDisplayService`**

**–§–∞–π–ª:** `app/utils/prompt_display.py`

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ **–ï–¥–∏–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è** –¥–ª—è –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π
- ‚úÖ **–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ** –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ **–£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**
- ‚úÖ **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è** —Å Optional –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
- ‚úÖ **–ì–∏–±–∫–∏–π return_callback** –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤

**–û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã:**
```python
async def show_full_prompt(callback: CallbackQuery, return_callback: Optional[str] = None)
async def _send_formatted_prompt(callback, text, keyboard)
async def _get_generation_by_id(generation_id: UUID)
```

### **2. –û–±–Ω–æ–≤–ª–µ–Ω—ã –≤—Å–µ —Ç–æ—á–∫–∏ –≤—Ö–æ–¥–∞**

**–ì–∞–ª–µ—Ä–µ—è:** `app/handlers/gallery/main_handler.py`
```python
# –ë–´–õ–û: gallery_viewer.show_full_prompt(callback)
# –°–¢–ê–õ–û:
from app.utils.prompt_display import prompt_display_service
await prompt_display_service.show_full_prompt(callback, return_callback="my_gallery")
```

**–ì–µ–Ω–µ—Ä–∞—Ü–∏—è:** `app/handlers/generation/main_handler.py`
```python
# –ë–´–õ–û: generation_monitor.show_full_prompt(callback)  
# –°–¢–ê–õ–û:
from app.utils.prompt_display import prompt_display_service
await prompt_display_service.show_full_prompt(callback, return_callback="my_gallery")
```

### **3. –ü–æ–º–µ—á–µ–Ω—ã LEGACY —Ñ–∞–π–ª—ã**

- `prompt_viewer.py` ‚Üí `prompt_viewer_LEGACY.py` (–¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è)
- `generation_monitor.show_full_prompt()` ‚Üí –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ LEGACY —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º

### **4. –î–æ–±–∞–≤–ª–µ–Ω—ã unit-—Ç–µ—Å—Ç—ã**

**–§–∞–π–ª:** `tests/test_prompt_display.py`

**–ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏:**
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ —Å–µ—Ä–≤–∏—Å–∞
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞–Ω–Ω—ã—Ö callback
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–µ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø—Ä–∞–≤–∏–ª–∞–º –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞

## üìä **–†–µ–∑—É–ª—å—Ç–∞—Ç—ã**

### **–£—Å—Ç—Ä–∞–Ω–µ–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è:**
- **-175 —Å—Ç—Ä–æ–∫** –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–¥–∞ –≤ `prompt_viewer.py`
- **-60 —Å—Ç—Ä–æ–∫** –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–¥–∞ –≤ `generation_monitor.py`
- **–ò—Ç–æ–≥–æ:** —É—Å—Ç—Ä–∞–Ω–µ–Ω–æ ~235 —Å—Ç—Ä–æ–∫ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–¥–∞

### **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –µ–¥–∏–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞:**
- ‚úÖ **DRY –ø—Ä–∏–Ω—Ü–∏–ø**: –æ–¥–∏–Ω –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã
- ‚úÖ **–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å**: –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –≤–µ–∑–¥–µ
- ‚úÖ **Maintainability**: –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
- ‚úÖ **Testing**: —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ **Type safety**: —Å—Ç—Ä–æ–≥–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è

### **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø—Ä–∞–≤–∏–ª–∞–º –ø—Ä–æ–µ–∫—Ç–∞:**

#### ‚úÖ **Golden Rules:**
- **–û–¥–∏–Ω —Ñ–∞–π–ª ‚â§ 500 —Å—Ç—Ä–æ–∫**: —Å–æ–±–ª—é–¥–µ–Ω–æ
- **DRY –ø—Ä–∏–Ω—Ü–∏–ø**: –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å—Ç—Ä–∞–Ω–µ–Ω–æ
- **–¢–∏–ø–∏–∑–∞—Ü–∏—è**: –≤—Å–µ –º–µ—Ç–æ–¥—ã —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
- **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ø–æ–∫—Ä—ã—Ç–æ unit-—Ç–µ—Å—Ç–∞–º–∏

#### ‚úÖ **Code Quality:**
- **PEP8**: —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±–ª—é–¥–µ–Ω–æ
- **Async/await**: —Ç–æ–ª—å–∫–æ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã
- **Error handling**: try-except –±–ª–æ–∫–∏ —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- **No magic numbers**: –≤—Å–µ —á–∏—Å–ª–∞ –æ–±–æ—Å–Ω–æ–≤–∞–Ω—ã

#### ‚úÖ **Best Practices:**
- **–ú–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞**: —Å–µ—Ä–≤–∏—Å –≤—ã–¥–µ–ª–µ–Ω –≤ utils
- **–ò–Ω–∫–∞–ø—Å—É–ª—è—Ü–∏—è**: –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ –º–µ—Ç–æ–¥—ã —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º `_`
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å –ø—Ä–µ—Ñ–∏–∫—Å–∞–º–∏
- **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**: —Å—Ç–∞—Ä—ã–µ –º–µ—Ç–æ–¥—ã –¥–µ–ª–µ–≥–∏—Ä—É—é—Ç –∫ –Ω–æ–≤–æ–º—É

## üöÄ **–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏**

1. **–£–¥–∞–ª–∏—Ç—å LEGACY —Ñ–∞–π–ª—ã** –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏:
   - `app/handlers/gallery/management/prompt_viewer_LEGACY.py`
   
2. **–û—á–∏—Å—Ç–∏—Ç—å LEGACY –º–µ—Ç–æ–¥—ã** –≤ production:
   - `GenerationMonitor.show_full_prompt()` - –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –ø—Ä—è–º–æ–π –≤—ã–∑–æ–≤ —Å–µ—Ä–≤–∏—Å–∞

3. **–†–∞—Å—à–∏—Ä–∏—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**:
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ callback
   - –¢–µ—Å—Ç—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

## üéØ **–ò—Ç–æ–≥–∏**

‚úÖ **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é —É—Å—Ç—Ä–∞–Ω–µ–Ω–æ**
‚úÖ **–ü—Ä–æ–µ–∫—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –≤—Å–µ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º –ø—Ä–∞–≤–∏–ª–∞–º** 
‚úÖ **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å "–ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ–º–ø—Ç" —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–∞**
‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**
‚úÖ **–ì–æ—Ç–æ–≤–æ –∫ production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é**

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü—Ä–æ–µ–∫—Ç –ø—Ä–∏–≤–µ–¥–µ–Ω –≤ –ø–æ–ª–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø—Ä–∞–≤–∏–ª–∞–º DRY, –º–æ–¥—É–ª—å–Ω–æ—Å—Ç–∏ –∏ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞. 
# План покрытия тестами для бизнес-ассистента и транскриптов

## 1. Меню и переходы (handlers)
- [x] Переходы между главными меню, бизнес-ассистентом, историей, новым диалогом, возвратами.
- [ ] Проверка установки и очистки состояний в PostgreSQL (state_utils).
- [ ] Проверка корректной работы FSM при ошибках и edge-case (например, неожиданный ввод).

## 2. Транскрипты (services)
- [x] Загрузка транскрипта в MinIO (upload_file).
- [x] Кэширование MinIO-ключа в user_transcript_cache.
- [x] Получение транскрипта через download_file по ключу из кэша.
- [ ] Проверка ошибок при отсутствии транскрипта, повреждённом файле, ошибках MinIO.
- [ ] Проверка очистки кэша и удаления транскриптов.

## 3. История (history_service)
- [x] Добавление записи в историю (add_entry).
- [x] Получение истории пользователя.
- [ ] Проверка ошибок при работе с историей (например, MinIO недоступен).

## 4. Асинхронность и файловые операции
- [x] Все операции с файлами — только через aiofiles.
- [x] Внешние процессы — только через asyncio.create_subprocess_exec.
- [ ] Нет sync-операций с файлами в async-коде (проверка через тесты и ревью).

## 5. User ID и идентификаторы
- [x] Все сервисы и хендлеры используют UUID пользователя.
- [ ] Проверка, что Telegram ID используется только для поиска пользователя.

## 6. Логирование и обработка ошибок
- [ ] Все ошибки логируются через logger.exception.
- [ ] Пользователь получает информативные сообщения при ошибках.

## 7. Покрытие тестами ≥ 80%
- [ ] Проверить покрытие (pytest-cov).
- [ ] Добавить недостающие edge-case тесты.

## 8. Документация и best practices
- [x] Все архитектурные решения и best practices зафиксированы в docs/.
- [ ] Примеры кода и тестов актуальны и соответствуют новой архитектуре.

---

## Что оставить:
- Все тесты, которые:
  - Проверяют работу с MinIO, кэшем, асинхронностью, UUID.
  - Проверяют переходы между меню и работу FSM.
  - Проверяют историю и бизнес-логику ассистента.

## Что удалить/переписать:
- Тесты, которые:
  - Оперируют локальными файлами для транскриптов.
  - Используют Telegram ID как user_id.
  - Используют sync-файловые операции.
  - Неактуальны для новой архитектуры (например, старые тесты Redis/SQLite).

---

## Следующий шаг

1. Оставить только нужные тесты (см. выше).
2. Переписать/дополнить тесты для новых edge-case и асинхронности.
3. Запустить тесты и добиться зелёного CI. 
# üîß –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–æ–º–ø—Ç–æ–≤ —á–µ—Ä–µ–∑ GPT

## ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏–º–µ–Ω–µ–Ω—ã

–¢–∞–±–ª–∏—Ü—ã –¥–ª—è —Å–∏—Å—Ç–µ–º—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å–æ–∑–¥–∞–Ω—ã —É—Å–ø–µ—à–Ω–æ:
- ‚úÖ `image_generations` - –æ—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–π
- ‚úÖ `style_categories` - –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å—Ç–∏–ª–µ–π  
- ‚úÖ `style_subcategories` - –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å—Ç–∏–ª–µ–π
- ‚úÖ `style_templates` - —à–∞–±–ª–æ–Ω—ã —Å—Ç–∏–ª–µ–π
- ‚úÖ `user_favorite_templates` - –∏–∑–±—Ä–∞–Ω–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã
- ‚úÖ –ü–æ–ª–µ `prompt_metadata` –¥–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –æ–±—Ä–∞–±–æ—Ç–∫–∏

## üéØ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

–ò–∑ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∏–¥–Ω–æ, —á—Ç–æ —Å–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞:

### ‚úÖ –£—Å–ø–µ—à–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:
```
üì± –¢–µ–ª–µ–≥—Ä–∞–º –±–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
üîÑ –ú–µ–Ω—é –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è  
üí∞ –ë–∞–ª–∞–Ω—Å —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
ü§ñ –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–º–ø—Ç–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç (—Å fallback)
üìù –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π
```

### ü§ñ –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–º–ø—Ç–æ–≤:
```
‚úÖ PromptProcessingService –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
‚úÖ Graceful fallback –±–µ–∑ OpenAI API –∫–ª—é—á–∞
‚úÖ –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã
‚úÖ –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
```

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

### 1. OpenAI API –∫–ª—é—á
```env
# –í —Ñ–∞–π–ª–µ .env –¥–æ–±–∞–≤–∏—Ç—å:
OPENAI_API_KEY=your_real_openai_api_key_here
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã
```bash
# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
python -m app.main

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ—Å—Ç–æ–≤
python -m pytest tests/test_prompt_processing.py -v
```

## üéØ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Å—Ü–µ–Ω–∞—Ä–∏–π

### –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º (—Ç–µ–∫—É—â–∏–π):
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–¥–µ–ª–æ–≤–æ–π –ø–æ—Ä—Ç—Ä–µ—Ç –≤ –∫–æ—Å—Ç—é–º–µ"
–°–∏—Å—Ç–µ–º–∞: ü§ñ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –≤–∞—à –ø—Ä–æ–º–ø—Ç...
         ‚ö° –ë–µ–∑ OpenAI API - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ—Ä–∏–≥–∏–Ω–∞–ª
         üé® –°–æ–∑–¥–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...
         üìù –û—Ä–∏–≥–∏–Ω–∞–ª: –¥–µ–ª–æ–≤–æ–π –ø–æ—Ä—Ç—Ä–µ—Ç –≤ –∫–æ—Å—Ç—é–º–µ  
         üîÑ –§–∏–Ω–∞–ª—å–Ω—ã–π: man, TOK, –¥–µ–ª–æ–≤–æ–π –ø–æ—Ä—Ç—Ä–µ—Ç –≤ –∫–æ—Å—Ç—é–º–µ
```

### –ü—Ä–æ–¥–∞–∫—à–µ–Ω —Ä–µ–∂–∏–º (—Å OpenAI API):
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–¥–µ–ª–æ–≤–æ–π –ø–æ—Ä—Ç—Ä–µ—Ç –≤ –∫–æ—Å—Ç—é–º–µ"
–°–∏—Å—Ç–µ–º–∞: ü§ñ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –≤–∞—à –ø—Ä–æ–º–ø—Ç...
         ‚ö° –ü–µ—Ä–µ–≤–æ–¥–∏–º –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π
         ‚ö° –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ–º –¥–ª—è Flux PRO
         üé® –°–æ–∑–¥–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...
         üìù –û—Ä–∏–≥–∏–Ω–∞–ª: –¥–µ–ª–æ–≤–æ–π –ø–æ—Ä—Ç—Ä–µ—Ç –≤ –∫–æ—Å—Ç—é–º–µ
         üîÑ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: professional portrait in business attire, studio lighting, sharp focus, detailed face, high resolution
         üì∑ –§–∏–Ω–∞–ª—å–Ω—ã–π: man, TOK, professional portrait in business attire, studio lighting, sharp focus, detailed face, high resolution
```

## üîÑ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π (–≤—ã–ø–æ–ª–Ω–µ–Ω–æ)

–ö–æ–º–∞–Ω–¥—ã –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã:
```bash
# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –º–∏–≥—Ä–∞—Ü–∏–π
python -m alembic upgrade head

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
python -m alembic current
python -m alembic history
```

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–π

```
‚úÖ –í–µ—Ä—Å–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: add_prompt_metadata_field (HEAD)
‚úÖ –í—Å–µ —Ç–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã —É—Å–ø–µ—à–Ω–æ
‚úÖ –ü–æ–ª–µ prompt_metadata –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ image_generations
‚úÖ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç:
```bash
$ python -m pytest tests/test_prompt_processing.py -v

‚úÖ test_process_prompt_without_api_key PASSED
‚úÖ test_detect_translation_needed PASSED  
‚úÖ test_get_system_prompt_portrait PASSED
‚úÖ test_get_system_prompt_style PASSED
‚úÖ test_is_available_with_key PASSED
‚úÖ test_is_available_without_key PASSED
‚úÖ test_process_prompt_with_mocked_api PASSED

7 passed, 68 warnings in 3.67s
```

### –°–∏—Å—Ç–µ–º–∞ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫:
```bash
$ python -c "from app.handlers.generation.main_handler import router; print('‚úÖ –ò–º–ø–æ—Ä—Ç —É—Å–ø–µ—à–µ–Ω')"
‚úÖ –ò–º–ø–æ—Ä—Ç —É—Å–ø–µ—à–µ–Ω

$ python -c "from app.services.generation.prompt_processing_service import PromptProcessingService; print('‚úÖ –°–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç–∞–µ—Ç')"
‚úÖ –°–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç–∞–µ—Ç
```

## üöÄ –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!

### –í —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ (—Å–µ–π—á–∞—Å):
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å fallback –±–µ–∑ OpenAI API
- ‚úÖ –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã
- ‚úÖ –ü—Ä–æ–º–ø—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å
- ‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### –î–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–æ–ª–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏:
1. –î–æ–±–∞–≤–∏—Ç—å –Ω–∞—Å—Ç–æ—è—â–∏–π OpenAI API –∫–ª—é—á –≤ `.env`
2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
3. –ù–∞—Å–ª–∞–∂–¥–∞—Ç—å—Å—è —É–º–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –ø—Ä–æ–º–ø—Ç–æ–≤!

## üéâ –°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–∞!

–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–º–ø—Ç–æ–≤ —á–µ—Ä–µ–∑ GPT –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç:
- üîß –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞
- ü§ñ –°–µ—Ä–≤–∏—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–æ–º–ø—Ç–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç  
- üì± –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π
- üß™ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
- üöÄ –ì–æ—Ç–æ–≤–æ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º OpenAI API –∫–ª—é—á–∞ 
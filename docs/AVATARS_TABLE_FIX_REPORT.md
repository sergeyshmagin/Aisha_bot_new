# üîß –û—Ç—á–µ—Ç: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ "relation avatars does not exist"

**–î–∞—Ç–∞:** 2025-05-23  
**–í–µ—Ç–∫–∞:** `restructure/move-v2-to-root`  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

## üö® –ü—Ä–æ–±–ª–µ–º–∞

### ‚ùå –û—à–∏–±–∫–∞:
```
sqlalchemy.exc.ProgrammingError: (asyncpg.exceptions.UndefinedTableError) 
relation "avatars" does not exist
```

### üîç –ü—Ä–∏—á–∏–Ω–∞:
–ü–æ—Å–ª–µ —Ä–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞ –º–∏–≥—Ä–∞—Ü–∏–∏ Alembic –Ω–µ –±—ã–ª–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –∏ —Ç–∞–±–ª–∏—Ü–∞ `avatars` –Ω–µ –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.

## üõ†Ô∏è –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### 1. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î:
```bash
$ python -c "from app.core.config import settings; print('DATABASE_URL:', settings.DATABASE_URL[:50] + '...')"
DATABASE_URL: postgresql+asyncpg://aisha_user:KbZZGJHX09KSH7r9ev...
```

### 2. ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏:
```bash
$ python -m alembic current
# –ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç - –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã

$ python -m alembic history
# –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏, –Ω–æ –æ–Ω–∏ –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã
```

### 3. üîç –ê–Ω–∞–ª–∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ë–î:
```sql
-- –¢–∞–±–ª–∏—Ü—ã –≤ –ë–î:
alembic_version, transactions, user_avatars, user_balances, 
user_history, user_profiles, user_states, users, 
user_transcript_cache, user_avatar_photos

-- –ù–ï–¢ —Ç–∞–±–ª–∏—Ü—ã "avatars"!
```

### 4. ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ —Å –≤–µ—Ä—Å–∏–µ–π –º–∏–≥—Ä–∞—Ü–∏–∏:
```bash
$ python -c "SELECT version_num FROM alembic_version"
52081111f590  # –í–µ—Ä—Å–∏—è –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —Ñ–∞–π–ª–∞—Ö –º–∏–≥—Ä–∞—Ü–∏–π!
```

## üõ†Ô∏è –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ psycopg2-binary
```bash
pip install psycopg2-binary
```
**–ü—Ä–∏—á–∏–Ω–∞:** Alembic —Ç—Ä–µ–±—É–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –¥—Ä–∞–π–≤–µ—Ä PostgreSQL –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π.

### 2. ‚úÖ –û—á–∏—Å—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è Alembic
```sql
DELETE FROM alembic_version;
```
**–ü—Ä–∏—á–∏–Ω–∞:** –£–¥–∞–ª–µ–Ω–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –≤–µ—Ä—Å–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä–æ–π –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.

### 3. ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã avatars –≤—Ä—É—á–Ω—É—é
```sql
CREATE TABLE IF NOT EXISTS avatars (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id INTEGER NOT NULL,
    name VARCHAR(64),
    gender VARCHAR(16),
    status VARCHAR(16) NOT NULL,
    is_draft BOOLEAN NOT NULL,
    avatar_data JSON,
    created_at TIMESTAMP DEFAULT now(),
    updated_at TIMESTAMP DEFAULT now()
);
```

### 4. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ requirements.txt
```txt
psycopg2-binary>=2.9.0  # –î–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å PostgreSQL
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü—ã:
```bash
$ python -c "SELECT table_name FROM information_schema.tables WHERE table_name='avatars'"
‚úÖ –¢–∞–±–ª–∏—Ü–∞ avatars –Ω–∞–π–¥–µ–Ω–∞
```

### ‚úÖ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞:
```bash
$ python -m app.main
2025-05-23 19:11:19,592 - __main__ - INFO - –°—Ç–∞—Ä—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
2025-05-23 19:11:19,595 - __main__ - INFO - –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞...
2025-05-23 19:11:19,964 - app.handlers.avatar - INFO - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∞–≤–∞—Ç–∞—Ä–æ–≤
2025-05-23 19:11:20,321 - aiogram.dispatcher - INFO - Run polling for bot @KAZAI_Aisha_bot
```

**‚úÖ –ë–æ–ª—å—à–µ –Ω–µ—Ç –æ—à–∏–±–∫–∏ "relation avatars does not exist"!**

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç

### ‚ùå –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã —Å –∞–≤–∞—Ç–∞—Ä–∞–º–∏
- –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π

### ‚úÖ –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- –ß–∏—Å—Ç—ã–π –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞ –±–µ–∑ –æ—à–∏–±–æ–∫
- –¢–∞–±–ª–∏—Ü–∞ `avatars` —Å–æ–∑–¥–∞–Ω–∞ –∏ –¥–æ—Å—Ç—É–ø–Ω–∞
- –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∞–≤–∞—Ç–∞—Ä–æ–≤ —Ä–∞–±–æ—Ç–∞—é—Ç

## üîß –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–ú–∏–≥—Ä–∞—Ü–∏–∏:** –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –ø–æ—Å–ª–µ —Ä–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏–∑–∞—Ü–∏–∏
2. **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –í–∫–ª—é—á–∞–π—Ç–µ `psycopg2-binary` –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Alembic
3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** –†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ë–î –∫–æ–º–∞–Ω–¥–æ–π `alembic current`

---

**üéâ –û—à–∏–±–∫–∞ —Å —Ç–∞–±–ª–∏—Ü–µ–π avatars —É—Å–ø–µ—à–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞!** 
# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –∞–≤–∞—Ç–∞—Ä–æ–≤

**–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è**: 04.06.2025  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–ï–®–ï–ù–´

## üéØ –û—Å–Ω–æ–≤–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. üé® –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

**–ü—Ä–æ–±–ª–µ–º–∞**: –ö–Ω–æ–ø–∫–∞ "üé® –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å" –≤—ã–∑—ã–≤–∞–ª–∞ –æ—à–∏–±–∫—É "‚ùå –ê–≤–∞—Ç–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω"

**–ü—Ä–∏—á–∏–Ω—ã**:
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö: `str(avatar.user_id) != user.id`
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞ –≤–Ω–µ context manager'–∞

**–†–µ—à–µ–Ω–∏–µ** –≤ `app/handlers/avatar/gallery/main_handler.py`:
```python
# –ë–´–õ–û:
if avatar.user_id != user.id:  # int != str
async with self.generation_service.generate_avatar_image(...)  # ‚ùå

# –°–¢–ê–õ–û:  
if str(avatar.user_id) != str(user.id):  # str == str
generation_service = FALGenerationService()  # ‚úÖ
image_url = await generation_service.generate_avatar_image(...)
```

### 2. üîå –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ FAL AI –∫–ª–∏–µ–Ω—Ç–∞

**–ü—Ä–æ–±–ª–µ–º–∞**: `'FalAIClient' object has no attribute '_download_and_create_archive'`

**–ü—Ä–∏—á–∏–Ω–∞**: –í—ã–∑–æ–≤ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –º–µ—Ç–æ–¥–∞

**–†–µ—à–µ–Ω–∏–µ** –≤ `app/handlers/avatar/training_production.py`:
```python
# –ë–´–õ–û:
data_url = await self.fal_client._download_and_create_archive(...)  # ‚ùå

# –°–¢–ê–õ–û:
data_url = await self.fal_client.download_and_create_archive(...)  # ‚úÖ
```

### 3. ü™£ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ MinIO bucket'–∞

**–ü—Ä–æ–±–ª–µ–º–∞**: –í—Å–µ 20 —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –Ω–µ —Å–∫–∞—á–∏–≤–∞–ª–∏—Å—å (0/20 —É—Å–ø–µ—à–Ω–æ)

**–ü—Ä–∏—á–∏–Ω–∞**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—É—Å—Ç–æ–≥–æ bucket `aisha` –≤–º–µ—Å—Ç–æ `avatars` —Å 814 –æ–±—ä–µ–∫—Ç–∞–º–∏

**–†–µ—à–µ–Ω–∏–µ** –≤ `app/services/fal/files/file_manager.py`:
```python
# –ë–´–õ–û:
bucket = settings.MINIO_BUCKET_NAME  # 'aisha' (–ø—É—Å—Ç–æ–π)

# –°–¢–ê–õ–û:
bucket = settings.MINIO_BUCKET_AVATARS  # 'avatars' (814 –æ–±—ä–µ–∫—Ç–æ–≤)
```

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤**: `avatars/[user_id]/[avatar_id]/[photo_uuid].jpg`

### 4. üì§ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—Ä—Ö–∏–≤–∞ –≤ FAL AI

**–ü—Ä–æ–±–ª–µ–º–∞**: `TypeError: expected str, bytes or os.PathLike object, not BufferedReader`

**–ü—Ä–∏—á–∏–Ω—ã**:
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–∏–ø –∞—Ä–≥—É–º–µ–Ω—Ç–∞ –¥–ª—è `fal_client.upload_file()`
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ FAL API –∫–ª—é—á–∞

**–†–µ—à–µ–Ω–∏–µ** –≤ `app/services/fal/files/file_manager.py`:
```python
# –ë–´–õ–û:
with open(archive_path, 'rb') as f:
    file_url = fal_client.upload_file(f)  # BufferedReader ‚ùå

# –°–¢–ê–õ–û:
# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º FAL API –∫–ª—é—á
os.environ['FAL_KEY'] = settings.effective_fal_api_key
file_url = fal_client.upload_file(str(archive_path))  # Path as string ‚úÖ
```

### 5. üîÑ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ UX –¥–ª—è draft –∞–≤–∞—Ç–∞—Ä–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞**: –ö–Ω–æ–ø–∫–∞ "‚≠ê –û—Å–Ω–æ–≤–Ω–æ–π" –ø–æ–∫–∞–∑—ã–≤–∞–ª–∞—Å—å –¥–ª—è draft –∞–≤–∞—Ç–∞—Ä–æ–≤

**–†–µ—à–µ–Ω–∏–µ**: –°–∫—Ä—ã—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ "üîÑ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å" –¥–ª—è draft'–æ–≤
```python
if avatar.status == "draft":
    keyboard.add(InlineKeyboardButton("üîÑ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å", callback_data=f"continue_avatar_{avatar.id}"))
else:  # completed avatars
    if not avatar.is_main:
        keyboard.add(InlineKeyboardButton("‚≠ê –û—Å–Ω–æ–≤–Ω–æ–π", callback_data=f"set_main_{avatar.id}"))
```

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### ‚úÖ –ü–æ–ª–Ω—ã–π —Ä–∞–±–æ—á–∏–π pipeline –æ–±—É—á–µ–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–æ–≤:
1. **–°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π** - 20 —Ñ–æ—Ç–æ –∏–∑ MinIO `avatars` bucket ‚úÖ
2. **–°–æ–∑–¥–∞–Ω–∏–µ ZIP –∞—Ä—Ö–∏–≤–∞** - ~2.8MB —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ ‚úÖ  
3. **–ó–∞–≥—Ä—É–∑–∫–∞ –≤ FAL AI** - —É—Å–ø–µ—à–Ω–∞—è —Å URL `https://v3.fal.media/files/...` ‚úÖ
4. **–ó–∞–ø—É—Å–∫ –æ–±—É—á–µ–Ω–∏—è** - FAL AI –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ ‚úÖ

### ‚úÖ –ì–æ—Ç–æ–≤—ã–µ –∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∞–≤–∞—Ç–∞—Ä—ã:
- **SERGEY-PORTRAIT-1000** (PORTRAIT): LoRA —Ñ–∞–π–ª + trigger_phrase = `TOK` ‚úÖ
- –¢–∏–ø: `AvatarTrainingType.PORTRAIT`
- API: `fal-ai/flux-lora` 
- –°—Ç–∞—Ç—É—Å: –ì–æ—Ç–æ–≤ –∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

### ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ —Ç–µ–ª–µ–≥—Ä–∞–º –±–æ—Ç–∞:
- TelegramBadRequest –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∞–≤–∞—Ç–∞—Ä–æ–≤ ‚úÖ
- UX –ø—Ä–æ–±–ª–µ–º—ã —Å draft –∞–≤–∞—Ç–∞—Ä–∞–º–∏ ‚úÖ
- –ù–µ–¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –≤ –≥–∞–ª–µ—Ä–µ–µ ‚úÖ

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–û–∫—Ä—É–∂–µ–Ω–∏–µ**: `/opt/aisha-backend` –Ω–∞ Linux WSL2 Ubuntu 24.04  
**–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**: PostgreSQL —Å 9/9 –ø—Ä–æ—à–µ–¥—à–∏–º–∏ —Ç–µ—Å—Ç–∞–º–∏ —Å—Ö–µ–º—ã  
**MinIO**: 192.168.0.4:9000 —Å 46 bucket'–∞–º–∏, 814 —Ñ–∞–π–ª–æ–≤ –≤ `avatars`  
**FAL AI**: –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ `settings.effective_fal_api_key` ‚úÖ

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã**:
- –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ö–∏–≤–∞: `https://v3.fal.media/files/koala/...tmp.zip` ‚úÖ
- –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π: 20/20 —É—Å–ø–µ—à–Ω–æ (~140KB –∫–∞–∂–¥–∞—è) ‚úÖ  
- –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞: ~2.8MB ZIP —Ñ–∞–π–ª—ã ‚úÖ
- Pipeline –æ–±—É—á–µ–Ω–∏—è: –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–µ–Ω ‚úÖ

## üîÆ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

```mermaid
graph TD
    A[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–æ—Ç–æ] --> B[MinIO avatars bucket]
    B --> C[FAL File Manager]
    C --> D[–°–æ–∑–¥–∞–Ω–∏–µ ZIP –∞—Ä—Ö–∏–≤–∞]
    D --> E[–ó–∞–≥—Ä—É–∑–∫–∞ –≤ FAL AI]
    E --> F[–û–±—É—á–µ–Ω–∏–µ –ø–æ—Ä—Ç—Ä–µ—Ç–Ω–æ–π LoRA]
    F --> G[Webhook —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏]
    G --> H[–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ diffusers_lora_file_url]
    H --> I[–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏]
    I --> J[fal-ai/flux-lora API]
```

## üìù –§–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å

**–°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–∞ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É:**
- ‚úÖ –û–±—É—á–µ–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –æ—à–∏–±–æ–∫
- ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞  
- ‚úÖ MinIO –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ FAL AI pipeline –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—á–∏–π
- ‚úÖ UX —É–ª—É—á—à–µ–Ω –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –∞–≤–∞—Ç–∞—Ä–æ–≤
- ‚úÖ –¢–µ–ª–µ–≥—Ä–∞–º –±–æ—Ç —Å—Ç–∞–±–∏–ª–µ–Ω

**–ì–æ—Ç–æ–≤ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏!** üöÄ 
# üñºÔ∏è –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –≥–∞–ª–µ—Ä–µ–∏

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

### 1. –£–±—Ä–∞–Ω—ã –∑–∞–≥–ª—É—à–∫–∏ –∏–∑ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
- **–§–∞–π–ª**: `app/handlers/main_menu.py`
- **–ò–∑–º–µ–Ω–µ–Ω–∏—è**: –ó–∞–º–µ–Ω–µ–Ω—ã –∑–∞–≥–ª—É—à–∫–∏ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
- **–§—É–Ω–∫—Ü–∏–∏**:
  - `gallery_avatars` ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –∞–≤–∞—Ç–∞—Ä–∞–º–∏
  - `gallery_imagen` ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è Imagen4
  - `gallery_video` ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤–∏–¥–µ–æ (–∑–∞–≥–ª—É—à–∫–∞)
  - `gallery_by_date` ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –¥–∞—Ç–µ

### 2. –ü–æ–¥–∫–ª—é—á–µ–Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∞–Ω–Ω–∞—è –≥–∞–ª–µ—Ä–µ—è —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
- **–§–∞–π–ª—ã**: 
  - `app/handlers/gallery/filter_handler.py`
  - `app/handlers/gallery/viewer/main.py`
  - `app/handlers/gallery/viewer/navigation.py`
- **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å**:
  - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ç–∏–ø—É –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (–∞–≤–∞—Ç–∞—Ä—ã/Imagen4/–≤–∏–¥–µ–æ)
  - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –¥–∞—Ç–µ (—Å–µ–≥–æ–¥–Ω—è, –≤—á–µ—Ä–∞, –Ω–µ–¥–µ–ª—è, –º–µ—Å—è—Ü, —Å–≤–æ–π –ø–µ—Ä–∏–æ–¥)
  - –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ Redis
  - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤

### 3. –£–ª—É—á—à–µ–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ Imagen4
- **–§–∞–π–ª**: `app/handlers/imagen4/imagen4_handler.py`
- **–£–ª—É—á—à–µ–Ω–∏—è**:
  - ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ MinIO (–≤–º–µ—Å—Ç–æ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö URL FAL)
  - ‚úÖ –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ Redis
  - ‚úÖ –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫–µ—à–∞ –≥–∞–ª–µ—Ä–µ–∏ –ø—Ä–∏ –Ω–æ–≤—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏—è—Ö
  - ‚úÖ Fallback –Ω–∞ FAL URL –µ—Å–ª–∏ MinIO –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω

### 4. –î–æ–±–∞–≤–ª–µ–Ω–æ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Redis
- **–ö–µ—à–∏**:
  - `imagen4:generation:{id}` - –¥–∞–Ω–Ω—ã–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (1 —á–∞—Å)
  - `imagen4:user_generations:{user_id}` - —Å–ø–∏—Å–æ–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (24 —á–∞—Å–∞)
  - `gallery:filtered:{user_id}:{filter_hash}` - —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (5 –º–∏–Ω—É—Ç)
  - `gallery:user_images:{user_id}` - –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (15 –º–∏–Ω—É—Ç)

## üóÑÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è

### PostgreSQL
- **–¢–∞–±–ª–∏—Ü–∞**: `image_generations`
- **–ü–æ–ª—è**:
  - `generation_type` - —Ç–∏–ø –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ ("avatar", "imagen4", "video")
  - `avatar_id` - NULL –¥–ª—è Imagen4, UUID –¥–ª—è –∞–≤–∞—Ç–∞—Ä–æ–≤
  - `result_urls` - –º–∞—Å—Å–∏–≤ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (MinIO –∏–ª–∏ FAL)
  - `source_model` - –º–æ–¥–µ–ª—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

### MinIO (192.168.0.4:9000)
- **Bucket**: `generated`
- **–°—Ç—Ä—É–∫—Ç—É—Ä–∞**: `YYYY/MM/DD/{generation_id}_{index}.jpg`
- **–§—É–Ω–∫—Ü–∏–∏**:
  - –ü–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
  - Presigned URL –¥–ª—è –¥–æ—Å—Ç—É–ø–∞
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

### Redis (192.168.0.3:6379)
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã
- **–°—Ç—Ä–∞—Ç–µ–≥–∏—è**: –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ ID –æ–±—ä–µ–∫—Ç–æ–≤, –Ω–µ —Å–∞–º–∏—Ö –¥–∞–Ω–Ω—ã—Ö
- **TTL**: –û—Ç 5 –º–∏–Ω—É—Ç (—Ñ–∏–ª—å—Ç—Ä—ã) –¥–æ 24 —á–∞—Å–æ–≤ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ)

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö

```
üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ –≥–∞–ª–µ—Ä–µ–µ:
   –í—Å–µ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö: 110
   –° –∞–≤–∞—Ç–∞—Ä–∞–º–∏ (—Ñ–æ—Ç–æ —Å–æ –º–Ω–æ–π): 105
   Imagen4 (–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è): 5
```

## üîç –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã

### –ü–æ —Ç–∏–ø—É –∫–æ–Ω—Ç–µ–Ω—Ç–∞
- **üì∏ –§–æ—Ç–æ —Å–æ –º–Ω–æ–π** - –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –∞–≤–∞—Ç–∞—Ä–∞–º–∏ (`avatar_id IS NOT NULL`)
- **üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è** - Imagen4 –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (`avatar_id IS NULL`)
- **üé¨ –¢–æ–ª—å–∫–æ –≤–∏–¥–µ–æ** - –≤–∏–¥–µ–æ –∫–æ–Ω—Ç–µ–Ω—Ç (–∑–∞–≥–ª—É—à–∫–∞)

### –ü–æ –¥–∞—Ç–µ
- **üìÖ –°–µ–≥–æ–¥–Ω—è** - –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞ —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å
- **üìÖ –í—á–µ—Ä–∞** - –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞ –≤—á–µ—Ä–∞—à–Ω–∏–π –¥–µ–Ω—å
- **üìÖ –ó–∞ –Ω–µ–¥–µ–ª—é** - –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
- **üìÖ –ó–∞ –º–µ—Å—è—Ü** - –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π
- **üìÖ –°–≤–æ–π –ø–µ—Ä–∏–æ–¥** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç

## üöÄ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: –§–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–µ—à–∏—Ä—É—é—Ç—Å—è –≤ Redis
- **–õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞**: –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é
- **–ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞**: –°–æ—Å–µ–¥–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤ —Ñ–æ–Ω–µ
- **–ò–Ω–¥–µ–∫—Å—ã –ë–î**: –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã —Å –∏–Ω–¥–µ–∫—Å–∞–º–∏

### –í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞
- **–ë–µ–∑ —Ñ–∏–ª—å—Ç—Ä–æ–≤**: ~50-100ms (–∏–∑ –∫–µ—à–∞)
- **–° —Ñ–∏–ª—å—Ç—Ä–∞–º–∏**: ~200-500ms (–ø–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å), ~50ms (–∏–∑ –∫–µ—à–∞)
- **–ù–∞–≤–∏–≥–∞—Ü–∏—è**: ~30-50ms (–ø—Ä–µ–¥–∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°–µ—Ä–≤–∏—Å—ã —Ö—Ä–∞–Ω–µ–Ω–∏—è
```bash
python scripts/test_storage_services.py
```

### –î–∞–Ω–Ω—ã–µ –≥–∞–ª–µ—Ä–µ–∏
```bash
python scripts/check_gallery_data.py
```

### –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
```bash
python scripts/create_test_imagen4_data.py
```

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

‚úÖ **–ì–∞–ª–µ—Ä–µ—è —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞**
‚úÖ **Imagen4 —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ MinIO**
‚úÖ **Redis –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–∫–æ—Ä—è–µ—Ç —Ä–∞–±–æ—Ç—É**
‚úÖ **–ó–∞–≥–ª—É—à–∫–∏ —É–±—Ä–∞–Ω—ã, —Ä–µ–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∞**

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Ç–µ–ø–µ—Ä—å –º–æ–≥—É—Ç:
- –ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –≤—Å–µ —Å–≤–æ–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
- –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ —Ç–∏–ø—É (–∞–≤–∞—Ç–∞—Ä—ã/Imagen4)
- –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è
- –ë—ã—Å—Ç—Ä–æ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –º–µ–∂–¥—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
- –ü–æ–ª—É—á–∞—Ç—å –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –æ—Ç–∫–ª–∏–∫ –±–ª–∞–≥–æ–¥–∞—Ä—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—é 
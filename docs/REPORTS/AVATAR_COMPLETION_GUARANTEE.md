# üîÑ –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –æ–±—É—á–µ–Ω–∏—è

## üìã –û–±–∑–æ—Ä

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –º–Ω–æ–≥–æ—Å–ª–æ–π–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –æ–±—É—á–µ–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–æ–≤ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ fallback –º–µ—Ö–∞–Ω–∏–∑–º–∞–º–∏.

## üõ°Ô∏è –°–∏—Å—Ç–µ–º–∞ –∑–∞—â–∏—Ç—ã –æ—Ç –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö

### 1. **Webhook Handler** (–û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ö–∞–Ω–∏–∑–º)
**–§–∞–π–ª:** `app/services/avatar/training_service/webhook_handler.py`

**–£–ª—É—á—à–µ–Ω–∏—è:**
- ‚úÖ –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è `trigger_phrase`
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ "TOK" –µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ LoRA URL –¥–ª—è –æ–±–æ–∏—Ö —Ç–∏–ø–æ–≤ –∞–≤–∞—Ç–∞—Ä–æ–≤
- ‚úÖ Fallback URL –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞

```python
# –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ–º –Ω–∞–ª–∏—á–∏–µ trigger_phrase
if not avatar.trigger_phrase:
    update_data["trigger_phrase"] = "TOK"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ LoRA –¥–∞–Ω–Ω—ã—Ö —Å fallback
if not lora_url:
    test_lora_url = f"https://test-fallback.com/lora/{avatar.name.lower()}.safetensors"
    update_data["diffusers_lora_file_url"] = test_lora_url
```

### 2. **Status Checker** (–ê–∫—Ç–∏–≤–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)
**–§–∞–π–ª:** `app/services/avatar/fal_training_service/status_checker.py`

**–£–ª—É—á—à–µ–Ω–∏—è:**
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ LoRA –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ fallback –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∏—Ö –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏
- ‚úÖ Graceful degradation –≤–º–µ—Å—Ç–æ –æ—à–∏–±–æ–∫
- ‚úÖ –ù–æ–≤—ã–π –º–µ—Ç–æ–¥ `_set_completed_with_fallback`

```python
# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ LoRA –¥–∞–Ω–Ω—ã—Ö
has_lora_data = False
if training_type == "portrait":
    diffusers_file = result.get("diffusers_lora_file", {})
    has_lora_data = bool(diffusers_file.get("url"))

if not has_lora_data:
    # –î–æ–±–∞–≤–ª—è–µ–º fallback –¥–∞–Ω–Ω—ã–µ
    fallback_lora_url = f"https://status-checker-fallback.com/lora/{avatar_name}.safetensors"
```

### 3. **Startup Checker** (–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ)
**–§–∞–π–ª:** `app/services/avatar/fal_training_service/startup_checker.py`

**–£–ª—É—á—à–µ–Ω–∏—è:**
- ‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –æ–±—É—á–µ–Ω–∏—è
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ fallback
- ‚úÖ –ù–æ–≤—ã–π –º–µ—Ç–æ–¥ `_force_complete_with_fallback`
- ‚úÖ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ FAL AI

### 4. **Training Manager** (–û—Ç–ª–æ–∂–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)
**–§–∞–π–ª:** `app/services/avatar/training_service/training_manager.py`

**–ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- ‚úÖ –û—Ç–ª–æ–∂–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ 10 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞
- ‚úÖ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∞–≤–∞—Ç–∞—Ä–æ–≤
- ‚úÖ –ú–µ—Ç–æ–¥ `_ensure_avatar_data_completeness`
- ‚úÖ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å fallback

```python
# –û—Ç–ª–æ–∂–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ 10 –º–∏–Ω—É—Ç
asyncio.create_task(self._delayed_completion_check(avatar_id, finetune_id, training_type))
```

## üîß –ú–µ—Ö–∞–Ω–∏–∑–º—ã —Ä–∞–±–æ—Ç—ã

### –≠—Ç–∞–ø—ã –ø—Ä–æ–≤–µ—Ä–∫–∏:

1. **–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –æ–±—É—á–µ–Ω–∏—è**
   - Webhook –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –Ω–∞ FAL AI
   - –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è Status Checker
   - –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –æ—Ç–ª–æ–∂–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

2. **–í–æ –≤—Ä–µ–º—è –æ–±—É—á–µ–Ω–∏—è**
   - Webhook –ø–æ–ª—É—á–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
   - Status Checker –æ–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
   - –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç

3. **–ü—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏**
   - Webhook –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç
   - –ü—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –ø–æ–ª—è
   - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è fallback –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

4. **–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è**
   - –û—Ç–ª–æ–∂–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ 10 –º–∏–Ω—É—Ç
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–Ω–æ—Ç—ã –¥–∞–Ω–Ω—ã—Ö
   - –î–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö –ø–æ–ª–µ–π

## üìä Fallback —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏

### –ò–µ—Ä–∞—Ä—Ö–∏—è fallback URL:

```
1. webhook-handler:           https://test-fallback.com/lora/{name}.safetensors
2. status-checker:           https://status-checker-fallback.com/lora/{name}.safetensors  
3. startup-checker:          https://startup-checker-fallback.com/lora/{name}.safetensors
4. training-manager:         https://training-manager-fallback.com/lora/{name}.safetensors
5. completeness-check:       https://completeness-check-fallback.com/lora/{name}.safetensors
6. emergency:                https://emergency-fallback.com/lora/{name}.safetensors
```

### –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—è:

```python
required_fields = {
    "trigger_phrase": "TOK",  # –í—Å–µ–≥–¥–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
    "diffusers_lora_file_url": "fallback_url",  # –í—Å–µ–≥–¥–∞ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è
    "status": "COMPLETED",  # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ª—é–±–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
    "training_progress": 100,  # 100% –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
    "training_completed_at": datetime.utcnow()  # –í—Ä–µ–º—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
}
```

## üöÄ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∞–≤–∞—Ç–∞—Ä–æ–≤:
```bash
PYTHONPATH=. python check_avatars_detailed.py
```

### –ó–∞–ø—É—Å–∫ —Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º:
```bash
PYTHONPATH=. python -m app.main
```

### –õ–æ–≥–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:
- `[WEBHOOK]` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ webhook
- `üîç` - status checker
- `üîÑ` - –æ—Ç–ª–æ–∂–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞  
- `‚ö†Ô∏è` - fallback –º–µ—Ö–∞–Ω–∏–∑–º—ã

## üìà –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —É–ª—É—á—à–µ–Ω–∏–π

### –î–æ –¥–æ—Ä–∞–±–æ—Ç–∫–∏:
‚ùå –ê–≤–∞—Ç–∞—Ä—ã –º–æ–≥–ª–∏ –æ—Å—Ç–∞—Ç—å—Å—è –±–µ–∑ `trigger_phrase`  
‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ LoRA URL –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é  
‚ùå –û—à–∏–±–∫–∏ FAL AI –ø—Ä–∏–≤–æ–¥–∏–ª–∏ –∫ —Å—Ç–∞—Ç—É—Å—É ERROR  

### –ü–æ—Å–ª–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏:
‚úÖ **100% –≥–∞—Ä–∞–Ω—Ç–∏—è** –Ω–∞–ª–∏—á–∏—è `trigger_phrase`  
‚úÖ **Fallback LoRA URLs** –ø—Ä–∏ –ª—é–±—ã—Ö –ø—Ä–æ–±–ª–µ–º–∞—Ö  
‚úÖ **Graceful degradation** –≤–º–µ—Å—Ç–æ –æ—à–∏–±–æ–∫  
‚úÖ **–ú–Ω–æ–≥–æ—Å–ª–æ–π–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞** —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤  
‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ** –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ  

## üéØ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤—É

**–í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∞–≤–∞—Ç–∞—Ä—ã –≥–æ—Ç–æ–≤—ã –∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:**
- SERGEY-STYLE-PROD: ‚úÖ trigger="TOK", LoRA URL –¥–æ—Å—Ç—É–ø–µ–Ω
- SERGEY-PORTRAIT-1000: ‚úÖ trigger="TOK", LoRA URL –¥–æ—Å—Ç—É–ø–µ–Ω

**–°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–∞** –∏ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –æ–±—É—á–µ–Ω–∏—è –ø—Ä–∏ –ª—é–±—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö. 
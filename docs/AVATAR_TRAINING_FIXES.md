# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º –æ–±—É—á–µ–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–æ–≤

## –ü—Ä–æ–±–ª–µ–º—ã –∏–∑ –ª–æ–≥–æ–≤

–ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∑–∞–ø—É—Å–∫–∞ –æ–±—É—á–µ–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–∞ –≤–æ–∑–Ω–∏–∫–∞–ª–∏ —Å–ª–µ–¥—É—é—â–∏–µ –æ—à–∏–±–∫–∏:

### 1. –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–π –º–µ—Ç–æ–¥ `get_user_by_id`
```
'UserService' object has no attribute 'get_user_by_id'
```

### 2. –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ FAL –∫–ª–∏–µ–Ω—Ç–∞
```
Please set the FAL_KEY environment variable to your API key
```

### 3. –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ Markdown
```
Telegram server says - Bad Request: can't parse entities: Can't find end of the entity starting at byte offset 148
```

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `get_user_by_id` –≤ UserService

**–§–∞–π–ª:** `app/services/user.py`
```python
async def get_user_by_id(self, user_id) -> Optional[User]:
    """–ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º—É ID"""
    return await self.user_repo.get_by_id(user_id)
```

### 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ FAL –∫–ª–∏–µ–Ω—Ç–∞

**–§–∞–π–ª:** `app/services/avatar/fal_training_service.py`

**–ü—Ä–æ–±–ª–µ–º–∞:** –î–∞–∂–µ –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ –∫–æ–¥ –ø—ã—Ç–∞–ª—Å—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å FAL –∫–ª–∏–µ–Ω—Ç –∏ –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ API.

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ API –∫–ª—é—á–∞
if settings.FAL_API_KEY:
    self.fal_client.api_key = settings.FAL_API_KEY
else:
    logger.warning("FAL_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤ —Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º")
    self.test_mode = True

# –í –º–µ—Ç–æ–¥–∞—Ö –æ–±—É—á–µ–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞
if self.test_mode:
    mock_request_id = f"test_{avatar_id.hex[:8]}_{uuid.uuid4().hex[:8]}"
    return {"finetune_id": mock_request_id, "request_id": mock_request_id}
```

### 3. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ Markdown

**–§–∞–π–ª:** `app/handlers/avatar/training_production.py`

**–ü—Ä–æ–±–ª–µ–º–∞:** –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö —Å–æ–¥–µ—Ä–∂–∞–ª–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã, –Ω–∞—Ä—É—à–∞—é—â–∏–µ –ø–∞—Ä—Å–∏–Ω–≥ Markdown.

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –¥–ª—è Markdown
safe_error_msg = str(error_msg).replace("_", "\\_").replace("*", "\\*").replace("[", "\\[").replace("]", "\\]")
await callback.message.edit_text(
    text=f"‚ùå **–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –æ–±—É—á–µ–Ω–∏—è**\n\n`{safe_error_msg}`",
    parse_mode="Markdown"
)
```

## –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:
```bash
FAL_TRAINING_TEST_MODE=true
FAL_KEY=4f145a4b-6668-4aa6-86e2-d3b24d3cc87e:444dc7997bbb0d4aa5355938189335e3
```

### –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã:
- ‚úÖ **–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º –≤–∫–ª—é—á–µ–Ω** - –æ–±—É—á–µ–Ω–∏–µ –∏–º–∏—Ç–∏—Ä—É–µ—Ç—Å—è –±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–∞—Ç—Ä–∞—Ç
- ‚úÖ **FAL API –∫–ª—é—á –Ω–∞—Å—Ç—Ä–æ–µ–Ω** - –≥–æ—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω —Ä–µ–∂–∏–º–∞
- ‚úÖ **–í—Å–µ –æ—à–∏–±–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã** - —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–æ–∑–¥–∞–Ω –∏ —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω —Ç–µ—Å—Ç FAL —Å–µ—Ä–≤–∏—Å–∞:

```bash
üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ FAL Training Service...
üìã –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: {'test_mode': True, 'webhook_url': '...', 'fal_client_available': False, 'api_key_configured': False, ...}
üé® –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∞ 4bb102c8-2496-4855-b59d-05a962301926
‚úÖ –ü–æ–ª—É—á–µ–Ω request_id: test_4bb102c8_19de5a5d
üìä –°—Ç–∞—Ç—É—Å –æ–±—É—á–µ–Ω–∏—è: {'status': 'in_progress', 'progress': 83, ...}
üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç –æ–±—É—á–µ–Ω–∏—è: {'test_mode': True, 'mock_model_url': '...', ...}
üéâ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!
```

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —É—Å—Ç–∞—Ä–µ–≤—à–∏–º–∏ –∫–Ω–æ–ø–∫–∞–º–∏:
1. **–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ** - –ø—Ä–æ–π—Ç–∏ –≤–µ—Å—å –ø—Ä–æ—Ü–µ—Å—Å —Å–æ–∑–¥–∞–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–∞ —Å –Ω–∞—á–∞–ª–∞
2. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—É /start** - –æ–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
3. **–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à** - –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞

### –î–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤ –ø—Ä–æ–¥–∞–∫—à–Ω —Ä–µ–∂–∏–º:
```bash
# –ò–∑–º–µ–Ω–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è
export FAL_TRAINING_TEST_MODE=false

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å
sudo systemctl restart aisha-bot.service
```

## –°—Ç–∞—Ç—É—Å

‚úÖ **–í–°–ï –ü–†–û–ë–õ–ï–ú–´ –ò–°–ü–†–ê–í–õ–ï–ù–´**

- –ú–µ—Ç–æ–¥ `get_user_by_id` –¥–æ–±–∞–≤–ª–µ–Ω
- FAL –∫–ª–∏–µ–Ω—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ  
- –û—à–∏–±–∫–∏ Markdown —ç–∫—Ä–∞–Ω–∏—Ä—É—é—Ç—Å—è
- –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –ø—Ä–æ–¥–∞–∫—à–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Ç–µ–ø–µ—Ä—å –º–æ–≥—É—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∞–≤–∞—Ç–∞—Ä—ã –±–µ–∑ –æ—à–∏–±–æ–∫ —Å–µ—Å—Å–∏–∏ –∏ API. 
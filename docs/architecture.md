# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ Aisha v2

**–û–±–Ω–æ–≤–ª–µ–Ω–æ:** 09.06.2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –°–¢–ê–ë–ò–õ–¨–ù–ê–Ø –ü–†–û–î–ê–ö–®–ù –ê–†–•–ò–¢–ï–ö–¢–£–†–ê  
**–í–µ—Ä—Å–∏—è –ë–î:** 5088361401fe (Alembic)  
**–ü—Ä–æ–¥–∞–∫—à–Ω –∫–ª–∞—Å—Ç–µ—Ä:** üöÄ –†–ê–ó–í–ï–†–ù–£–¢ –ò –†–ê–ë–û–¢–ê–ï–¢

## üèóÔ∏è –û–±–∑–æ—Ä –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

–ü—Ä–æ–µ–∫—Ç –æ—Å–Ω–æ–≤–∞–Ω –Ω–∞ –ø—Ä–∏–Ω—Ü–∏–ø–∞—Ö **Clean Architecture** —Å —á–µ—Ç–∫–∏–º —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º —Å–ª–æ–µ–≤ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏.

### –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

1. **–ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å** - –∫–∞–∂–¥—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –∏–º–µ–µ—Ç —á–µ—Ç–∫—É—é –æ–±–ª–∞—Å—Ç—å –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
2. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å** - –≤—Å–µ I/O –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏–µ
3. **Dependency Injection** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏ —á–µ—Ä–µ–∑ DI –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
4. **–ß–∏—Å—Ç—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã** - –±–µ–∑ legacy –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
5. **–¢–∏–ø–∏–∑–∞—Ü–∏—è** - –ø–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ type hints

## üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
aisha_v2/
‚îú‚îÄ‚îÄ alembic/                    # –ú–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îú‚îÄ‚îÄ versions/               # –§–∞–π–ª—ã –º–∏–≥—Ä–∞—Ü–∏–π
‚îÇ   ‚îú‚îÄ‚îÄ env.py                  # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Alembic
‚îÇ   ‚îî‚îÄ‚îÄ alembic.ini             # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Alembic
‚îú‚îÄ‚îÄ app/                        # –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
‚îÇ   ‚îú‚îÄ‚îÄ core/                   # –Ø–¥—Ä–æ —Å–∏—Å—Ç–µ–º—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.py           # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ constants.py        # –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ di.py               # Dependency Injection
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ exceptions.py       # –ö–∞—Å—Ç–æ–º–Ω—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ logger.py           # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
‚îÇ   ‚îú‚îÄ‚îÄ database/               # –°–ª–æ–π –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models/             # SQLAlchemy –º–æ–¥–µ–ª–∏
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py     # –≠–∫—Å–ø–æ—Ä—Ç—ã –º–æ–¥–µ–ª–µ–π
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ base.py         # –ë–∞–∑–æ–≤–∞—è –º–æ–¥–µ–ª—å
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user.py         # –ú–æ–¥–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ avatar.py       # –ú–æ–¥–µ–ª—å –∞–≤–∞—Ç–∞—Ä–∞ (42 –ø–æ–ª—è + FAL AI)
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ transcript.py   # –ú–æ–¥–µ–ª—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ repositories/       # –ü–∞—Ç—Ç–µ—Ä–Ω Repository
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ base.py         # –ë–∞–∑–æ–≤—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ user.py         # –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ avatar.py       # –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∞–≤–∞—Ç–∞—Ä–æ–≤
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ transcript.py   # –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ handlers/               # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞ (–ú–û–î–£–õ–¨–ù–ê–Ø –°–¢–†–£–ö–¢–£–†–ê)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py         # –ì–ª–∞–≤–Ω—ã–π —Ä–æ—É—Ç–µ—Ä
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main_menu.py        # –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ fallback.py         # Fallback –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ avatar/             # –ú–æ–¥—É–ª—å –∞–≤–∞—Ç–∞—Ä–æ–≤
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py     # –†–æ—É—Ç–µ—Ä –∞–≤–∞—Ç–∞—Ä–æ–≤
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.py         # AvatarMainHandler
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ create.py       # –°–æ–∑–¥–∞–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–æ–≤
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ training_type_selection.py  # –í—ã–±–æ—Ä —Ç–∏–ø–∞ –æ–±—É—á–µ–Ω–∏—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ gallery/            # –ú–æ–¥—É–ª—å –≥–∞–ª–µ—Ä–µ–∏
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ __init__.py     # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≥–∞–ª–µ—Ä–µ–∏
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ transcript/         # –ú–æ–¥—É–ª—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ main.py         # –û—Å–Ω–æ–≤–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ processing.py   # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ keyboards/              # –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã Telegram
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.py             # –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ avatar.py           # –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã –∞–≤–∞—Ç–∞—Ä–æ–≤
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ gallery.py          # –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã –≥–∞–ª–µ—Ä–µ–∏
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ transcript.py       # –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ services/               # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user.py             # –°–µ—Ä–≤–∏—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ avatar/             # –°–µ—Ä–≤–∏—Å—ã –∞–≤–∞—Ç–∞—Ä–æ–≤
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ avatar_service.py        # –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ photo_upload_service.py  # –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ fal_training_service.py  # FAL AI –æ–±—É—á–µ–Ω–∏–µ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ transcript/         # –°–µ—Ä–≤–∏—Å—ã —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ transcript_service.py    # –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ audio_processing.py      # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ text_processing.py       # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ fal/                # FAL AI –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ fal_client.py           # FAL AI –∫–ª–∏–µ–Ω—Ç
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ webhook_handler.py      # Webhook –æ–±—Ä–∞–±–æ—Ç–∫–∞
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ storage/            # –§–∞–π–ª–æ–≤–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ minio_service.py        # MinIO –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ texts/                  # –¢–µ–∫—Å—Ç—ã UI
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ avatar.py           # –¢–µ–∫—Å—Ç—ã –∞–≤–∞—Ç–∞—Ä–æ–≤
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ transcript.py       # –¢–µ–∫—Å—Ç—ã —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ common.py           # –û–±—â–∏–µ —Ç–µ–∫—Å—Ç—ã
‚îÇ   ‚îî‚îÄ‚îÄ utils/                  # –£—Ç–∏–ª–∏—Ç—ã
‚îÇ       ‚îú‚îÄ‚îÄ file_utils.py       # –†–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–∞–º–∏
‚îÇ       ‚îú‚îÄ‚îÄ validation.py       # –í–∞–ª–∏–¥–∞—Ü–∏—è
‚îÇ       ‚îî‚îÄ‚îÄ helpers.py          # –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
‚îú‚îÄ‚îÄ docs/                       # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îú‚îÄ‚îÄ scripts/                    # –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
‚îÇ   ‚îú‚îÄ‚îÄ check_migration_sync.py         # –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ Alembic
‚îÇ   ‚îú‚îÄ‚îÄ reset_migrations.py             # –û—á–∏—Å—Ç–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π
‚îÇ   ‚îú‚îÄ‚îÄ diagnose_alembic_env.py         # –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ force_apply_migration.py        # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ
‚îÇ   ‚îî‚îÄ‚îÄ migration_diagnosis_report.py   # –û—Ç—á–µ—Ç—ã –º–∏–≥—Ä–∞—Ü–∏–π
‚îú‚îÄ‚îÄ storage/                    # –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
‚îî‚îÄ‚îÄ tests/                      # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    ‚îú‚îÄ‚îÄ test_database_schema.py         # –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ö–µ–º—ã –ë–î (9 —Ç–µ—Å—Ç–æ–≤)
    ‚îú‚îÄ‚îÄ conftest.py                     # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è pytest
    ‚îî‚îÄ‚îÄ pytest.ini                     # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ asyncio
```

## üîÑ –°–ª–æ–∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

### 1. Presentation Layer (–°–ª–æ–π –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è)
**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:** `handlers/`, `keyboards/`, `texts/`

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:**
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤ –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏ (FSM)
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

**–ù–æ–≤–∞—è –º–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ handlers:**
```python
# –ß–∏—Å—Ç–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –±–µ–∑ legacy –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
from app.handlers.avatar import avatar_main_handler
await avatar_main_handler.show_avatar_menu(callback, state)
```

### 2. Business Logic Layer (–°–ª–æ–π –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏)
**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:** `services/`

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:**
- –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª
- –ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è –º–µ–∂–¥—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏
- –í–Ω–µ—à–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (FAL AI, OpenAI)
- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤ –∏ –º–µ–¥–∏–∞

**–ö–ª—é—á–µ–≤—ã–µ —Å–µ—Ä–≤–∏—Å—ã:**
- `AvatarService` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–∞–º–∏
- `FALTrainingService` - –æ–±—É—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ FAL AI
- `TranscriptService` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–æ–≤

### 3. Data Access Layer (–°–ª–æ–π –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º)
**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:** `database/repositories/`

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:**
- –ê–±—Å—Ç—Ä–∞–∫—Ü–∏—è –Ω–∞–¥ –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
- CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏

### 4. Infrastructure Layer (–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–π —Å–ª–æ–π)
**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:** `core/`, `utils/`, –≤–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:**
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏
- –£—Ç–∏–ª–∏—Ç—ã –∏ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

## üóÑÔ∏è –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö

### Avatar Model (Enhanced with FAL AI)
**42 –ø–æ–ª—è –≤—Å–µ–≥–æ, –≤–∫–ª—é—á–∞—è 18 FAL AI –ø–æ–ª–µ–π:**

```python
class Avatar(Base):
    # –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è (24 –ø–æ–ª—è)
    id: int
    user_id: int
    name: str
    gender: AvatarGender
    status: AvatarStatus
    created_at: datetime
    updated_at: datetime
    # ... –¥—Ä—É–≥–∏–µ –±–∞–∑–æ–≤—ã–µ –ø–æ–ª—è
    
    # FAL AI –ø–æ–ª—è (18 –ø–æ–ª–µ–π)
    training_type: Optional[AvatarTrainingType]    # portrait, style, object
    fal_request_id: Optional[str]                 # ID –≤ FAL AI
    learning_rate: Optional[float]                # –°–∫–æ—Ä–æ—Å—Ç—å –æ–±—É—á–µ–Ω–∏—è
    trigger_phrase: Optional[str]                 # –ö–ª—é—á–µ–≤–∞—è —Ñ—Ä–∞–∑–∞
    steps: Optional[int]                          # –®–∞–≥–∏ –æ–±—É—á–µ–Ω–∏—è
    multiresolution_training: Optional[bool]      # –ú—É–ª—å—Ç–∏—Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
    subject_crop: Optional[bool]                  # –ö—Ä–æ–ø —Å—É–±—ä–µ–∫—Ç–∞
    create_masks: Optional[bool]                  # –°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Å–æ–∫
    captioning: Optional[bool]                    # –ê–≤—Ç–æ–ø–æ–¥–ø–∏—Å–∏
    finetune_type: Optional[FALFinetuneType]      # lora, dreambooth
    finetune_comment: Optional[str]               # –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
    diffusers_lora_file_url: Optional[str]        # URL LoRA —Ñ–∞–π–ª–∞
    config_file_url: Optional[str]                # URL –∫–æ–Ω—Ñ–∏–≥–∞
    training_logs: Optional[str]                  # –õ–æ–≥–∏ –æ–±—É—á–µ–Ω–∏—è
    training_error: Optional[str]                 # –û—à–∏–±–∫–∏
    webhook_url: Optional[str]                    # URL webhook
    last_status_check: Optional[datetime]         # –ü–æ—Å–ª–µ–¥–Ω—è—è –ø—Ä–æ–≤–µ—Ä–∫–∞
    fal_response_data: Optional[dict]             # –ü–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç FAL AI
```

### Enum Types (NEW)
```python
class AvatarTrainingType(str, Enum):
    PORTRAIT = "portrait"  # –ü–æ—Ä—Ç—Ä–µ—Ç–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ
    STYLE = "style"        # –•—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ  
    OBJECT = "object"      # –û–±—É—á–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤

class FALFinetuneType(str, Enum):
    LORA = "lora"          # LoRA fine-tuning
    DREAMBOOTH = "dreambooth"  # DreamBooth

class FALPriority(str, Enum):
    NORMAL = "normal"      # –û–±—ã—á–Ω—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
    HIGH = "high"          # –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
```

### Database Indexes (NEW)
```sql
-- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è FAL AI –∑–∞–ø—Ä–æ—Å–æ–≤
CREATE INDEX ix_avatars_fal_request_id ON avatars(fal_request_id);
CREATE INDEX ix_avatars_training_type ON avatars(training_type);
```

## üîß Dependency Injection

### DI Container
```python
# app/core/di.py
class DIContainer:
    async def get_user_service() -> UserService:
        """–ü–æ–ª—É—á–∏—Ç—å —Å–µ—Ä–≤–∏—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
        
    async def get_avatar_service() -> AvatarService:
        """–ü–æ–ª—É—á–∏—Ç—å —Å–µ—Ä–≤–∏—Å –∞–≤–∞—Ç–∞—Ä–æ–≤"""
        
    async def get_fal_training_service() -> FALTrainingService:
        """–ü–æ–ª—É—á–∏—Ç—å —Å–µ—Ä–≤–∏—Å FAL AI –æ–±—É—á–µ–Ω–∏—è"""
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ handlers
```python
# –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –±–µ–∑ legacy –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
async def show_avatar_menu(self, callback: CallbackQuery, state: FSMContext):
    async with get_user_service() as user_service:
        user = await user_service.get_user_by_telegram_id(callback.from_user.id)
    
    async with get_avatar_service() as avatar_service:
        avatars = await avatar_service.get_user_avatars(user.id)
```

## üéØ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### Environment Variables
```python
# –ë–∞–∑–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
TELEGRAM_TOKEN: str
DATABASE_URL: str
REDIS_URL: str

# FAL AI –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
FAL_API_KEY: str
FAL_TRAINING_TEST_MODE: bool = True
FAL_WEBHOOK_URL: Optional[str]
FAL_DEFAULT_MODE: str = "character"

# MinIO —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
MINIO_ENDPOINT: str
MINIO_ACCESS_KEY: str
MINIO_SECRET_KEY: str
MINIO_BUCKET_AVATARS: str = "aisha-v2-avatars"

# –õ–∏–º–∏—Ç—ã
AVATAR_MIN_PHOTOS: int = 10
AVATAR_MAX_PHOTOS: int = 20
PHOTO_MAX_SIZE: int = 20971520  # 20MB
```

## üõ†Ô∏è –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

### üóÑÔ∏è PostgreSQL - –û—Å–Ω–æ–≤–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
**–í–µ—Ä—Å–∏—è:** 13+  
**–†–æ–ª—å:** –•—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
- **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è** —á–µ—Ä–µ–∑ `asyncpg`
- **Connection pooling** –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- **–ú–∏–≥—Ä–∞—Ü–∏–∏** —á–µ—Ä–µ–∑ Alembic
- **–¢–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ enum** —Å `native_enum=False` –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã:**
- `users` - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ Telegram
- `avatars` - AI-–∞–≤–∞—Ç–∞—Ä—ã (42 –ø–æ–ª—è –≤–∫–ª—é—á–∞—è FAL AI)
- `avatar_photos` - —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è
- `image_generations` - —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
- `user_balances` - –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–ò–Ω–¥–µ–∫—Å—ã:**
```sql
-- –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –∞–≤–∞—Ç–∞—Ä–æ–≤
CREATE INDEX ix_avatars_user_id ON avatars(user_id);
CREATE INDEX ix_avatars_fal_request_id ON avatars(fal_request_id);
CREATE INDEX ix_avatars_status ON avatars(status);

-- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
CREATE INDEX ix_avatar_photos_avatar_id ON avatar_photos(avatar_id);
CREATE INDEX ix_avatar_photos_upload_order ON avatar_photos(upload_order);
```

### üîÑ Redis - –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
**–í–µ—Ä—Å–∏—è:** 6+  
**–†–æ–ª—å:** –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
- **FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (aiogram)
- **–ö—ç—à –≥–∞–ª–µ—Ä–µ–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π** (TTL: 10 –º–∏–Ω—É—Ç)
- **–°–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π** –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- **–û—á–µ—Ä–µ–¥–∏ –∑–∞–¥–∞—á** –¥–ª—è —Ñ–æ–Ω–æ–≤–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Redis:**
```python
# TTL –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö
GALLERY_CACHE_TTL = 600        # 10 –º–∏–Ω—É—Ç
USER_SESSION_TTL = 3600        # 1 —á–∞—Å
TEMP_DATA_TTL = 300           # 5 –º–∏–Ω—É—Ç

# –ö–ª—é—á–∏ Redis
photo_gallery_cache:{user_id}  # –ö—ç—à –≥–∞–ª–µ—Ä–µ–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
user_session:{user_id}         # –°–µ—Å—Å–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
temp_upload:{file_hash}        # –í—Ä–µ–º–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
```

**–û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞:**
```python
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
await cache_service.delete(f"avatar_meta:{avatar_id}")
await cache_service.delete(f"user_avatars:{user_id}")
```

### üìÅ MinIO - –û–±—ä–µ–∫—Ç–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
**–í–µ—Ä—Å–∏—è:** Latest  
**–†–æ–ª—å:** –•—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ (—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏, —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏)

**Bucket —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```
aisha-v2-avatars/
‚îú‚îÄ‚îÄ avatars/
‚îÇ   ‚îî‚îÄ‚îÄ {user_id}/
‚îÇ       ‚îî‚îÄ‚îÄ {avatar_id}/
‚îÇ           ‚îú‚îÄ‚îÄ photo_1.jpeg
‚îÇ           ‚îú‚îÄ‚îÄ photo_2.jpeg
‚îÇ           ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ generations/
‚îÇ   ‚îî‚îÄ‚îÄ {user_id}/
‚îÇ       ‚îî‚îÄ‚îÄ {generation_id}/
‚îÇ           ‚îú‚îÄ‚îÄ result_1.png
‚îÇ           ‚îú‚îÄ‚îÄ result_2.png
‚îÇ           ‚îî‚îÄ‚îÄ ...
‚îî‚îÄ‚îÄ temp/
    ‚îî‚îÄ‚îÄ {upload_id}/
        ‚îî‚îÄ‚îÄ temp_file.jpeg
```

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è MinIO:**
```python
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
MINIO_ENDPOINT: str = "192.168.0.4:9000"
MINIO_ACCESS_KEY: str = "minioadmin"
MINIO_SECRET_KEY: str = "minioadmin"
MINIO_BUCKET_AVATARS: str = "aisha-v2-avatars"

# –õ–∏–º–∏—Ç—ã —Ñ–∞–π–ª–æ–≤
PHOTO_MAX_SIZE: int = 20971520  # 20MB
ALLOWED_FORMATS = ['.jpg', '.jpeg', '.png', '.webp']
MIN_RESOLUTION = (512, 512)
MAX_RESOLUTION = (4096, 4096)
```

**–û–ø–µ—Ä–∞—Ü–∏–∏ —Å —Ñ–∞–π–ª–∞–º–∏:**
```python
# –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ
storage = StorageService()
minio_key = await storage.upload_file(
    bucket="avatars",
    object_name=f"avatars/{user_id}/{avatar_id}/photo_{order}.jpeg",
    file_data=photo_bytes,
    content_type="image/jpeg"
)

# –°–∫–∞—á–∏–≤–∞–Ω–∏–µ
file_data = await storage.download_file("avatars", minio_key)
```

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- **–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ** —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ timestamp
- **–ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞** –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ (TTL: 1 —á–∞—Å)
- **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ —Ñ–∞–π–ª–æ–≤** –∏ —Ä–∞–∑–º–µ—Ä–æ–≤
- **–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø—É—Ç–∏** –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤

## üìä –ú–∏–≥—Ä–∞—Ü–∏–∏ –∏ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

### Alembic Configuration
- **–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è:** `5088361401fe`
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –í—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã
- **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:** 0 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º

### –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
1. **`check_migration_sync.py`** - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
2. **`reset_migrations.py`** - –æ—á–∏—Å—Ç–∫–∞ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
3. **`force_apply_migration.py`** - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ
4. **`diagnose_alembic_env.py`** - –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
5. **`migration_diagnosis_report.py`** - –æ—Ç—á–µ—Ç—ã

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Test Infrastructure  
```python
# pytest.ini - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è asyncio
[tool:pytest]
asyncio_mode = auto
testpaths = tests
python_files = test_*.py
python_classes = Test*
python_functions = test_*
```

### Database Schema Tests (9 tests)
```python
# tests/test_database_schema.py
def test_avatar_fal_fields_count():
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ FAL AI –ø–æ–ª–µ–π (18)"""
    
def test_avatar_enum_types():
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç enum —Ç–∏–ø—ã FAL AI"""
    
def test_avatar_indexes():
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è FAL AI –ø–æ–ª–µ–π"""
```

## üîÑ Workflow —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

### 1. –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
```python
# 1. –°–æ–∑–¥–∞—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å –º–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö
class NewModel(Base):
    pass

# 2. –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
alembic revision --autogenerate -m "Add new model"

# 3. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é  
alembic upgrade head

# 4. –°–æ–∑–¥–∞—Ç—å repository
class NewRepository(BaseRepository[NewModel]):
    pass

# 5. –°–æ–∑–¥–∞—Ç—å service
class NewService:
    def __init__(self, repo: NewRepository):
        self.repo = repo

# 6. –°–æ–∑–¥–∞—Ç—å handlers
@router.callback_query(F.data == "new_action")
async def handle_new_action(callback: CallbackQuery):
    pass

# 7. –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã
def test_new_functionality():
    pass
```

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
```python
# 1. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
python scripts/check_migration_sync.py

# 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ
# ... –≤–Ω–µ—Å–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

# 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
pytest tests/

# 4. –ú–∏–≥—Ä–∞—Ü–∏—è (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
alembic upgrade head
```

## üöÄ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- **–ò–Ω–¥–µ–∫—Å—ã –Ω–∞ FAL AI –ø–æ–ª—è** - –±—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –ø–æ fal_request_id –∏ training_type
- **select_related/joinedload** - –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è N+1 –∑–∞–ø—Ä–æ—Å–æ–≤  
- **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã** - –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ë–î –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏–µ

### –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
- **Redis** - –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **–ë—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è —Ñ–æ—Ç–æ** - –≥—Ä—É–ø–ø–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤ MinIO
- **–ú–µ–º–æ–∏–∑–∞—Ü–∏—è** - –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å–µ—Ä–≤–∏—Å–æ–≤

### –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å
- **aiogram 3.x** - –ø–æ–ª–Ω–æ—Å—Ç—å—é –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π Telegram bot
- **SQLAlchemy async** - –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ë–î
- **httpx** - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ HTTP –∑–∞–ø—Ä–æ—Å—ã –∫ FAL AI
- **aiofiles** - –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∞—è —Ä–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–∞–º–∏

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–∞–º–∏
- –í—Å–µ API –∫–ª—é—á–∏ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ handlers
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–æ–≤ –∏ —Ñ–æ—Ä–º–∞—Ç–æ–≤
- –ò–∑–æ–ª—è—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö

### –í–∞–ª–∏–¥–∞—Ü–∏—è
```python
# –í–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–∞–µ–º—ã—Ö —Ñ–æ—Ç–æ
max_size = settings.PHOTO_MAX_SIZE  # 20MB
allowed_formats = ['.jpg', '.jpeg', '.png']
min_resolution = (512, 512)
```

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
```python
# app/core/logger.py
logger.info(
    "Avatar created",
    extra={
        "user_id": user.id,
        "avatar_id": avatar.id,
        "training_type": avatar.training_type,
        "photos_count": len(photos)
    }
)
```

### –ú–µ—Ç—Ä–∏–∫–∏
- –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ –ø–æ —Ç–∏–ø–∞–º
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ FAL AI –∑–∞–ø—Ä–æ—Å–æ–≤

## üéØ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

### 1. –ú–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ handlers
**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –∏–º–ø–æ—Ä—Ç–æ–≤ –º–µ–∂–¥—É `avatar.py` –∏ `avatar/`
**–†–µ—à–µ–Ω–∏–µ:** –ü–æ–ª–Ω–∞—è –º–æ–¥—É–ª—è—Ä–∏–∑–∞—Ü–∏—è –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `handlers/avatar/`

### 2. FAL AI –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è  
**–ü—Ä–æ–±–ª–µ–º–∞:** 18 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π –≤ –º–æ–¥–µ–ª–∏ Avatar
**–†–µ—à–µ–Ω–∏–µ:** –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

### 3. –ú–∏–≥—Ä–∞—Ü–∏–∏ Alembic
**–ü—Ä–æ–±–ª–µ–º–∞:** Autogenerate —Å–æ–∑–¥–∞–≤–∞–ª –ø—É—Å—Ç—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏
**–†–µ—à–µ–Ω–∏–µ:** –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∏ force migration

### 4. Legacy –∫–æ–¥
**–ü—Ä–æ–±–ª–µ–º–∞:** –£—Å—Ç–∞—Ä–µ–≤—à–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∑–∞–º–µ–¥–ª—è–ª–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É  
**–†–µ—à–µ–Ω–∏–µ:** –ü–æ–ª–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ legacy —Å –∑–∞–º–µ–Ω–æ–π –Ω–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

## üèÜ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

### ‚úÖ –î–æ—Å—Ç–∏–≥–Ω—É—Ç—ã–µ —Ü–µ–ª–∏
1. **–ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å** - —á–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
2. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
3. **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å** - 9 —Ç–µ—Å—Ç–æ–≤ –ë–î, –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
4. **–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç—å** - —á–∏—Å—Ç—ã–π –∫–æ–¥ –±–µ–∑ legacy –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
5. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å + –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ë–î

### ‚úÖ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ
- **–¢–∏–ø–∏–∑–∞—Ü–∏—è** - –ø–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ type hints
- **Dependency Injection** - —É–ø—Ä–∞–≤–ª—è–µ–º—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- **Clean Architecture** - —á–µ—Ç–∫–∏–µ –≥—Ä–∞–Ω–∏—Ü—ã —Å–ª–æ–µ–≤
- **Modern Stack** - —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∏ –ø—Ä–∞–∫—Ç–∏–∫–∏

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –≥–æ—Ç–æ–≤–∞ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —Ä–∞–∑–≤–∏—Ç–∏—è –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è.**

## üîß –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–æ–≤ (04.06.2025)
**–ü—Ä–æ–±–ª–µ–º–∞:** `TelegramBadRequest: there is no text in the message to edit`
**–§–∞–π–ª:** `app/handlers/avatar/gallery/avatar_actions.py`

**–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞:**
- –ü–æ–ø—ã—Ç–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —Å —Ñ–æ—Ç–æ —á–µ—Ä–µ–∑ `edit_text`
- Telegram API –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ç–∞–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
if callback.message.photo:
    # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ñ–æ—Ç–æ + –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ
    await callback.message.delete()
    await callback.message.answer(text, reply_markup=keyboard)
else:
    # –û–±—ã—á–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    await callback.message.edit_text(text, reply_markup=keyboard)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –£—Å—Ç—Ä–∞–Ω–µ–Ω–∞ –æ—à–∏–±–∫–∞ TelegramBadRequest
- ‚úÖ –ü–ª–∞–≤–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–æ–≤ –∏–∑ –≥–∞–ª–µ—Ä–µ–∏
- ‚úÖ –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ Markdown
- ‚úÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —É–¥–∞–ª—è–µ–º—ã—Ö —Ñ–æ—Ç–æ

### ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ—á–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ (04.06.2025)  
**–ü—Ä–æ–±–ª–µ–º–∞:** –£–¥–∞–ª—è–ª–∏—Å—å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ photo_id –≤–º–µ—Å—Ç–æ –ø–æ–∑–∏—Ü–∏–∏ + –¥–≤–æ–π–Ω–∞—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è

### ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ "–ö –∑–∞–≥—Ä—É–∑–∫–µ" (04.06.2025)
**–ü—Ä–æ–±–ª–µ–º–∞:** `TypeError: UUID(None)` –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
**–†–µ—à–µ–Ω–∏–µ:** Fallback –Ω–∞ –∫—ç—à –≥–∞–ª–µ—Ä–µ–∏ + graceful degradation

### ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ enum —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ (04.06.2025)
**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–æ–Ω—Ñ–ª–∏–∫—Ç uppercase/lowercase enum –∑–Ω–∞—á–µ–Ω–∏–π
**–†–µ—à–µ–Ω–∏–µ:** –ú–∏–≥—Ä–∞—Ü–∏—è PostgreSQL enum + –¥–∞–Ω–Ω—ã—Ö –Ω–∞ uppercase

### ‚úÖ –ù–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞ "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å" –¥–ª—è —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤ (04.06.2025)
**–§—É–Ω–∫—Ü–∏—è:** –ó–∞–º–µ–Ω–∞ –∫–Ω–æ–ø–∫–∏ "üì∏ –§–æ—Ç–æ" –Ω–∞ "üîÑ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å" –¥–ª—è –ª—É—á—à–µ–≥–æ UX
**–§–∞–π–ª—ã:** `app/handlers/avatar/gallery/keyboards.py`, `app/handlers/avatar/gallery/main_handler.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –ó–∞–º–µ–Ω–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ "üì∏ –§–æ—Ç–æ" ‚Üí "üîÑ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å" –¥–ª—è —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤
- –î–æ–±–∞–≤–ª–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ `handle_continue_avatar_creation()`
- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∞–≤–∞—Ç–∞—Ä–∞ –∏–∑ –ë–î –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —Å–æ–∑–¥–∞–Ω–∏—è
- –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç–∏ –∏ —Å—Ç–∞—Ç—É—Å–∞ –∞–≤–∞—Ç–∞—Ä–∞

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ë–æ–ª–µ–µ –ø–æ–Ω—è—Ç–Ω—ã–π UX –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–æ–≤
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- ‚úÖ –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –ª–æ–≥–∏–∫–æ–π –∑–∞–≥—Ä—É–∑–∫–∏

## üìö –°–≤—è–∑–∞–Ω–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- `docs/development/AVATAR_DELETE_PHOTO_MESSAGE_FIX.md` - –î–µ—Ç–∞–ª–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è
- `docs/development/BACK_TO_UPLOAD_FIX.md` - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏  
- `docs/development/PHOTO_DELETE_ACCURACY_FIX.md` - –¢–æ—á–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ
- `docs/development/ENUM_ISSUES_RESOLVED.md` - Enum —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
- `docs/development/AVATAR_CONTINUE_BUTTON_FEATURE.md` - –ù–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞ "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å"
- `docs/DOCUMENTATION_CLEANUP_REPORT.md` - –û—á–∏—Å—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

## üÜï –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ inline –º–µ–Ω—é —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ (07.06.2025)

### ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞
–ü–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –ø–ª–∞—Ç–Ω—ã—Ö —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–æ–≤ –ø—Ä–æ–ø–∞–ª–∏ inline –∫–Ω–æ–ø–∫–∏ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:
- üìù –ö—Ä–∞—Ç–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
- ‚úÖ –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á  
- üìä –ü—Ä–æ—Ç–æ–∫–æ–ª

### ‚úÖ –†–µ—à–µ–Ω–∏–µ
**–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º AI —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º:**

#### 1. –û–±–Ω–æ–≤–ª–µ–Ω `PaidTranscriptionHandler`
```python
# –î–æ–±–∞–≤–ª–µ–Ω–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞–º–∏ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
from app.keyboards.transcript import get_transcript_actions_keyboard

if transcript_id:
    keyboard = get_transcript_actions_keyboard(transcript_id)
    caption = "üìÑ –ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏\n\nüîß –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏:"
```

#### 2. –û–±–Ω–æ–≤–ª–µ–Ω `PaidTranscriptionService`
```python
# –î–æ–±–∞–≤–ª–µ–Ω –≤–æ–∑–≤—Ä–∞—Ç transcript_id –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–Ω–æ–ø–æ–∫
return {
    "success": True,
    "transcript_id": saved_transcript.get("id") if saved_transcript else None,
    "text": transcription_result.text,
    # ...
}
```

#### 3. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ inline –æ–±—Ä–∞–±–æ—Ç–∫–∏
```
User sends audio (>1 min) ‚Üí PaidTranscriptionHandler
                          ‚Üì
Shows quote + payment ‚Üí User pays ‚Üí Transcription  
                    ‚Üì
Result with inline buttons ‚Üí User clicks action
                          ‚Üì
TranscriptProcessingHandler ‚Üí AIFormatter
                          ‚Üì
OpenAI processing ‚Üí New formatted transcript saved
```

### ‚úÖ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

#### –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ callback'–æ–≤
- `transcript_summary_{id}` ‚Üí –ö—Ä–∞—Ç–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —á–µ—Ä–µ–∑ OpenAI
- `transcript_todo_{id}` ‚Üí –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á —á–µ—Ä–µ–∑ OpenAI  
- `transcript_protocol_{id}` ‚Üí –ü—Ä–æ—Ç–æ–∫–æ–ª –≤—Å—Ç—Ä–µ—á–∏ —á–µ—Ä–µ–∑ OpenAI

#### –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Å–µ—Ä–≤–∏—Å—ã
- `TextProcessingService` - AI —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ OpenAI
- `TranscriptService` - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- `UserService` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞

#### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- ‚úÖ **–ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã** - –≥–æ—Ç–æ–≤—ã–µ –≤ `keyboards/transcript.py`
- ‚úÖ **–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏** - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ `main_handler.py`
- ‚úÖ **AI —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** - —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ `ai_formatter.py`
- ‚úÖ **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤** - –∫–∞–∂–¥—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç

### ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç
- ‚úÖ **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å** –∏–∑ –∞—Ä—Ö–∏–≤–Ω–æ–π –≤–µ—Ä—Å–∏–∏
- ‚úÖ **–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ —Å –ø–ª–∞—Ç–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π** - –∫–Ω–æ–ø–∫–∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
- ‚úÖ **AI –æ–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ OpenAI** - –≤—ã—Å–æ–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- ‚úÖ **–í—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è** - –¥–æ—Å—Ç—É–ø–Ω—ã –≤ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–Ω–æ–≤–∞ –º–æ–≥—É—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç—ã —á–µ—Ä–µ–∑ —É–¥–æ–±–Ω–æ–µ inline –º–µ–Ω—é!** üéâ 
# Исправление проблемы с HTML-парсингом в промптах

## Проблема

**Дата:** 12 июня 2025  
**Время:** 01:42 UTC  
**Критичность:** Высокая

### Описание ошибки

При повторной генерации изображений возникала ошибка парсинга HTML-сущностей в Telegram:

```
aiogram.exceptions.TelegramBadRequest: Telegram server says - Bad Request: can't parse entities: Unsupported start tag "tok" at byte offset 141
```

### Причина

Промпты содержали HTML-теги (например, `<TOK>` для LoRA-триггеров), которые Telegram пытался интерпретировать как HTML-разметку при использовании `parse_mode="HTML"`.

## Решение

### 1. Создание утилитарных функций

Добавлены функции в `app/shared/utils/telegram_utils.py`:

```python
def escape_html_for_telegram(text: str) -> str:
    """Экранирует HTML-символы для безопасного отображения в Telegram"""
    if not text:
        return ""
    return html.escape(text)

def format_prompt_for_display(prompt: str, max_length: int = 80) -> str:
    """Форматирует промпт для безопасного отображения в Telegram"""
    if not prompt:
        return "Не указан"
    
    escaped_prompt = escape_html_for_telegram(prompt)
    
    if len(escaped_prompt) > max_length:
        return f"{escaped_prompt[:max_length]}..."
    
    return escaped_prompt
```

### 2. Исправленные файлы

#### `app/handlers/gallery/management/regeneration.py`
- Добавлен импорт `format_prompt_for_display`
- Заменено прямое использование промпта на экранированную версию
- Исправлено использование `generation.result_urls` вместо `generation.image_url`

#### `app/handlers/generation/custom_prompt_handler.py`
- Добавлено экранирование промпта при отображении выбора соотношения сторон

#### `app/handlers/generation/generation_monitor.py`
- Добавлен импорт `format_prompt_for_display`
- Заменены все места использования промпта на экранированную версию

### 3. Деплои

Выполнено 4 деплоя для полного исправления:

1. **fix-help-20250612-065044** - основные исправления HTML-экранирования
2. **fix-help-20250612-065940** - добавление недостающих импортов
3. **fix-help-20250612-070622** - исправление использования `result_urls`
4. **fix-help-20250612-070957** - финальный деплой с исправлением синтаксиса

## Результат

✅ **Проблема полностью решена:**
- Промпты с HTML-тегами корректно отображаются в сообщениях
- Повторная генерация работает без ошибок парсинга
- Все места использования промптов защищены от HTML-инъекций
- Улучшена безопасность отображения пользовательского контента
- Бот успешно запускается без синтаксических ошибок

## Техническая информация

### Затронутые компоненты
- Система повторной генерации изображений
- Обработчики кастомных промптов
- Мониторинг генерации
- Утилиты для работы с Telegram

### Архитектурные улучшения
- Централизованное экранирование HTML через утилитарные функции
- Единообразное форматирование промптов во всех компонентах
- Защита от HTML-инъекций в пользовательском контенте

### Совместимость
- Обратная совместимость сохранена
- Существующие промпты отображаются корректно
- Новые промпты автоматически экранируются

## Мониторинг

После деплоя проверить:
- [x] Повторная генерация работает без ошибок
- [x] Промпты с HTML-тегами отображаются корректно
- [x] Нет ошибок парсинга в логах
- [x] Все типы генерации работают стабильно
- [x] Бот запускается без синтаксических ошибок

## Связанные задачи

- Исправление проблемы с повторной генерацией (REGENERATION_FIX.md)
- Улучшение безопасности отображения контента
- Стандартизация работы с HTML в Telegram-сообщениях

## Статус

**✅ ПОЛНОСТЬЮ РЕШЕНО** - 12 июня 2025, 02:10 UTC  
Все исправления развернуты, бот работает стабильно. 
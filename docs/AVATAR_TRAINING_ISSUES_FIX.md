# üö® –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º –æ–±—É—á–µ–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–æ–≤

## üìä –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–∏–ø –æ–±—É—á–µ–Ω–∏—è**
**–ü—Ä–æ–±–ª–µ–º–∞:** –í—ã–±—Ä–∞–Ω —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Ç–∏–ø, –Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø–æ—Ä—Ç—Ä–µ—Ç–Ω—ã–π
**–ü—Ä–∏—á–∏–Ω–∞:** –î–µ—Ñ–æ–ª—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ `training_type = "portrait"` –≤ –∫–æ–¥–µ

### 2. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–±—É—á–µ–Ω–∏—è**
**–ü—Ä–æ–±–ª–µ–º–∞:** 2000 steps –≤–º–µ—Å—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–ª—è —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞
**–ü—Ä–∏—á–∏–Ω–∞:** –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ—Ä—Ç—Ä–µ—Ç–Ω–æ–≥–æ —Ç—Ä–µ–Ω–µ—Ä–∞

### 3. **–û—à–∏–±–∫–∏ webhook**
**–ü—Ä–æ–±–ª–µ–º–∞:** "Failed to fetch training data" –∏ "Failed to download archive"
**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö –≤ FAL AI

### 4. **–¢–æ–ª—å–∫–æ 20 —à–∞–≥–æ–≤ –æ–±—É—á–µ–Ω–∏—è**
**–ü—Ä–æ–±–ª–µ–º–∞:** –û–±—É—á–µ–Ω–∏–µ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç—Å—è –Ω–∞ 20 —à–∞–≥–∞—Ö
**–ü—Ä–∏—á–∏–Ω–∞:** –û—à–∏–±–∫–∏ –≤ –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

## üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –æ–±—É—á–µ–Ω–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞ –≤ `app/handlers/avatar/training_production.py:85-90`:**
```python
# –ü–†–û–ë–õ–ï–ú–ù–´–ô –ö–û–î:
training_type = getattr(avatar, 'training_type', 'portrait')  # ‚Üê –í—Å–µ–≥–¥–∞ –ø–æ—Ä—Ç—Ä–µ—Ç–Ω—ã–π!
if hasattr(avatar, 'training_type') and avatar.training_type:
    training_type = avatar.training_type.value if hasattr(avatar.training_type, 'value') else str(avatar.training_type)
else:
    training_type = "portrait"  # ‚Üê –î–µ—Ñ–æ–ª—Ç –≤—Å–µ–≥–¥–∞ –ø–æ—Ä—Ç—Ä–µ—Ç–Ω—ã–π!
```

**–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï:**
```python
# –ü–æ–ª—É—á–∞–µ–º —Ç–∏–ø –æ–±—É—á–µ–Ω–∏—è –∏–∑ –∞–≤–∞—Ç–∞—Ä–∞ (–ò–°–ü–†–ê–í–õ–ï–ù–û)
if hasattr(avatar, 'training_type') and avatar.training_type:
    if hasattr(avatar.training_type, 'value'):
        training_type = avatar.training_type.value
    else:
        training_type = str(avatar.training_type)
    logger.info(f"üéØ –¢–∏–ø –æ–±—É—á–µ–Ω–∏—è –∏–∑ –ë–î: {training_type}")
else:
    # –ü–æ–ª—É—á–∞–µ–º –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è FSM –∫–∞–∫ fallback
    state_data = await state.get_data()
    training_type = state_data.get('training_type', 'portrait')
    logger.warning(f"‚ö†Ô∏è –¢–∏–ø –æ–±—É—á–µ–Ω–∏—è –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è: {training_type}")
```

### 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–∏–ø–∞ –æ–±—É—á–µ–Ω–∏—è –≤ –ë–î

**–ü—Ä–æ–±–ª–µ–º–∞:** –¢–∏–ø –æ–±—É—á–µ–Ω–∏—è –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞–≤–∞—Ç–∞—Ä–∞

**–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –≤ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞–≤–∞—Ç–∞—Ä–∞:**
```python
# –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞–≤–∞—Ç–∞—Ä–∞ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å training_type
avatar_data = {
    "name": name,
    "gender": gender,
    "training_type": training_type,  # ‚Üê –î–û–ë–ê–í–ò–¢–¨ –≠–¢–û
    "status": AvatarStatus.DRAFT
}
```

### 3. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –æ–±—É—á–µ–Ω–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞

**–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –≤ `app/core/config.py`:**
```python
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è (flux-pro-trainer)
FAL_PRESET_BALANCED = {
    "portrait": {"steps": 1000, "learning_rate": 0.0002},
    "general": {
        "iterations": 500,        # ‚Üê –ù–ï steps!
        "learning_rate": 1e-4,    # ‚Üê –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å
        "priority": "quality"     # ‚Üê –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∫–∞—á–µ—Å—Ç–≤–∞
    }
}
```

### 4. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ URL –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–±—É—á–µ–Ω–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞:** –ó–∞–≥–ª—É—à–∫–∞ URL `https://example.com/photos/{avatar_id}.zip`

**–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï:**
```python
# –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–π URL –∞—Ä—Ö–∏–≤–∞ —Å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º–∏
async with get_minio_service() as minio_service:
    training_data_url = await minio_service.get_avatar_photos_archive_url(avatar_id)
    
if not training_data_url:
    raise RuntimeError("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∞—Ä—Ö–∏–≤ —Å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º–∏")
```

## üöÄ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:
```bash
# 1. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º
chmod +x diagnose_avatar_training_issues.sh
./diagnose_avatar_training_issues.sh

# 2. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π
chmod +x fix_avatar_training_issues.sh
./fix_avatar_training_issues.sh

# 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤
sudo systemctl restart aisha-bot.service aisha-api.service
```

### –†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞:
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –æ–±—É—á–µ–Ω–∏—è
sudo journalctl -u aisha-bot.service -f | grep -E "(üéØ|training_type|—Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π)"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å webhook
sudo journalctl -u aisha-api.service -f | grep -E "(WEBHOOK|training_type)"

# –¢–µ—Å—Ç —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è
curl -X POST http://localhost:8000/api/v1/avatar/status_update?training_type=style \
  -H "Content-Type: application/json" \
  -d '{"request_id": "test_style", "status": "completed", "result": {"finetune_id": "test123"}}'
```

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### 1. –¢–µ—Å—Ç –≤—ã–±–æ—Ä–∞ —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞:
- –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∞–≤–∞—Ç–∞—Ä
- –í—ã–±—Ä–∞—Ç—å "üé® –•—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π" —Ç–∏–ø
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ª–æ–≥–∞—Ö: `üéØ –ó–∞–ø—É—Å–∫ –æ–±—É—á–µ–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–∞ ... —Å —Ç–∏–ø–æ–º: style`

### 2. –¢–µ—Å—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤:
- –õ–æ–≥–∏ –¥–æ–ª–∂–Ω—ã –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å: `üé® –•—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ`
- –ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å: `üé≠ –ü–æ—Ä—Ç—Ä–µ—Ç–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ`

### 3. –¢–µ—Å—Ç webhook –æ–±—Ä–∞–±–æ—Ç–∫–∏:
- Webhook –¥–æ–ª–∂–µ–Ω –ø—Ä–∏—Ö–æ–¥–∏—Ç—å —Å `training_type=style`
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–ª–∂–Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `flux-pro-trainer` –ª–æ–≥–∏–∫—É

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:
```bash
# –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Ç–∏–ø—ã –æ–±—É—á–µ–Ω–∏—è
sudo journalctl -u aisha-bot.service -f | grep -E "(üéØ.*style|üé®.*–•—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ)"

# –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å webhook –¥–ª—è —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö
sudo journalctl -u aisha-api.service -f | grep -E "(training_type=style|finetune_id)"

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–∏–ø–æ–≤ –æ–±—É—á–µ–Ω–∏—è
sudo journalctl -u aisha-bot.service --since "1 day ago" | grep -c "—Ç–∏–ø: style"
sudo journalctl -u aisha-bot.service --since "1 day ago" | grep -c "—Ç–∏–ø: portrait"
```

## üéØ –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

1. **‚úÖ –•—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Ç–∏–ø —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ**
2. **‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–±—É—á–µ–Ω–∏—è (iterations –≤–º–µ—Å—Ç–æ steps)**
3. **‚úÖ Webhook –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ç–∏–ø–æ–º**
4. **‚úÖ –û–±—É—á–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ —Å finetune_id**
5. **‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏**

---

**üöÄ –ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–æ–≤ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é!** 
# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã –∞–≤–∞—Ç–∞—Ä–æ–≤

## üìã –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –∞–≤–∞—Ç–∞—Ä–æ–≤ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å–æ–∑–¥–∞–≤–∞—Ç—å, –æ–±—É—á–∞—Ç—å –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ AI-–º–æ–¥–µ–ª–∏ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ª—É—á—à–∏—Ö –ø—Ä–∞–∫—Ç–∏–∫ –∏–∑ –∞—Ä—Ö–∏–≤–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞ —Å –∞–¥–∞–ø—Ç–∞—Ü–∏–µ–π –ø–æ–¥ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å FAL AI.

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

### Separation of Concerns
- **–ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö**: –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –º–µ–∂–¥—É `Avatar` –∏ `AvatarPhoto`
- **–°–µ—Ä–≤–∏—Å—ã**: –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ (DB, —Ñ–∞–π–ª—ã, –æ–±—É—á–µ–Ω–∏–µ)
- **–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏**: –ú–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —ç—Ç–∞–ø–æ–≤ workflow
- **–•—Ä–∞–Ω–∏–ª–∏—â–µ**: –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (PostgreSQL) –∏ —Ñ–∞–π–ª–æ–≤ (MinIO)

### –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –ë–î –∏ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ
- –ë—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è –¥–ª—è –≥—Ä—É–ø–ø–æ–≤–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–æ—Ç–æ
- –§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ –¥–ª—è —Ç—è–∂–µ–ª—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏ –ø–∞–≥–∏–Ω–∞—Ü–∏—è

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è
- –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ç–æ
- –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ø–æ —Ö–µ—à–∞–º
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ —Ä–∞–∑–º–µ—Ä –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤
- –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### –ú–æ–¥–µ–ª—å Avatar
```python
class Avatar(Base):
    __tablename__ = "avatars"
    
    # –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
    id: UUID
    user_id: UUID (FK to users)
    
    # –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    name: str                          # –ò–º—è –∞–≤–∞—Ç–∞—Ä–∞
    gender: AvatarGender              # MALE/FEMALE/OTHER
    avatar_type: AvatarType           # CHARACTER/STYLE/CUSTOM
    status: AvatarStatus              # –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª
    
    # FAL AI –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
    finetune_id: Optional[str]        # ID –º–æ–¥–µ–ª–∏ –≤ FAL AI
    training_progress: int            # 0-100%
    training_started_at: Optional[datetime]
    training_completed_at: Optional[datetime]
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±—É—á–µ–Ω–∏—è
    fal_mode: str                     # character/style/custom
    fal_iterations: int               # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Ç–µ—Ä–∞—Ü–∏–π
    fal_priority: str                 # quality/speed/balanced
    trigger_word: str                 # –¢—Ä–∏–≥–≥–µ—Ä-—Å–ª–æ–≤–æ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    lora_rank: int                    # –†–∞–Ω–≥ LoRA –∞–¥–∞–ø—Ç–µ—Ä–∞
    
    # –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    avatar_data: Dict                 # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    training_config: Dict             # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–±—É—á–µ–Ω–∏—è
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    photos_count: int                 # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–æ—Ç–æ
    generations_count: int            # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–π
    
    # –°–≤—è–∑–∏
    photos: List[AvatarPhoto]
```

### –ú–æ–¥–µ–ª—å AvatarPhoto
```python
class AvatarPhoto(Base):
    __tablename__ = "avatar_photos"
    
    # –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
    id: UUID
    avatar_id: UUID (FK to avatars)
    user_id: UUID (FK to users)
    
    # –•—Ä–∞–Ω–µ–Ω–∏–µ
    minio_key: str                    # –ü—É—Ç—å –≤ MinIO
    file_hash: str                    # SHA256 –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏
    
    # –ü–æ—Ä—è–¥–æ–∫ –∏ —Å—Ç–∞—Ç—É—Å
    upload_order: int                 # –ü–æ—Ä—è–¥–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏
    validation_status: PhotoValidationStatus
    
    # –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª–∞
    file_size: int
    width: Optional[int]
    height: Optional[int]
    format: str                       # jpg/png/webp
    
    # –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –∫–∞—á–µ—Å—Ç–≤–æ
    has_face: Optional[bool]          # –î–µ—Ç–µ–∫—Ü–∏—è –ª–∏—Ü–∞
    quality_score: Optional[float]    # –û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ 0-1
    validation_error: Optional[str]   # –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    photo_metadata: Dict
```

### –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –∞–≤–∞—Ç–∞—Ä–∞
```
DRAFT ‚Üí PHOTOS_UPLOADING ‚Üí READY_FOR_TRAINING ‚Üí TRAINING ‚Üí COMPLETED
  ‚Üì              ‚Üì                    ‚Üì             ‚Üì
ERROR ‚Üê‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
  ‚Üì
CANCELLED
```

## üèõÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–¥—É–ª–µ–π

### –°–µ—Ä–≤–∏—Å—ã (app/services/avatar/)

#### AvatarService (avatar_service.py)
**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å**: –û—Å–Ω–æ–≤–Ω–∞—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–∞–º–∏
```python
class AvatarService:
    # –°–æ–∑–¥–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º
    async def create_avatar(user_id: int) -> Avatar
    async def get_avatar(avatar_id: UUID) -> Optional[Avatar]
    async def update_avatar(avatar_id: UUID, data: Dict) -> Avatar
    async def delete_avatar(avatar_id: UUID) -> bool
    
    # Workflow —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    async def start_avatar_creation(user_id: int) -> Avatar
    async def finalize_avatar_creation(avatar_id: UUID) -> bool
    async def cancel_avatar_creation(avatar_id: UUID) -> bool
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ —Å–ø–∏—Å–∫–∏
    async def get_user_avatars(user_id: int) -> List[Avatar]
    async def get_avatar_statistics(avatar_id: UUID) -> Dict
```

#### PhotoService (photo_service.py)
**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å**: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º–∏ –∞–≤–∞—Ç–∞—Ä–æ–≤
```python
class PhotoService:
    # –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è
    async def upload_photo(avatar_id: UUID, photo_data: bytes) -> AvatarPhoto
    async def validate_photo(photo_data: bytes) -> ValidationResult
    async def check_duplicate(photo_hash: str, avatar_id: UUID) -> bool
    
    # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ
    async def get_avatar_photos(avatar_id: UUID) -> List[AvatarPhoto]
    async def delete_photo(photo_id: UUID) -> bool
    async def reorder_photos(avatar_id: UUID, photo_orders: List[int]) -> bool
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞
    async def process_photo_batch(avatar_id: UUID, photos: List[bytes]) -> List[AvatarPhoto]
    async def generate_thumbnails(photo_id: UUID) -> bool
```

#### TrainingService (training_service.py)
**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å**: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å FAL AI –¥–ª—è –æ–±—É—á–µ–Ω–∏—è
```python
class TrainingService:
    # –û–±—É—á–µ–Ω–∏–µ
    async def start_training(avatar_id: UUID) -> str  # finetune_id
    async def check_training_status(finetune_id: str) -> TrainingStatus
    async def cancel_training(finetune_id: str) -> bool
    
    # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    async def prepare_training_config(avatar_id: UUID) -> Dict
    async def upload_training_data(avatar_id: UUID) -> str  # data_url
    
    # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
    async def update_training_progress(avatar_id: UUID) -> None
    async def handle_training_completion(avatar_id: UUID) -> None
    async def handle_training_error(avatar_id: UUID, error: str) -> None
```

### –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ (app/handlers/avatar.py)

#### Workflow –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
```python
# –°–æ–∑–¥–∞–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–∞
@router.callback_query(F.data == "create_avatar")
async def start_avatar_creation(callback: CallbackQuery)

@router.callback_query(F.data.startswith("avatar_type_"))
async def select_avatar_type(callback: CallbackQuery)

@router.callback_query(F.data.startswith("avatar_gender_"))
async def select_avatar_gender(callback: CallbackQuery)

@router.message(F.text, StateFilter(AvatarStates.waiting_name))
async def process_avatar_name(message: Message)

# –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ
@router.message(F.photo, StateFilter(AvatarStates.uploading_photos))
async def handle_photo_upload(message: Message)

@router.callback_query(F.data.startswith("photo_action_"))
async def handle_photo_action(callback: CallbackQuery)

# –ì–∞–ª–µ—Ä–µ—è –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—è
@router.callback_query(F.data.startswith("gallery_"))
async def handle_gallery_navigation(callback: CallbackQuery)

@router.callback_query(F.data.startswith("avatar_card_"))
async def handle_avatar_card_action(callback: CallbackQuery)

# –û–±—É—á–µ–Ω–∏–µ
@router.callback_query(F.data.startswith("training_"))
async def handle_training_action(callback: CallbackQuery)
```

### –°–æ—Å—Ç–æ—è–Ω–∏—è FSM
```python
class AvatarStates(StatesGroup):
    # –°–æ–∑–¥–∞–Ω–∏–µ
    selecting_type = State()      # –í—ã–±–æ—Ä —Ç–∏–ø–∞ –∞–≤–∞—Ç–∞—Ä–∞
    selecting_gender = State()    # –í—ã–±–æ—Ä –ø–æ–ª–∞
    waiting_name = State()        # –í–≤–æ–¥ –∏–º–µ–Ω–∏
    
    # –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ
    uploading_photos = State()    # –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
    confirming_photos = State()   # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ñ–æ—Ç–æ
    
    # –û–±—É—á–µ–Ω–∏–µ
    configuring_training = State() # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—É—á–µ–Ω–∏—è
    training_in_progress = State() # –ü—Ä–æ—Ü–µ—Å—Å –æ–±—É—á–µ–Ω–∏—è
    
    # –ü—Ä–æ—Å–º–æ—Ç—Ä
    viewing_gallery = State()     # –ü—Ä–æ—Å–º–æ—Ç—Ä –≥–∞–ª–µ—Ä–µ–∏
    viewing_avatar = State()      # –ü—Ä–æ—Å–º–æ—Ç—Ä –∞–≤–∞—Ç–∞—Ä–∞
```

## üóÑÔ∏è –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö

### PostgreSQL (–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ)
- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–≤–∞—Ç–∞—Ä–∞—Ö
- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- –°–≤—è–∑–∏ –º–µ–∂–¥—É —Å—É—â–Ω–æ—Å—Ç—è–º–∏
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞

### MinIO (–§–∞–π–ª—ã)
```
avatars/
‚îú‚îÄ‚îÄ user_{user_id}/
‚îÇ   ‚îú‚îÄ‚îÄ avatar_{avatar_id}/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ photos/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ original/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ photo_001.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ photo_002.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ thumbnails/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ thumb_001.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ processed/
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ crop_001.jpg
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ training_data/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ training_set.zip
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ generated/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ gen_001.jpg
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ ...
```

## üîÑ Workflow –ø—Ä–æ—Ü–µ—Å—Å—ã

### 1. –°–æ–∑–¥–∞–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–∞
```mermaid
sequenceDiagram
    participant U as User
    participant H as Handler
    participant AS as AvatarService
    participant DB as Database
    
    U->>H: –ù–∞—á–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ
    H->>AS: create_avatar(user_id)
    AS->>DB: INSERT draft avatar
    DB-->>AS: avatar_id
    AS-->>H: Avatar(DRAFT)
    H-->>U: –ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞
    
    U->>H: –í—ã–±—Ä–∞—Ç—å —Ç–∏–ø
    H->>AS: set_avatar_type(avatar_id, type)
    AS->>DB: UPDATE avatar
    H-->>U: –ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ –ø–æ–ª–∞
    
    U->>H: –í—ã–±—Ä–∞—Ç—å –ø–æ–ª
    H->>AS: set_avatar_gender(avatar_id, gender)
    AS->>DB: UPDATE avatar
    H-->>U: –ó–∞–ø—Ä–æ—Å –∏–º–µ–Ω–∏
    
    U->>H: –í–≤–µ—Å—Ç–∏ –∏–º—è
    H->>AS: set_avatar_name(avatar_id, name)
    AS->>DB: UPDATE avatar status=PHOTOS_UPLOADING
    H-->>U: –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ
```

### 2. –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ç–æ
```mermaid
sequenceDiagram
    participant U as User
    participant H as Handler
    participant PS as PhotoService
    participant MinIO as MinIO
    participant DB as Database
    
    U->>H: –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ
    H->>PS: validate_photo(photo_data)
    PS-->>H: ValidationResult
    
    alt Valid Photo
        H->>PS: check_duplicate(photo_hash)
        PS->>DB: SELECT by hash
        
        alt Not Duplicate
            PS->>MinIO: upload_file(photo_data)
            PS->>DB: INSERT avatar_photo
            PS-->>H: AvatarPhoto
            H-->>U: –§–æ—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ
        else Duplicate
            H-->>U: –§–æ—Ç–æ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        end
    else Invalid Photo
        H-->>U: –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
    end
```

### 3. –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏
```mermaid
sequenceDiagram
    participant H as Handler
    participant TS as TrainingService
    participant FAL as FAL AI
    participant DB as Database
    
    H->>TS: start_training(avatar_id)
    TS->>DB: UPDATE status=READY_FOR_TRAINING
    TS->>TS: prepare_training_config()
    TS->>TS: upload_training_data()
    TS->>FAL: submit_finetune(config)
    FAL-->>TS: finetune_id
    TS->>DB: UPDATE finetune_id, status=TRAINING
    
    loop Training Progress
        TS->>FAL: check_status(finetune_id)
        FAL-->>TS: status, progress
        TS->>DB: UPDATE training_progress
    end
    
    FAL->>TS: Training Complete
    TS->>DB: UPDATE status=COMPLETED
```

## üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

### –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ç–æ
```python
class PhotoValidator:
    MAX_FILE_SIZE = 10 * 1024 * 1024  # 10MB
    ALLOWED_FORMATS = ['JPEG', 'PNG', 'WEBP']
    MIN_RESOLUTION = 512
    MAX_RESOLUTION = 4096
    MAX_PHOTOS_PER_AVATAR = 50
    MIN_PHOTOS_FOR_TRAINING = 5
    
    async def validate_photo(self, photo_data: bytes) -> ValidationResult:
        # –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞
        if len(photo_data) > self.MAX_FILE_SIZE:
            return ValidationResult(False, "–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π")
        
        # –§–æ—Ä–º–∞—Ç –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
        img = Image.open(io.BytesIO(photo_data))
        if img.format not in self.ALLOWED_FORMATS:
            return ValidationResult(False, "–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç")
        
        width, height = img.size
        if min(width, height) < self.MIN_RESOLUTION:
            return ValidationResult(False, "–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –Ω–∏–∑–∫–æ–µ")
        
        if max(width, height) > self.MAX_RESOLUTION:
            return ValidationResult(False, "–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–æ–µ")
        
        # –î–µ—Ç–µ–∫—Ü–∏—è –ª–∏—Ü–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        has_face = await self.detect_face(photo_data)
        if not has_face:
            return ValidationResult(False, "–õ–∏—Ü–æ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ")
        
        return ValidationResult(True, "OK")
```

### –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è
```python
async def check_duplicate(self, photo_data: bytes, avatar_id: UUID) -> bool:
    # –í—ã—á–∏—Å–ª—è–µ–º —Ö–µ—à
    file_hash = hashlib.sha256(photo_data).hexdigest()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ —Ç–µ–∫—É—â–µ–º –∞–≤–∞—Ç–∞—Ä–µ
    existing = await self.photo_repo.get_by_hash_and_avatar(file_hash, avatar_id)
    if existing:
        return True
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    user_photos = await self.photo_repo.get_user_photos_by_hash(file_hash, user_id)
    if user_photos:
        logger.warning(f"–î—É–±–ª–∏–∫–∞—Ç —Ñ–æ—Ç–æ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {file_hash}")
    
    return False
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞

### –ú–µ—Ç—Ä–∏–∫–∏
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –∞–≤–∞—Ç–∞—Ä–æ–≤
- –í—Ä–µ–º—è –æ–±—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–µ–π
- –£—Å–ø–µ—à–Ω–æ—Å—Ç—å –æ–±—É—á–µ–Ω–∏—è
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–π
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
```python
# –°–æ–±—ã—Ç–∏—è –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞
logger.info(f"Avatar created: user_id={user_id}, avatar_id={avatar_id}")
logger.info(f"Training started: avatar_id={avatar_id}, finetune_id={finetune_id}")
logger.info(f"Training completed: avatar_id={avatar_id}, duration={duration}")

# –û—à–∏–±–∫–∏
logger.error(f"Photo validation failed: {error_msg}")
logger.error(f"Training failed: avatar_id={avatar_id}, error={error}")

# –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
logger.debug(f"Photo upload time: {upload_time}ms")
logger.debug(f"Training progress: {progress}%")
```

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤–∞—Ç–∞—Ä–æ–≤
```python
class AvatarSettings:
    # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ñ–æ—Ç–æ
    MAX_PHOTO_SIZE = 10 * 1024 * 1024
    MAX_PHOTOS_PER_AVATAR = 50
    MIN_PHOTOS_FOR_TRAINING = 5
    
    # –§–æ—Ä–º–∞—Ç—ã
    ALLOWED_PHOTO_FORMATS = ['JPEG', 'PNG', 'WEBP']
    MIN_PHOTO_RESOLUTION = 512
    MAX_PHOTO_RESOLUTION = 4096
    
    # –û–±—É—á–µ–Ω–∏–µ
    DEFAULT_ITERATIONS = 500
    DEFAULT_PRIORITY = "quality"
    DEFAULT_LORA_RANK = 32
    
    # –•—Ä–∞–Ω–∏–ª–∏—â–µ
    AVATAR_BUCKET = "avatars"
    TRAINING_DATA_TTL = 7 * 24 * 3600  # 7 –¥–Ω–µ–π
    
    # FAL AI
    FAL_API_TIMEOUT = 300  # 5 –º–∏–Ω—É—Ç
    TRAINING_CHECK_INTERVAL = 30  # 30 —Å–µ–∫—É–Ω–¥
```

## üöÄ –ü–ª–∞–Ω—ã —Ä–∞–∑–≤–∏—Ç–∏—è

### –§–∞–∑–∞ 1: –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å ‚úÖ
- [x] –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö
- [x] –ë–∞–∑–æ–≤—ã–µ —Å–µ—Ä–≤–∏—Å—ã
- [x] –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è
- [x] –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ç–æ

### –§–∞–∑–∞ 2: –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
- [ ] Batch –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–µ–∑–∫–∞ –ª–∏—Ü
- [ ] –£–ª—É—á—à–µ–Ω–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –∫–∞—á–µ—Å—Ç–≤–∞
- [ ] –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

### –§–∞–∑–∞ 3: –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—è
- [ ] –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é
- [ ] A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
- [ ] –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã

### –§–∞–∑–∞ 4: –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
- [ ] –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- [ ] CDN –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- [ ] –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è 
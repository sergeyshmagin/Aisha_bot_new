# üéâ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï TELEGRAM POLLING –ö–û–ù–§–õ–ò–ö–¢–û–í

## üìã –ü—Ä–æ–±–ª–µ–º–∞

**–ò—Å—Ö–æ–¥–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è**: –ù–µ—Å–∫–æ–ª—å–∫–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –¥–µ–ª–∞–ª–∏ polling –∫ Telegram API, —á—Ç–æ –≤—ã–∑—ã–≤–∞–ª–æ –æ—à–∏–±–∫–∏:
```
Conflict: terminated by other getUpdates request
```

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è**

–°–æ–∑–¥–∞–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º —Ä–æ–ª–µ–π:

- **`aisha-bot-primary`** - –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–µ–ª–∞—é—â–∏–π polling
  - `BOT_MODE=polling`
  - `SET_POLLING=true`
  - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –≤—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç Telegram

- **`aisha-worker-1`** - background worker –±–µ–∑ polling
  - `BOT_MODE=worker`
  - `SET_POLLING=false`
  - –í—ã–ø–æ–ª–Ω—è–µ—Ç —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ (—Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∞–≤–∞—Ç–∞—Ä–æ–≤)

### 2. **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**

#### Docker Compose –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
```yaml
# docker-compose.bot.simple.yml
services:
  bot-primary:
    command: ["polling"]  # –ü–µ—Ä–µ–¥–∞–µ—Ç —Ä–µ–∂–∏–º –≤ entrypoint
    environment:
      - BOT_MODE=polling
      - SET_POLLING=true
      
  worker-1:
    command: ["worker"]   # –ü–µ—Ä–µ–¥–∞–µ—Ç —Ä–µ–∂–∏–º –≤ entrypoint
    environment:
      - BOT_MODE=worker
      - SET_POLLING=false
```

#### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á—Ç–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
```python
# app/core/config.py
TELEGRAM_TOKEN: str = Field(default="test_token", env="TELEGRAM_BOT_TOKEN")
```

#### –õ–æ–≥–∏–∫–∞ –∑–∞–ø—É—Å–∫–∞ –≤ main.py
```python
if BOT_MODE == "worker":
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ background worker –±–µ–∑ polling
    from app.workers.background_worker import BackgroundWorker
    worker = BackgroundWorker()
    await worker.start()
    
elif BOT_MODE == "polling":
    if SET_POLLING:
        # –¢–æ–ª—å–∫–æ primary –±–æ—Ç –¥–µ–ª–∞–µ—Ç polling
        await dp.start_polling(bot_instance)
```

### 3. **–†–µ–∑—É–ª—å—Ç–∞—Ç**

#### ‚úÖ –£—Å–ø–µ—à–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:
- **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**: –û–¥–∏–Ω primary + workers –±–µ–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
- **Entrypoint**: –ü—Ä–∞–≤–∏–ª—å–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ä–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã
- **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**: –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è
- **–ú–∏–≥—Ä–∞—Ü–∏–∏**: –í—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- **–ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è**: Redis –∏ PostgreSQL —Ä–∞–±–æ—Ç–∞—é—Ç

#### üîß –¢—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è:
- **–¢–æ–∫–µ–Ω Telegram**: –ù—É–∂–µ–Ω –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω –æ—Ç @BotFather
- **Worker –º–æ–¥—É–ª—å**: –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ `app.workers.background_worker`

## üìä –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤

```bash
NAMES                 STATUS
aisha-bot-primary     Restarting (—Ç–æ–ª—å–∫–æ –∏–∑-–∑–∞ —Ç–æ–∫–µ–Ω–∞)
aisha-worker-1        Restarting (—Ç–æ–ª—å–∫–æ –∏–∑-–∑–∞ —Ç–æ–∫–µ–Ω–∞)
aisha-webhook-api-1   Up (healthy)
aisha-webhook-api-2   Up (healthy)
```

## üîç –õ–æ–≥–∏ (–±–µ–∑ –æ—à–∏–±–æ–∫ polling)

```
[INFO] üöÄ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ - –≠–∫–∑–µ–º–ø–ª—è—Ä: bot-primary
[INFO] üìã –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã: polling
[INFO] üì° Polling —Ä–∞–∑—Ä–µ—à–µ–Ω: True
‚úÖ Redis –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ
‚úÖ PostgreSQL –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ
‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ
[INFO] ü§ñ –ó–∞–ø—É—Å–∫ –≤ —Ä–µ–∂–∏–º–µ polling
‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: Token is invalid!  # <- –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞
```

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ü–æ–ª—É—á–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω** –æ—Ç @BotFather
2. **–û–±–Ω–æ–≤–∏—Ç—å .env —Ñ–∞–π–ª** —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º
3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–æ–¥—É–ª—å worker** –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
4. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –±–æ—Ç–∞** –∫–æ–º–∞–Ω–¥–æ–π `/start`

## üî• –ö–ª—é—á–µ–≤—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è

- ‚úÖ **–ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã polling –ø–æ–ª–Ω–æ—Å—Ç—å—é —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã**
- ‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ primary + workers**
- ‚úÖ **–ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Docker Compose**
- ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è**
- ‚úÖ **–°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤**

**–û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞!** –¢–µ–ø–µ—Ä—å —Ç–æ–ª—å–∫–æ –Ω—É–∂–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞. 

## üîí –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å

- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞**
- **–£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤**

## üì¶ –£–ø—Ä–∞–≤–ª—è–µ–º–æ—Å—Ç—å

- **–õ–µ–≥–∫–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ worker —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤**

## üõ†Ô∏è –û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ

- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ**

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –æ—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞:
```bash
docker ps --format "table {{.Names}}\t{{.Status}}"
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤:
```bash
docker logs aisha-bot-primary --tail 20
```

### –¢–µ—Å—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞:
```bash
docker exec aisha-bot-primary touch /app/storage/temp/test.ogg
docker exec aisha-bot-primary rm /app/storage/temp/test.ogg
```

### –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ volumes:
```bash
docker volume ls | grep aisha-backend
```

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ü—Ä–æ–±–ª–µ–º—ã —Å Telegram polling –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º–∏ –∏ –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ storage –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ—à–µ–Ω—ã. –°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å:

- **–°—Ç–∞–±–∏–ª—å–Ω–∞**: –û–¥–∏–Ω —ç–∫–∑–µ–º–ø–ª—è—Ä –¥–µ–ª–∞–µ—Ç polling, –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ workers
- **–ù–∞–¥–µ–∂–Ω–∞**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—É—Å–∫–µ
- **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–∞**: –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ worker —ç–∫–∑–µ–º–ø–ª—è—Ä—ã
- **–£—Å—Ç–æ–π—á–∏–≤–∞**: Docker volumes —Å–æ—Ö—Ä–∞–Ω—è—é—Ç –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤

**–û—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞**: Telegram Bot API –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã, –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ! 
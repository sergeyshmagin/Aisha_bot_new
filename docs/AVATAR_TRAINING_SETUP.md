# üé≠ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∏—Å—Ç–µ–º—ã –æ–±—É—á–µ–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–æ–≤

## üìã –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–≤–∞ —Ç–∏–ø–∞ –æ–±—É—á–µ–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–æ–≤ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –≤—ã–±–æ—Ä–æ–º API:

- **üé≠ –ü–æ—Ä—Ç—Ä–µ—Ç–Ω—ã–π —Å—Ç–∏–ª—å** ‚Üí `fal-ai/flux-lora-portrait-trainer`
- **üé® –•—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Å—Ç–∏–ª—å** ‚Üí `fal-ai/flux-pro-trainer`

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### 1. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```env
# FAL AI API
FAL_API_KEY=your_fal_api_key_here
FAL_WEBHOOK_URL=https://yourdomain.com/webhook/fal/status

# –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º (–æ—Ç–∫–ª—é—á–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ FAL AI)
AVATAR_TEST_MODE=true

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ webhook —Å–∏–º—É–ª—è—Ü–∏–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
FAL_ENABLE_WEBHOOK_SIMULATION=true
FAL_MOCK_TRAINING_DURATION=30

# Telegram Bot
TELEGRAM_TOKEN=your_telegram_bot_token
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –æ–±—É—á–µ–Ω–∏—è

–í `app/core/config.py` –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø—Ä–µ—Å–µ—Ç—ã –∫–∞—á–µ—Å—Ç–≤–∞:

```python
# –ë—ã—Å—Ç—Ä–æ–µ –æ–±—É—á–µ–Ω–∏–µ (3-5 –º–∏–Ω—É—Ç)
FAL_PRESET_FAST = {
    "portrait": {"steps": 500, "learning_rate": 0.0003},
    "general": {"iterations": 200, "learning_rate": 2e-4, "priority": "speed"}
}

# –°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ (5-15 –º–∏–Ω—É—Ç)
FAL_PRESET_BALANCED = {
    "portrait": {"steps": 1000, "learning_rate": 0.0002},
    "general": {"iterations": 500, "learning_rate": 1e-4, "priority": "quality"}
}

# –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ (15-30 –º–∏–Ω—É—Ç)
FAL_PRESET_QUALITY = {
    "portrait": {"steps": 2500, "learning_rate": 0.0001},
    "general": {"iterations": 1000, "learning_rate": 5e-5, "priority": "quality"}
}
```

## üöÄ –ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
pip install -r requirements.txt
```

### 2. –ó–∞–ø—É—Å–∫ Telegram –±–æ—Ç–∞

```bash
python -m app.main
```

### 3. –ó–∞–ø—É—Å–∫ API —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è webhook

```bash
python run_api_server.py
```

–ò–ª–∏ —á–µ—Ä–µ–∑ uvicorn:

```bash
uvicorn app.api_server:app --host 0.0.0.0 --port 8000 --reload
```

## üîÑ Workflow –æ–±—É—á–µ–Ω–∏—è

### 1. –í—ã–±–æ—Ä —Ç–∏–ø–∞ –æ–±—É—á–µ–Ω–∏—è

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç —Ç–∏–ø –∞–≤–∞—Ç–∞—Ä–∞:
- **–ü–æ—Ä—Ç—Ä–µ—Ç–Ω—ã–π** ‚Üí –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –ª—é–¥–µ–π
- **–•—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π** ‚Üí —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –¥–ª—è –ª—é–±–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞

### 2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä API

```python
if training_type == "portrait":
    # üé≠ Flux LoRA Portrait Trainer
    endpoint = "fal-ai/flux-lora-portrait-trainer"
    config = {
        "trigger_phrase": f"TOK_{avatar_id}",
        "steps": preset["steps"],
        "learning_rate": preset["learning_rate"],
        "multiresolution_training": True,
        "subject_crop": True,
        "create_masks": True
    }
else:
    # üé® Flux Pro Trainer  
    endpoint = "fal-ai/flux-pro-trainer"
    config = {
        "trigger_word": f"TOK_{avatar_id}",
        "iterations": preset["iterations"],
        "learning_rate": preset["learning_rate"],
        "auto_captioning": True,
        "create_masks": True
    }
```

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤

1. **–û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ –æ–±—É—á–µ–Ω–∏–µ** ‚Üí —Å—Ç–∞—Ç—É—Å `TRAINING`
2. **–ü–æ–ª—É—á–µ–Ω–∏–µ webhook** ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
3. **–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –æ–±—É—á–µ–Ω–∏—è** ‚Üí —Å—Ç–∞—Ç—É—Å `COMPLETED` + —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

## üì° Webhook —Å–∏—Å—Ç–µ–º–∞

### Endpoint

```
POST /webhook/fal/status
```

### –§–æ—Ä–º–∞—Ç webhook –æ—Ç FAL AI

```json
{
    "request_id": "req_123456789",
    "status": "completed",
    "progress": 100,
    "training_type": "portrait",
    "result": {
        "diffusers_lora_file": {
            "url": "https://fal.ai/files/model.safetensors",
            "file_name": "avatar_model.safetensors"
        }
    }
}
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ webhook

1. **–ü–æ–ª—É—á–µ–Ω–∏–µ webhook** ‚Üí –±—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç `200 OK`
2. **–§–æ–Ω–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ë–î
3. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** ‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram

## üß™ –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º

–ü—Ä–∏ `AVATAR_TEST_MODE=true`:

- ‚ùå –†–µ–∞–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ FAL AI **–Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è**
- ‚úÖ –ò–º–∏—Ç–∞—Ü–∏—è –æ–±—É—á–µ–Ω–∏—è —Å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é
- ‚úÖ –°–∏–º—É–ª—è—Ü–∏—è webhook –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è UX
- ‚úÖ –ü–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ –∑–∞—Ç—Ä–∞—Ç

### –õ–æ–≥–∏ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞

```
üß™ –¢–ï–°–¢ –†–ï–ñ–ò–ú: –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É –Ω–∞ –æ–±—É—á–µ–Ω–∏–µ –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∞ abc123, —Ç–∏–ø: portrait
üß™ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π request_id: test_abc123_def456
üß™ –ò–º–∏—Ç–∞—Ü–∏—è –æ–±—É—á–µ–Ω–∏—è portrait, –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥
üß™ –¢–µ—Å—Ç–æ–≤—ã–π webhook –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω: 200
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### Health check

```bash
curl http://localhost:8000/health
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –æ–±—É—á–µ–Ω–∏—è

```python
from app.services.avatar.fal_training_service import FALTrainingService

service = FALTrainingService()
status = await service.check_training_status(request_id, training_type)
```

## üîß Troubleshooting

### 1. Webhook –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `FAL_WEBHOOK_URL` –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ API —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—Ç—É
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å URL –∏–∑–≤–Ω–µ (ngrok –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)

### 2. –û—à–∏–±–∫–∏ FAL API

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `FAL_API_KEY`
- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —É –≤–∞—Å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤ –Ω–∞ FAL AI
- –í–∫–ª—é—á–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏: `AVATAR_TEST_MODE=true`

### 3. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `TELEGRAM_TOKEN`
- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –±–æ—Ç –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ API —Å–µ—Ä–≤–µ—Ä–∞

## üìà –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –í—Ä–µ–º—è –æ–±—É—á–µ–Ω–∏—è

| –¢–∏–ø | –ü—Ä–µ—Å–µ—Ç | –í—Ä–µ–º—è | –ö–∞—á–µ—Å—Ç–≤–æ |
|-----|--------|-------|----------|
| –ü–æ—Ä—Ç—Ä–µ—Ç–Ω—ã–π | Fast | 3-5 –º–∏–Ω | ‚≠ê‚≠ê‚≠ê |
| –ü–æ—Ä—Ç—Ä–µ—Ç–Ω—ã–π | Balanced | 5-15 –º–∏–Ω | ‚≠ê‚≠ê‚≠ê‚≠ê |
| –ü–æ—Ä—Ç—Ä–µ—Ç–Ω—ã–π | Quality | 15-30 –º–∏–Ω | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê |
| –•—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π | Fast | 5-10 –º–∏–Ω | ‚≠ê‚≠ê‚≠ê |
| –•—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π | Balanced | 10-20 –º–∏–Ω | ‚≠ê‚≠ê‚≠ê‚≠ê |
| –•—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π | Quality | 20-45 –º–∏–Ω | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê |

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

- **–ü–æ—Ä—Ç—Ä–µ—Ç–Ω—ã–µ –∞–≤–∞—Ç–∞—Ä—ã**: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–ª—è —Å–µ–ª—Ñ–∏ –∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –ª—é–¥–µ–π
- **–•—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∞–≤–∞—Ç–∞—Ä—ã**: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–ª—è —Å—Ç–∏–ª–µ–π, –æ–±—ä–µ–∫—Ç–æ–≤, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
- **–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º**: –≤—Å–µ–≥–¥–∞ —Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–∞–∫—à–Ω 
# –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

## 1. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ –∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –∫–æ–¥–∞

### 1.1 –ú–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- –ö–∞–∂–¥—ã–π –º–æ–¥—É–ª—å –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å `__init__.py`
- –°–µ—Ä–≤–∏—Å—ã –≤ `services/`, –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤ `handlers/`
- –£—Ç–∏–ª–∏—Ç—ã –≤ `utils/`, –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤ `core/`
- –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö –≤ `models/`

### 1.2 –ò–º–µ–Ω–æ–≤–∞–Ω–∏–µ
- –ö–ª–∞—Å—Å—ã: PascalCase (–Ω–∞–ø—Ä–∏–º–µ—Ä, `TranscriptService`)
- –ú–µ—Ç–æ–¥—ã –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ: snake_case (–Ω–∞–ø—Ä–∏–º–µ—Ä, `process_audio`)
- –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã: UPPER_CASE (–Ω–∞–ø—Ä–∏–º–µ—Ä, `MAX_RETRIES`)
- –ü—Ä–∏–≤–∞—Ç–Ω—ã–µ –º–µ—Ç–æ–¥—ã: —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º `_` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `_handle_audio`)

## 2. –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ

### 2.1 –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã
- –ò—Å–ø–æ–ª—å–∑—É–µ–º `async/await` –¥–ª—è –≤—Å–µ—Ö I/O –æ–ø–µ—Ä–∞—Ü–∏–π
- –ò–∑–±–µ–≥–∞–µ–º –±–ª–æ–∫–∏—Ä—É—é—â–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –≤ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–º –∫–æ–¥–µ
- –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã –¥–ª—è —Ä–µ—Å—É—Ä—Å–æ–≤
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏—è –≤ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–º –∫–æ–¥–µ

### 2.2 –ü—Ä–∏–º–µ—Ä—ã
```python
# –ü—Ä–∞–≤–∏–ª—å–Ω–æ
async def process_data():
    async with get_session() as session:
        result = await service.process(session)
        return result

# –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ
async def process_data():
    session = get_session()  # –ë–ª–æ–∫–∏—Ä—É—é—â–∏–π –≤—ã–∑–æ–≤
    result = service.process(session)  # –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≤—ã–∑–æ–≤
    return result
```

## 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### 3.1 –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∫ –ª–æ–≥–∞–º (–ø—Ä–µ—Ñ–∏–∫—Å—ã, ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
- –†–∞–∑–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π
- –õ–æ–≥–∏—Ä—É–µ–º –≤—Å–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è —Å –ø–æ–ª–Ω—ã–º —Å—Ç–µ–∫–æ–º

```python
# –ü—Ä–∏–º–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logger.info(f"[AUDIO] –ù–∞—á–∞–ª–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–ª—è user_id={user_id}")
logger.error(f"[AUDIO] –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏: {error}", exc_info=True)
```

### 3.2 –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –æ—à–∏–±–∫–∏
- –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- –õ–æ–≥–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª–∏ –æ—à–∏–±–æ–∫

```python
try:
    result = await process_data()
except ValidationError as e:
    logger.error(f"[VALIDATION] –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏: {e}")
    await message.reply("‚ùå –û—à–∏–±–∫–∞ –≤ –¥–∞–Ω–Ω—ã—Ö")
except DatabaseError as e:
    logger.error(f"[DB] –û—à–∏–±–∫–∞ –ë–î: {e}")
    await message.reply("‚ùå –û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö")
except Exception as e:
    logger.exception(f"[UNKNOWN] –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞: {e}")
    await message.reply("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞")
```

## 4. –¢–∏–ø–∏–∑–∞—Ü–∏—è –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

### 4.1 Pydantic –º–æ–¥–µ–ª–∏
- –ò—Å–ø–æ–ª—å–∑—É–µ–º Pydantic –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
- –î–æ–±–∞–≤–ª—è–µ–º –æ–ø–∏—Å–∞–Ω–∏—è –ø–æ–ª–µ–π
- –ò—Å–ø–æ–ª—å–∑—É–µ–º Field –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–µ–º –º–æ–¥–µ–ª–∏

```python
class TranscriptResult(BaseModel):
    """–ú–æ–¥–µ–ª—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞"""
    id: str = Field(..., description="–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä")
    text: str = Field(..., min_length=1, description="–¢–µ–∫—Å—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞")
    metadata: Dict[str, Any] = Field(default_factory=dict)
```

### 4.2 –ê–Ω–Ω–æ—Ç–∞—Ü–∏–∏ —Ç–∏–ø–æ–≤
- –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ –¥–ª—è –≤—Å–µ—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- –£–∫–∞–∑—ã–≤–∞–µ–º –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
- –ò—Å–ø–æ–ª—å–∑—É–µ–º Optional –¥–ª—è –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–µ–º —Ç–∏–ø—ã

```python
async def process_audio(
    audio_data: bytes,
    user_id: int,
    options: Optional[Dict[str, Any]] = None
) -> AudioResult:
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ"""
    pass
```

## 5. –†–∞–±–æ—Ç–∞ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö

### 5.1 –°–µ—Å—Å–∏–∏ –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ —É–ø—Ä–∞–≤–ª—è–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏
- –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–µ—Å—Å–∏–∏ –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—à–∏–±–∫–∏ –ë–î

```python
async with get_session() as session:
    try:
        async with session.begin():
            result = await service.process(session)
            return result
    except SQLAlchemyError as e:
        logger.error(f"[DB] –û—à–∏–±–∫–∞: {e}")
        raise
```

### 5.2 –ú–∏–≥—Ä–∞—Ü–∏–∏
- –ò—Å–ø–æ–ª—å–∑—É–µ–º Alembic –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π
- –í–µ—Ä—Å–∏–æ–Ω–∏—Ä—É–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏
- –¢–µ—Å—Ç–∏—Ä—É–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏
- –î–µ–ª–∞–µ–º –±—ç–∫–∞–ø –ø–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏–µ–π

### 5.3 –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –æ—Ç BaseService ‚ö†Ô∏è

**–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û**: –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–µ—Ä–≤–∏—Å–æ–≤, –Ω–∞—Å–ª–µ–¥—É—é—â–∏—Ö—Å—è –æ—Ç `BaseService`, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞–π—Ç–µ `session` –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –±–∞–∑–æ–≤–æ–≥–æ –∫–ª–∞—Å—Å–∞.

#### ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û:
```python
class MyService(BaseService):
    def __init__(self, session: AsyncSession):
        super().__init__()  # ‚ùå –û–®–ò–ë–ö–ê: missing session
        self.session = session
```

#### ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û:
```python
class MyService(BaseService):
    def __init__(self, session: AsyncSession):
        super().__init__(session)  # ‚úÖ –ü–µ—Ä–µ–¥–∞–µ–º session
        self.session = session
```

#### –ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è BaseService:
1. **–í—Å–µ —Å–µ—Ä–≤–∏—Å—ã, —Ä–∞–±–æ—Ç–∞—é—â–∏–µ —Å –ë–î** - –Ω–∞—Å–ª–µ–¥—É—é—Ç—Å—è –æ—Ç `BaseService`
2. **–£—Ç–∏–ª–∏—Ç–∞—Ä–Ω—ã–µ –∫–ª–∞—Å—Å—ã** (–∫–ª–∏–µ–Ω—Ç—ã API, –ø–æ–º–æ—â–Ω–∏–∫–∏) - –ù–ï –Ω–∞—Å–ª–µ–¥—É—é—Ç—Å—è –æ—Ç `BaseService`
3. **–í—Å–µ–≥–¥–∞ –ø–µ—Ä–µ–¥–∞–≤–∞–π—Ç–µ session** –≤ `super().__init__(session)`
4. **–¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤** –≤ unit-—Ç–µ—Å—Ç–∞—Ö

#### –ü—Ä–∏–º–µ—Ä—ã –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏:
```python
# ‚úÖ –ù–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –æ—Ç BaseService (—Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ë–î)
class UserService(BaseService):
    def __init__(self, session: AsyncSession):
        super().__init__(session)

class AvatarService(BaseService): 
    def __init__(self, session: AsyncSession):
        super().__init__(session)

# ‚úÖ –ù–ï –Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –æ—Ç BaseService (—É—Ç–∏–ª–∏—Ç–∞—Ä–Ω—ã–π –∫–ª–∞—Å—Å)
class FalAIClient:
    def __init__(self):
        self.logger = get_logger(__name__)

class EmailSender:
    def __init__(self):
        self.smtp_config = get_smtp_config()
```

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ —Ç–µ—Å—Ç–∞—Ö:
```python
def test_service_creation():
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —á—Ç–æ —Å–µ—Ä–≤–∏—Å —Å–æ–∑–¥–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫"""
    session = Mock(spec=AsyncSession)
    
    # –≠—Ç–æ –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –æ—à–∏–±–æ–∫
    service = MyService(session)
    assert service.session is session
```

#### –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏:
- `super().__init__()` –±–µ–∑ session ‚Üí `TypeError: missing positional argument`
- –ù–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –æ—Ç BaseService –¥–ª—è API –∫–ª–∏–µ–Ω—Ç–æ–≤ ‚Üí –õ–∏—à–Ω—è—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å
- –ó–∞–±—ã—Ç–æ–µ –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –¥–ª—è DB —Å–µ—Ä–≤–∏—Å–æ–≤ ‚Üí –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –±–∞–∑–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

## 6. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### 6.1 –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- –•—Ä–∞–Ω–∏–º —Å–µ–∫—Ä–µ—Ç—ã –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
- –ù–µ –ª–æ–≥–∏—Ä—É–µ–º —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- –í–∞–ª–∏–¥–∏—Ä—É–µ–º –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

### 6.2 –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
- –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
- –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–∫–µ–Ω—ã
- –ó–∞—â–∏—â–∞–µ–º API endpoints
- –õ–æ–≥–∏—Ä—É–µ–º –ø–æ–ø—ã—Ç–∫–∏ –¥–æ—Å—Ç—É–ø–∞

## 7. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 7.1 Unit-—Ç–µ—Å—Ç—ã
- –ü–æ–∫—Ä—ã–≤–∞–µ–º –∫–æ–¥ —Ç–µ—Å—Ç–∞–º–∏
- –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∏–∫—Å—Ç—É—Ä—ã
- –ú–æ–∫–∞–µ–º –≤–Ω–µ—à–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- –¢–µ—Å—Ç–∏—Ä—É–µ–º –≥—Ä–∞–Ω–∏—á–Ω—ã–µ —Å–ª—É—á–∞–∏

### 7.2 –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
- –¢–µ—Å—Ç–∏—Ä—É–µ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–±–æ—Ç—É —Å –ë–î
- –¢–µ—Å—Ç–∏—Ä—É–µ–º API endpoints
- –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫

## 8. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### 8.1 Docstrings
- –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–µ–º –≤—Å–µ –ø—É–±–ª–∏—á–Ω—ã–µ –º–µ—Ç–æ–¥—ã
- –û–ø–∏—Å—ã–≤–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
- –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö

### 8.2 README –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å README
- –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–µ–º –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É
- –û–ø–∏—Å—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
- –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–º–µ—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

## 9. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

### 9.1 –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
- –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î
- –ú–∏–Ω–∏–º–∏–∑–∏—Ä—É–µ–º —Å–µ—Ç–µ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã
- –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—É–ª—ã —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

### 9.2 –†–µ—Å—É—Ä—Å—ã
- –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º —Ä–µ—Å—É—Ä—Å—ã
- –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã
- –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–º –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

## 10. CI/CD

### 10.1 –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º CI/CD –ø–∞–π–ø–ª–∞–π–Ω—ã
- –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–µ–º —Ç–µ—Å—Ç—ã
- –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞
- –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–µ–º –¥–µ–ø–ª–æ–π

### 10.2 –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–º –æ—à–∏–±–∫–∏
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –º–µ—Ç—Ä–∏–∫–∏
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∞–ª–µ—Ä—Ç—ã

## UX/UI –ü–∞—Ç—Ç–µ—Ä–Ω—ã

### –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—è

1. **Inline-–º–µ–Ω—é**
   - –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ InlineKeyboardMarkup
   - –ö–∞–∂–¥–∞—è –∫–Ω–æ–ø–∫–∞ –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏
   - –≠–º–æ–¥–∑–∏ –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è
   - Callback data –≤ —Ñ–æ—Ä–º–∞—Ç–µ "section_action"

2. **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**
   - –ü—Ä–∏ /start –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω
   - –õ–æ–≥–∏—Ä—É–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—à–∏–±–∫–∏ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏

3. **–ü–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É –º–µ–Ω—é**
   - –ò—Å–ø–æ–ª—å–∑—É–µ–º edit_message_text –≤–º–µ—Å—Ç–æ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
   - –í—Å–ø–ª—ã–≤–∞—é—â–∏–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π
   - –ö—Ä–∞—Ç–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–µ—Ä–µ—Ö–æ–¥–µ
   - –í–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —á–µ—Ä–µ–∑ /start

4. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**
   - –õ–æ–≥–∏—Ä—É–µ–º –≤—Å–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
   - –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –¥–µ–π—Å—Ç–≤–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

### –ü—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞

```python
# –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é (–∞–∫—Ç—É–∞–ª—å–Ω—ã–π –ø—Ä–∏–º–µ—Ä)
def get_main_menu() -> InlineKeyboardMarkup:
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton("üé§ –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è", callback_data="transcribe_menu")],
        [InlineKeyboardButton("üñº –ì–∞–ª–µ—Ä–µ—è", callback_data="business_gallery")],
        [InlineKeyboardButton("üßë‚Äçüé® –ê–≤–∞—Ç–∞—Ä—ã", callback_data="business_avatar")],
        [InlineKeyboardButton("‚ùì –ü–æ–º–æ—â—å", callback_data="help")]
    ])

# –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
@router.message(Command("start"))
async def cmd_start(message: Message, state: FSMContext):
    try:
        async with get_user_service() as user_service:
            user = await user_service.get_user_by_telegram_id(message.from_user.id)
            if not user:
                user = await user_service.create_user(...)
                logger.info(f"–°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user.telegram_id}")
            await message.answer("üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!", reply_markup=get_main_menu())
    except Exception as e:
        logger.exception("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏")
        await message.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞...")

# –ü–µ—Ä–µ—Ö–æ–¥ –º–µ–∂–¥—É –º–µ–Ω—é
# @router.callback_query(F.data == "business_menu")  # LEGACY
# async def show_business_menu(call: CallbackQuery):
#     await call.answer("üîÑ –ü–µ—Ä–µ—Ö–æ–¥...", show_alert=False)
#     await call.message.edit_text(
#         "ü§ñ –ë–∏–∑–Ω–µ—Å-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç",
#         reply_markup=get_business_menu()
#     )

# –°—Ü–µ–Ω–∞—Ä–∏–π —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏
@router.callback_query(F.data == "transcribe_menu")
async def show_transcribe_menu(call: CallbackQuery, state: FSMContext):
    """
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏ (–æ–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ –∏ —Ç–µ–∫—Å—Ç–∞).
    """
    from aisha_v2.app.handlers.transcript_main import TranscriptMainHandler
    handler = TranscriptMainHandler()
    await handler._handle_transcribe_command(call.message, state)

# FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞
class TranscribeStates(StatesGroup):
    menu = State()
    waiting_audio = State()
    waiting_text = State()
    processing = State()
    result = State()
    format_selection = State()
    error = State()

# –ü—Ä–∏–º–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞—É–¥–∏–æ –∏ .txt —á–µ—Ä–µ–∑ TranscriptProcessingHandler —Å–º. –≤ aisha_v2/app/handlers/transcript_processing.py

## Best practices: —Å–µ—Ä–≤–∏—Å—ã, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å

### 1. –í—ã–Ω–µ—Å–µ–Ω–∏–µ headers –∏ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è —á–∞—Å—Ç–µ–π
- –í—Å–µ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è headers –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö API (OpenAI, Backend –∏ –¥—Ä.) –≤—ã–Ω–æ—Å–∏—Ç—å –≤ shared/utils/openai.py, shared/utils/backend.py –∏ —Ç.–¥.
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏-—É—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è headers:

```python
from aisha_v2.app.shared.utils.openai import get_openai_headers
headers = get_openai_headers(settings.OPENAI_API_KEY)

from aisha_v2.app.shared.utils.backend import get_backend_headers
headers = get_backend_headers(settings.BACKEND_API_KEY)
```

### 2. –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å MinIO
- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å MinIO (–∑–∞–≥—Ä—É–∑–∫–∞, —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ, presigned URL) ‚Äî —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π StorageService.
- –ü—Ä—è–º–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ Minio –∏ sync-–æ–ø–µ—Ä–∞—Ü–∏–∏ –∑–∞–ø—Ä–µ—â–µ–Ω—ã.

```python
async with StorageService() as storage:
    await storage.upload_file(bucket, file_path, user_id)
    url = await storage.generate_presigned_url(bucket, object_name, expires=3600)
```

### 3. Docstring –∏ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏
- –í—Å–µ –ø—É–±–ª–∏—á–Ω—ã–µ –º–µ—Ç–æ–¥—ã —Å–µ—Ä–≤–∏—Å–æ–≤ –∏ —É—Ç–∏–ª–∏—Ç –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å docstring –∏ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ —Ç–∏–ø–æ–≤.
- –ü—Ä–∏–º–µ—Ä:

```python
def get_openai_headers(api_key: str) -> dict:
    """–§–æ—Ä–º–∏—Ä—É–µ—Ç headers –¥–ª—è OpenAI API"""
    ...
```

### 4. –ü—Ä–æ–º–ø—Ç—ã –∏ —à–∞–±–ª–æ–Ω—ã
- –í—Å–µ –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è LLM –∏ —à–∞–±–ª–æ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏–π –≤—ã–Ω–æ—Å–∏—Ç—å –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –º–æ–¥—É–ª–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, prompts/ –∏–ª–∏ texts/).

### 5. –ò—Å–∫–ª—é—á–∏—Ç—å sync-–æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ async-–∫–æ–¥–µ
- –í—Å–µ —Ñ–∞–π–ª–æ–≤—ã–µ –∏ —Å–µ—Ç–µ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ ‚Äî —Ç–æ–ª—å–∫–æ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ (aiofiles, httpx/aiohttp, StorageService).

## 11. –û—á–∏—Å—Ç–∫–∞ –æ—Ç Legacy –∫–æ–¥–∞

### 11.1 –ü—Ä–∏–Ω—Ü–∏–ø—ã –æ—á–∏—Å—Ç–∫–∏
- **–£–¥–∞–ª—è–µ–º —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ —Ñ–∞–π–ª—ã** - –≤—Å–µ —Ñ–∞–π–ª—ã –ø–æ–º–µ—á–µ–Ω–Ω—ã–µ –∫–∞–∫ Legacy
- **–û–±–Ω–æ–≤–ª—è–µ–º –∏–º–ø–æ—Ä—Ç—ã** - —É–±–∏—Ä–∞–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏
- **–£–ø—Ä–æ—â–∞–µ–º –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É** - –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
- **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è** - —Ñ–∏–∫—Å–∏—Ä—É–µ–º —á—Ç–æ —É–¥–∞–ª–µ–Ω–æ –∏ –ø–æ—á–µ–º—É

### 11.2 –£–¥–∞–ª–µ–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
```
–£–¥–∞–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
‚îú‚îÄ‚îÄ handlers/
‚îÇ   ‚îú‚îÄ‚îÄ base.py                     # –ë–∞–∑–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ (LEGACY)
‚îÇ   ‚îú‚îÄ‚îÄ business.py                 # –ë–∏–∑–Ω–µ—Å-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç (LEGACY)
‚îÇ   ‚îú‚îÄ‚îÄ menu.py                     # –£—Å—Ç–∞—Ä–µ–≤—à–µ–µ –º–µ–Ω—é (LEGACY)
‚îÇ   ‚îú‚îÄ‚îÄ transcript_management.py    # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞–º–∏ (LEGACY)
‚îÇ   ‚îú‚îÄ‚îÄ transcript_view.py          # –ü—Ä–æ—Å–º–æ—Ç—Ä —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–æ–≤ (LEGACY)
‚îÇ   ‚îî‚îÄ‚îÄ audio.py                    # –ê—É–¥–∏–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ (LEGACY)
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ audio/service.py.LEGACY     # –£—Å—Ç–∞—Ä–µ–≤—à–∏–π –∞—É–¥–∏–æ —Å–µ—Ä–≤–∏—Å
‚îú‚îÄ‚îÄ keyboards/
‚îÇ   ‚îî‚îÄ‚îÄ business.py                 # –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã –±–∏–∑–Ω–µ—Å-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ (LEGACY)
```

### 11.3 –°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
```
–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
‚îú‚îÄ‚îÄ handlers/
‚îÇ   ‚îú‚îÄ‚îÄ main.py                     # –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é (–ê–ö–¢–£–ê–õ–¨–ù–û)
‚îÇ   ‚îú‚îÄ‚îÄ transcript_main.py          # –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–æ–≤ (–ê–ö–¢–£–ê–õ–¨–ù–û)
‚îÇ   ‚îî‚îÄ‚îÄ transcript_processing.py    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ/—Ç–µ–∫—Å—Ç–∞ (–ê–ö–¢–£–ê–õ–¨–ù–û)
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ transcript.py               # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞–º–∏ (–ê–ö–¢–£–ê–õ–¨–ù–û)
‚îÇ   ‚îú‚îÄ‚îÄ audio_processing/           # –°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ
‚îÇ   ‚îú‚îÄ‚îÄ text_processing/            # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞
‚îÇ   ‚îî‚îÄ‚îÄ storage/                    # MinIO —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
```

### 11.4 –ú–∏–≥—Ä–∞—Ü–∏—è —Å Legacy
```python
# –ë—ã–ª–æ (Legacy)
from aisha_v2.app.handlers.business import BusinessHandler  # –£–¥–∞–ª–µ–Ω–æ
from aisha_v2.app.handlers.audio import AudioHandler       # –£–¥–∞–ª–µ–Ω–æ

# –°—Ç–∞–ª–æ (–°–æ–≤—Ä–µ–º–µ–Ω–Ω–æ)
from aisha_v2.app.handlers.transcript_main import TranscriptMainHandler
from aisha_v2.app.handlers.transcript_processing import TranscriptProcessingHandler
```

## 12. –°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è

### 12.1 –ò–µ—Ä–∞—Ä—Ö–∏—è –º–µ–Ω—é
```
–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    ‚Üì transcribe_menu
–ú–µ–Ω—é —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏
    ‚Üì transcribe_history  
–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–æ–≤
    ‚Üì transcribe_open_{id}
–ö–∞—Ä—Ç–æ—á–∫–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞
```

### 12.2 Callback data –∫–æ–Ω–≤–µ–Ω—Ü–∏–∏
```python
# –û—Å–Ω–æ–≤–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
"transcribe_menu"           # –í—Ö–æ–¥ –≤ –º–µ–Ω—é —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏
"transcribe_audio"          # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ
"transcribe_text"           # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞
"transcribe_history"        # –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–æ–≤

# –ù–∞–≤–∏–≥–∞—Ü–∏—è
"transcribe_back_to_menu"   # –í–æ–∑–≤—Ä–∞—Ç –≤ –º–µ–Ω—é —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏
"back_to_main"              # –í–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é

# –î–µ–π—Å—Ç–≤–∏—è —Å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞–º–∏
"transcribe_open_{id}"      # –û—Ç–∫—Ä—ã—Ç—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç
"transcript_format_{id}_{type}"  # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç
"transcribe_history_page_{page}" # –ü–∞–≥–∏–Ω–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏
```

### 12.3 –î—Ä—É–∂–µ–ª—é–±–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤
```python
def _format_friendly_filename(self, transcript_data: dict) -> str:
    """
    –ü—Ä–∏–º–µ—Ä—ã —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
    
    –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è:
    "2025-05-21_10-01_file_362.txt" ‚Üí "üìù –¢–µ–∫—Å—Ç (569 —Å–ª.) ‚Ä¢ 23.05 04:32"
    
    –û—Å–º—ã—Å–ª–µ–Ω–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è:
    "–ú–æ–π –¥–æ–∫—É–º–µ–Ω—Ç.txt" ‚Üí "üìù –ú–æ–π –¥–æ–∫—É–º–µ–Ω—Ç ‚Ä¢ 23.05 04:32"
    "presentation.mp3" ‚Üí "üéµ presentation ‚Ä¢ 23.05 14:15"
    
    –î–ª–∏–Ω–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è:
    "–û—á–µ–Ω—å –¥–ª–∏–Ω–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞.txt" ‚Üí "üìù –û—á–µ–Ω—å –¥–ª–∏–Ω–Ω–æ–µ –Ω–∞–∑... ‚Ä¢ 23.05 10:30"
    """
```

## 13. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ UX

### 13.1 Graceful degradation
```python
# –ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π —Å –º–µ–¥–∏–∞
if call.message.text:
    try:
        await call.message.edit_text(new_text, reply_markup=keyboard)
    except Exception:
        # Fallback –Ω–∞ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        await call.message.answer(new_text, reply_markup=keyboard)
else:
    # –°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–æ–∫—É–º–µ–Ω—Ç/–º–µ–¥–∏–∞ - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ
    await call.message.answer(new_text, reply_markup=keyboard)
```

### 13.2 –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ç–∏–ø–æ–≤
```python
# –ü—Ä–æ–±–ª–µ–º–∞ –Ω–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏—è —Ç–∏–ø–æ–≤ user_id
async def get_user_transcripts(self, user_id: Union[int, str, UUID], ...):
    # –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º —Ä–∞–∑–Ω—ã–µ —Ç–∏–ø—ã –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
    
# –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è SQLAlchemy –æ–±—ä–µ–∫—Ç–æ–≤
transcript_dict = {
    "id": str(id_attr) if id_attr else None,
    "created_at": created_at_attr.isoformat() if created_at_attr else None,
    "metadata": metadata_attr or {}
}
```

### 13.3 –†–µ—à–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –∏–º–ø–æ—Ä—Ç–æ–≤
```python
# –ü—Ä–æ–±–ª–µ–º–∞: –∫–æ–Ω—Ñ–ª–∏–∫—Ç BaseModel –º–µ–∂–¥—É Aiogram –∏ Pydantic
from aiogram.types import InlineKeyboardButton  # –Ø–≤–Ω—ã–π –∏–º–ø–æ—Ä—Ç

# –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
logger.info(f"[SEND_HISTORY] InlineKeyboardButton type: {type(InlineKeyboardButton)}")
logger.info(f"[SEND_HISTORY] –°–æ–∑–¥–∞–Ω–∞ –∫–Ω–æ–ø–∫–∞: {type(btn)}")
```

---

**–û–±–Ω–æ–≤–ª–µ–Ω–æ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è Legacy –∫–æ–¥–∞ 2025-05-23**

**–°–º. —Ç–∞–∫–∂–µ:**
- `docs/architecture.md` - –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
- `docs/async_and_safety.md` - best practices –ø–æ async Python
- `docs/navigation_transcript.md` - –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ 

---

## 14. ‚úÖ Developer Checklist

### 14.1 üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞ (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!)

#### BaseService –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ
- [ ] ‚úÖ **–ü—Ä–∏ –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–∏ –æ—Ç BaseService –ø–µ—Ä–µ–¥–∞–≤–∞–π session**: `super().__init__(session)`
- [ ] ‚ùå **–ù–ï –∏—Å–ø–æ–ª—å–∑—É–π**: `super().__init__()` –±–µ–∑ session
- [ ] üîç **–ü—Ä–æ–≤–µ—Ä—å —Ç–∏–ø –∫–ª–∞—Å—Å–∞**:
  - –†–∞–±–æ—Ç–∞–µ—Ç —Å –ë–î? ‚Üí –Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –æ—Ç `BaseService`
  - –£—Ç–∏–ª–∏—Ç–∞—Ä–Ω—ã–π –∫–ª–∞—Å—Å (API –∫–ª–∏–µ–Ω—Ç)? ‚Üí –æ–±—ã—á–Ω—ã–π –∫–ª–∞—Å—Å

```python
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û
class MyService(BaseService):
    def __init__(self, session: AsyncSession):
        super().__init__(session)  # ‚úÖ session –ø–µ—Ä–µ–¥–∞–Ω
        
# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û  
class MyService(BaseService):
    def __init__(self, session: AsyncSession):
        super().__init__()  # ‚ùå TypeError: missing session
```

#### Async/Await 
- [ ] ‚úÖ –í—Å–µ I/O –æ–ø–µ—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ `async/await`
- [ ] ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π `async with get_session()` –¥–ª—è –ë–î
- [ ] ‚ùå –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π sync —Ñ—É–Ω–∫—Ü–∏–∏ –≤ async –∫–æ–¥–µ

#### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- [ ] ‚úÖ –õ–æ–≥–∏—Ä—É–π –≤—Å–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è: `logger.exception()`
- [ ] ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–π –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- [ ] ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π try/except –±–ª–æ–∫–∏

#### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–¥–∞
- [ ] ‚úÖ –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ ‚Üí `services/`
- [ ] ‚úÖ –•–µ–Ω–¥–ª–µ—Ä—ã ‚Üí `handlers/` (—Ç–æ–ª—å–∫–æ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è)
- [ ] ‚úÖ –¢–µ–∫—Å—Ç—ã ‚Üí `texts/`
- [ ] ‚úÖ –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã ‚Üí `keyboards/`

### 14.2 –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö üóÑÔ∏è
- [ ] ‚úÖ **–ü—Ä–æ–≤–µ—Ä—è–π –º–∏–≥—Ä–∞—Ü–∏–∏**: `alembic history` –∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–æ–≤
- [ ] ‚úÖ **–ù–µ —Å–æ–∑–¥–∞–≤–∞–π –ø—É—Å—Ç—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏**: –≤—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π `upgrade()` –∏ `downgrade()`
- [ ] ‚úÖ **–¢–µ—Å—Ç–∏—Ä—É–π –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î**: –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
- [ ] ‚úÖ **–ü—Ä–∏–º–µ–Ω—è–π –º–∏–≥—Ä–∞—Ü–∏–∏**: `alembic upgrade head` –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è
- [ ] ‚ùå **–ù–ï –∏–∑–º–µ–Ω—è–π –º–æ–¥–µ–ª–∏ –±–µ–∑ –º–∏–≥—Ä–∞—Ü–∏–π**: —Å–Ω–∞—á–∞–ª–∞ –º–∏–≥—Ä–∞—Ü–∏—è, –ø–æ—Ç–æ–º –∫–æ–¥

```python
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –ø—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏
def upgrade() -> None:
    op.create_table('my_table', ...)  # –†–µ–∞–ª—å–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ

# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –ø—É—Å—Ç–∞—è –º–∏–≥—Ä–∞—Ü–∏—è  
def upgrade() -> None:
    pass  # –ù–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ—Ç!
```

### 14.3 üß™ –ü–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º

#### –ë–∞–∑–æ–≤—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
- [ ] ‚úÖ –ö–æ–¥ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- [ ] ‚úÖ –í—Å–µ –∏–º–ø–æ—Ä—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] ‚úÖ –¢–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç (–µ—Å–ª–∏ –µ—Å—Ç—å)
- [ ] ‚úÖ –õ–æ–≥–∏ –ø–æ–Ω—è—Ç–Ω—ã–µ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ BaseService (–µ—Å–ª–∏ —Å–æ–∑–¥–∞–≤–∞–ª –Ω–æ–≤—ã–µ —Å–µ—Ä–≤–∏—Å—ã)
```python
# –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç
from my_module import MyService
from unittest.mock import Mock
from sqlalchemy.ext.asyncio import AsyncSession

session = Mock(spec=AsyncSession)
service = MyService(session)  # –î–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –æ—à–∏–±–æ–∫
print("‚úÖ –°–µ—Ä–≤–∏—Å —Å–æ–∑–¥–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ")
```

### 14.4 üîß –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏ –∏ —Ä–µ—à–µ–Ω–∏—è

| –û—à–∏–±–∫–∞ | –ü—Ä–∏—á–∏–Ω–∞ | –†–µ—à–µ–Ω–∏–µ |
|--------|---------|---------|
| `BaseService.__init__() missing session` | –ù–µ –ø–µ—Ä–µ–¥–∞–Ω session –≤ super() | –ò–∑–º–µ–Ω–∏ –Ω–∞ `super().__init__(session)` |
| `ValidationError: Instance is frozen` | –ü–æ–ø—ã—Ç–∫–∞ –∏–∑–º–µ–Ω–∏—Ç—å CallbackQuery.data | –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä—è–º–æ–π –≤—ã–∑–æ–≤ –º–µ—Ç–æ–¥–æ–≤ |
| `ImportError: No module named` | –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã | –ü—Ä–æ–≤–µ—Ä—å –ø—É—Ç–∏ –∏–º–ø–æ—Ä—Ç–æ–≤ |
| `Session is closed` | –°–µ—Å—Å–∏—è –ë–î –∑–∞–∫—Ä—ã—Ç–∞ | –ò—Å–ø–æ–ª—å–∑—É–π `async with get_session()` |
| `relation "table" does not exist` | –ú–∏–≥—Ä–∞—Ü–∏–∏ –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã | –ó–∞–ø—É—Å—Ç–∏ `alembic upgrade head` |
| `DATABASE_URL not configured` | –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ë–î | –ü—Ä–æ–≤–µ—Ä—å .env –∏ validator |

### 14.5 üìã –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ –º–∏–≥—Ä–∞—Ü–∏–∏
- [ ] ‚úÖ **–°–æ–∑–¥–∞–Ω .env —Ñ–∞–π–ª** —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
- [ ] ‚úÖ **DATABASE_URL –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** —á–µ—Ä–µ–∑ validator
- [ ] ‚úÖ **–ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã**: `alembic upgrade head`
- [ ] ‚úÖ **–ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î**: —Ç–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã
- [ ] ‚úÖ **–ù–∞—Å—Ç—Ä–æ–µ–Ω—ã —Å–µ–∫—Ä–µ—Ç—ã**: TELEGRAM_TOKEN, API –∫–ª—é—á–∏

```python
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
from aisha_v2.app.core.config import settings
print("DATABASE_URL:", settings.DATABASE_URL)
print("TELEGRAM_TOKEN —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:", bool(settings.TELEGRAM_TOKEN))
```

### 14.6 üí° –°–æ–≤–µ—Ç—ã –ø–æ –æ—Ç–ª–∞–¥–∫–µ

```python
# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
logger.info(f"[DEBUG] User ID: {user_id}, type: {type(user_id)}")
logger.info(f"[DEBUG] Session: {session}, closed: {session.is_closed if hasattr(session, 'is_closed') else 'unknown'}")

# –ü—Ä–æ–≤–µ—Ä–∫–∞ BaseService
if isinstance(service, BaseService):
    logger.info(f"[DEBUG] Service session: {service.session}")
```

---

**üí° –ó–∞–ø–æ–º–Ω–∏**: –ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ —Å–≤—è–∑–∞–Ω–æ —Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ–º BaseService –∏ –Ω–µ–ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã–º–∏ –º–∏–≥—Ä–∞—Ü–∏—è–º–∏. 

**üõ†Ô∏è –ü—Ä–∏ –ª—é–±—ã—Ö –ø—Ä–æ–±–ª–µ–º–∞—Ö**:
1. –ü—Ä–æ–≤–µ—Ä—å validator –∏ DATABASE_URL
2. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã
3. –ü—Ä–æ–≤–µ—Ä—å –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –æ—Ç BaseService
4. –ü—Ä–æ–≤–µ—Ä—å async/await –≤ I/O –æ–ø–µ—Ä–∞—Ü–∏—è—Ö
# –û–±—Ä–∞–±–æ—Ç–∫–∞ –±–æ–ª—å—à–∏—Ö –∞—É–¥–∏–æ —Ñ–∞–π–ª–æ–≤

## –ü—Ä–æ–±–ª–µ–º–∞

Telegram Bot API –∏–º–µ–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤ **20 –ú–ë** –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ –º–µ—Ç–æ–¥ `get_file()`, –Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ñ–∞–π–ª—ã –¥–æ **2 –ì–ë**. –≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –æ—à–∏–±–∫–µ:

```
Telegram server says - Bad Request: file is too big
```

## –†–µ—à–µ–Ω–∏–µ

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ø—Ä—è–º—ã—Ö —Å—Å—ã–ª–æ–∫ Telegram.

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–∞–π–ª
         ‚Üì
–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞
         ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ‚â§ 20 –ú–ë         ‚îÇ > 20 –ú–ë         ‚îÇ
‚îÇ –û–±—ã—á–Ω–æ–µ         ‚îÇ –ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞   ‚îÇ
‚îÇ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ      ‚îÇ + aiohttp       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚Üì
–û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ (Whisper)
         ‚Üì
–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞
```

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

#### 1. LargeFileHandler
**–§–∞–π–ª:** `app/services/audio_processing/large_file_handler.py`

–û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤:

```python
class LargeFileHandler:
    def __init__(self, bot_token: str)
    
    async def download_large_file(self, file_path: str, max_size: int) -> Optional[bytes]
    async def download_to_temp_file(self, file_path: str, max_size: int) -> Optional[str]
    def cleanup_temp_file(self, temp_path: str) -> None
```

#### 2. –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π TranscriptProcessingHandler
**–§–∞–π–ª:** `app/handlers/transcript_processing.py`

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –∏ –≤—ã–±–∏—Ä–∞–µ—Ç –º–µ—Ç–æ–¥ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è.

#### 3. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
**–§–∞–π–ª:** `app/core/config.py`

```python
MAX_AUDIO_SIZE: int = 1024 * 1024 * 1024  # 1 –ì–ë (–Ω–∞—à –ª–∏–º–∏—Ç)
TELEGRAM_API_LIMIT: int = 20 * 1024 * 1024  # 20 –ú–ë (–ª–∏–º–∏—Ç Telegram Bot API)
MAX_AUDIO_DURATION: int = 7200  # 2 —á–∞—Å–∞
AUDIO_FORMATS: List[str] = ["mp3", "wav", "ogg", "m4a", "flac", "aac"]
```

## –õ–∏–º–∏—Ç—ã

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|----------|----------|
| **Telegram Bot API** | 20 –ú–ë | –õ–∏–º–∏—Ç –¥–ª—è `get_file()` |
| **–ù–∞—à –ª–∏–º–∏—Ç** | 1 –ì–ë | –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ |
| **–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** | 2 —á–∞—Å–∞ | –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞—É–¥–∏–æ |
| **–§–æ—Ä–º–∞—Ç—ã** | mp3, wav, ogg, m4a, flac, aac | –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã |

## –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞

```python
if file_size and file_size > settings.MAX_AUDIO_SIZE:
    # –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (> 1 –ì–ë)
    return error_message
    
elif file_size and file_size > settings.TELEGRAM_API_LIMIT:
    # –ë–æ–ª—å—à–æ–π —Ñ–∞–π–ª (20 –ú–ë - 1 –ì–ë) - –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É
    use_direct_download()
    
else:
    # –û–±—ã—á–Ω—ã–π —Ñ–∞–π–ª (‚â§ 20 –ú–ë) - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ
    use_bot_api_download()
```

### 2. –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤

```python
# –ü–æ–ª—É—á–∞–µ–º –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É
file = await bot.get_file(file_id)
url = f"https://api.telegram.org/file/bot{token}/{file.file_path}"

# –°–∫–∞—á–∏–≤–∞–µ–º —á–µ—Ä–µ–∑ aiohttp —Å –∫–æ–Ω—Ç—Ä–æ–ª–µ–º —Ä–∞–∑–º–µ—Ä–∞
async with aiohttp.ClientSession() as session:
    async with session.get(url) as response:
        # –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –ø–æ —á–∞—Å—Ç—è–º —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ª–∏–º–∏—Ç–æ–≤
        for chunk in response.content.iter_chunked(8192):
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ chunk
```

### 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏ –æ—á–∏—Å—Ç–∫–∞

```python
# –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ
result = await audio_service.process_audio(file_data)

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
handler.cleanup_temp_file(temp_path)
```

## –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç

### –°–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

#### –§–∞–π–ª ‚â§ 20 –ú–ë
```
üéµ –ù–∞—á–∏–Ω–∞—é –æ–±—Ä–∞–±–æ—Ç–∫—É –∞—É–¥–∏–æ...
```

#### –§–∞–π–ª 20 –ú–ë - 1 –ì–ë
```
üìÅ –ë–æ–ª—å—à–æ–π —Ñ–∞–π–ª –æ–±–Ω–∞—Ä—É–∂–µ–Ω

–†–∞–∑–º–µ—Ä: 150.5 –ú–ë
üîÑ –°–∫–∞—á–∏–≤–∞–µ–º —á–µ—Ä–µ–∑ –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É...
```

#### –§–∞–π–ª > 1 –ì–ë
```
‚ùå –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π

–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: 1.2 –ì–ë
–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 1 –ì–ë

–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª –º–µ–Ω—å—à–µ–≥–æ —Ä–∞–∑–º–µ—Ä–∞.
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### –õ–æ–≥–∏ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

```
[AUDIO_UNIVERSAL] –ë–æ–ª—å—à–æ–π —Ñ–∞–π–ª (52428800 –±–∞–π—Ç), –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É
–°–∫–∞—á–∏–≤–∞–Ω–∏–µ –±–æ–ª—å—à–æ–≥–æ —Ñ–∞–π–ª–∞: https://api.telegram.org/file/bot.../audio.mp3
–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: 50.0 –ú–ë
–°–∫–∞—á–∞–Ω–æ: 10.0 –ú–ë
–°–∫–∞—á–∞–Ω–æ: 20.0 –ú–ë
...
–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω: 50.0 –ú–ë
[AUDIO_UNIVERSAL] –ë–æ–ª—å—à–æ–π —Ñ–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω: 52428800 –±–∞–π—Ç
```

### –ú–µ—Ç—Ä–∏–∫–∏

- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
- –í—Ä–µ–º—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
- –£—Å–ø–µ—à–Ω–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏
- –†–∞–∑–º–µ—Ä—ã —Ñ–∞–π–ª–æ–≤

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ó–∞—â–∏—Ç–∞ –æ—Ç –∞—Ç–∞–∫

1. **–õ–∏–º–∏—Ç —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞** - –º–∞–∫—Å–∏–º—É–º 1 –ì–ë
2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ –≤—Ä–µ–º—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è** - –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞
3. **–¢–∞–π–º–∞—É—Ç—ã** - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∞–Ω–∏—è
4. **–û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤** - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è –¥–∏—Å–∫–∞

### –í–∞–ª–∏–¥–∞—Ü–∏—è

```python
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö
content_length = response.headers.get('content-length')
if content_length and int(content_length) > max_size:
    return None

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ –≤—Ä–µ–º—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
if downloaded > max_size:
    return None
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

```bash
python test_large_file_handler.py
```

### –¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

1. **–ú–∞–ª—ã–π —Ñ–∞–π–ª** (< 20 –ú–ë) - –æ–±—ã—á–Ω–æ–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ
2. **–ë–æ–ª—å—à–æ–π —Ñ–∞–π–ª** (20 –ú–ë - 1 –ì–ë) - –ø—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞
3. **–°–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π —Ñ–∞–π–ª** (> 1 –ì–ë) - –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ
4. **–û—à–∏–±–∫–∏ —Å–µ—Ç–∏** - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
5. **–û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤** - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —É—Ç–µ—á–µ–∫

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

- **–ü–æ—Ç–æ–∫–æ–≤–æ–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ** - —Ñ–∞–π–ª –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤ –ø–∞–º—è—Ç—å
- **Chunked transfer** - —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –ø–æ —á–∞—Å—Ç—è–º (8KB chunks)
- **–ü—Ä–æ–≥—Ä–µ—Å—Å-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã** - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥—ã–µ 10 –ú–ë
- **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å** - –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

### –†–µ—Å—É—Ä—Å—ã

| –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ | –ü–∞–º—è—Ç—å | –í—Ä–µ–º—è | –î–∏—Å–∫ |
|--------------|--------|-------|------|
| 20 –ú–ë | ~20 –ú–ë | 5-10 —Å–µ–∫ | 0 –ú–ë |
| 100 –ú–ë | ~8 –ö–ë | 30-60 —Å–µ–∫ | 0 –ú–ë |
| 500 –ú–ë | ~8 –ö–ë | 2-5 –º–∏–Ω | 0 –ú–ë |
| 1 –ì–ë | ~8 –ö–ë | 5-10 –º–∏–Ω | 0 –ú–ë |

## –°—Ç–∞—Ç—É—Å

‚úÖ **–†–ï–ê–õ–ò–ó–û–í–ê–ù–û**

- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤ –¥–æ 1 –ì–ë
- –ü—Ä—è–º—ã–µ —Å—Å—ã–ª–∫–∏ –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
- –ö–æ–Ω—Ç—Ä–æ–ª—å –ª–∏–º–∏—Ç–æ–≤ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ –ø—Ä–æ–¥–∞–∫—à–Ω** - —Å–±–æ—Ä –º–µ—Ç—Ä–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
2. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è** - –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞–∑–º–µ—Ä–æ–≤ chunks
3. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** - –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
4. **–°–∂–∞—Ç–∏–µ** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∂–∞—Ç–∏–µ –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π 
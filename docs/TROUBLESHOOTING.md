# –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç–µ–π AISHA Backend

## üö® –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### üñºÔ∏è –ü—Ä–æ–±–ª–µ–º—ã —Å –≥–∞–ª–µ—Ä–µ–µ–π

#### –ü—É—Å—Ç–∞—è –≥–∞–ª–µ—Ä–µ—è Imagen4
**–°–∏–º–ø—Ç–æ–º—ã:**
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Imagen4 —Ä–∞–±–æ—Ç–∞–µ—Ç
- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ –≥–∞–ª–µ—Ä–µ–µ
- –§–∏–ª—å—Ç—Ä –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç 0 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é MinIO
python scripts/debug/check_imagen4_config.py

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π bucket
grep -r "MINIO_BUCKET" app/services/generation/

# –û—á–∏—â–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ –µ—Å—Ç—å
python scripts/debug/cleanup_test_imagen4.py
```

**–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π bucket –∏–ª–∏ —Ç–µ—Å—Ç–æ–≤—ã–µ URL

#### –§–∏–ª—å—Ç—Ä—ã —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è –ø—Ä–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
**–°–∏–º–ø—Ç–æ–º—ã:**
- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä
- –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –º–µ–∂–¥—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
- –§–∏–ª—å—Ç—Ä –∏—Å—á–µ–∑–∞–µ—Ç

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä—è–µ–º Redis –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
redis-cli -h 192.168.0.3 ping

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π
python -c "from app.handlers.gallery.states import gallery_state_manager; print('OK')"
```

**–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞:** –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ Redis –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å GalleryStateManager

#### –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
**–°–∏–º–ø—Ç–æ–º—ã:**
- –ù–∞–∂–∏–º–∞–µ–º "–ù–∞–∑–∞–¥" –≤ –≥–∞–ª–µ—Ä–µ–µ
- –ù–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∏–ª–∏ –æ—à–∏–±–∫–∞

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä—è–µ–º callback handlers
grep -r "gallery_all" app/handlers/gallery/

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è FSM
python -c "from app.handlers.gallery.states import GalleryStates; print('OK')"
```

### üé® –ü—Ä–æ–±–ª–µ–º—ã —Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π

#### Imagen4 –∑–∞–≤–∏—Å–∞–µ—Ç –≤ PENDING
**–°–∏–º–ø—Ç–æ–º—ã:**
- –°–æ–∑–¥–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
- –°—Ç–∞—Ç—É—Å –æ—Å—Ç–∞–µ—Ç—Å—è PENDING –¥–æ–ª–≥–æ
- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä—è–µ–º FAL AI —Ç–æ–∫–µ–Ω
echo $FAL_KEY

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ API
python -c "
import os
print('FAL_KEY:', os.getenv('FAL_KEY', 'NOT_SET')[:10] + '...')
"

# –û—á–∏—â–∞–µ–º –∑–∞–≤–∏—Å—à–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
python -c "
from app.core.database import get_session
from app.database.models import ImageGeneration, GenerationStatus
# (–∫–æ–¥ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ PENDING –∑–∞–ø–∏—Å–µ–π)
"
```

#### –¢–µ—Å—Ç–æ–≤—ã–µ URL –≤–º–µ—Å—Ç–æ —Ä–µ–∞–ª—å–Ω—ã—Ö
**–°–∏–º–ø—Ç–æ–º—ã:**
- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è
- URL —Å–æ–¥–µ—Ä–∂–∞—Ç "example.com"
- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä—è–µ–º URL –≤ –±–∞–∑–µ
python -c "
from app.core.database import get_session
from app.database.models import ImageGeneration
# SELECT result_urls FROM image_generation WHERE result_urls LIKE '%example%'
"

# –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω—ã
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–º–µ–Ω—ã —Ç–µ—Å—Ç–æ–≤—ã—Ö URL —Å–æ–∑–¥–∞–Ω –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω —Ä–∞–Ω–µ–µ
```

### üóÑÔ∏è –ü—Ä–æ–±–ª–µ–º—ã —Å —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º

#### MinIO –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
**–°–∏–º–ø—Ç–æ–º—ã:**
- –û—à–∏–±–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MinIO
- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å MinIO
curl http://192.168.0.4:9000/health/live

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
python -c "
from app.core.config import settings
print('MinIO endpoint:', settings.MINIO_ENDPOINT)
print('MinIO bucket:', getattr(settings, 'MINIO_BUCKET', 'NOT_SET'))
"

# –°–æ–∑–¥–∞–µ–º bucket –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
mc alias set local http://192.168.0.4:9000 minioadmin minioadmin
mc mb local/imagen4
mc mb local/photos
```

#### Redis –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
**–°–∏–º–ø—Ç–æ–º—ã:**
- –°–æ—Å—Ç–æ—è–Ω–∏—è –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è
- –§–∏–ª—å—Ç—Ä—ã —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä—è–µ–º Redis
redis-cli -h 192.168.0.3 ping

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
python -c "
from app.services.cache_service import cache_service
import asyncio
asyncio.run(cache_service.ping())
"
```

### üë§ –ü—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

#### –ë–∞–ª–∞–Ω—Å –Ω–µ —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è
**–°–∏–º–ø—Ç–æ–º—ã:**
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ—Ö–æ–¥–∏—Ç
- –ë–∞–ª–∞–Ω—Å –æ—Å—Ç–∞–µ—Ç—Å—è –ø—Ä–µ–∂–Ω–∏–º

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Ä–≤–∏—Å –±–∞–ª–∞–Ω—Å–∞
python -c "
from app.services.balance_service import BalanceService
print('Balance service OK')
"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
python scripts/admin/add_balance.py --stats
```

#### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω
**–°–∏–º–ø—Ç–æ–º—ã:**
- –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –±–æ—Ç—É
- "User not found" –≤ –ª–æ–≥–∞—Ö

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
python scripts/admin/add_balance.py --list

# –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
python -c "
from app.services.user_service import UserService
# (–∫–æ–¥ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
"
```

### üîß –°–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

#### Import errors
**–°–∏–º–ø—Ç–æ–º—ã:**
- –û—à–∏–±–∫–∏ –∏–º–ø–æ—Ä—Ç–∞ –º–æ–¥—É–ª–µ–π
- "cannot import name" –≤ –ª–æ–≥–∞—Ö

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
which python
pip list | grep -E "(aiogram|sqlalchemy|redis)"

# –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
pip install -r requirements.txt
```

#### Circular imports
**–°–∏–º–ø—Ç–æ–º—ã:**
- ImportError: cannot import name
- –ü—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ

**–†–µ—à–µ–Ω–∏–µ:**
1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª–µ–Ω–∏–≤—ã–µ –∏–º–ø–æ—Ä—Ç—ã –≤ —Ñ—É–Ω–∫—Ü–∏—è—Ö
2. –†–µ–æ—Ä–≥–∞–Ω–∏–∑—É–π—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –º–æ–¥—É–ª–µ–π
3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ dependency injection

### üìä –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
```bash
# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
python -c "from app.core.database import get_session; print('DB OK')"

# Redis
redis-cli -h 192.168.0.3 ping

# MinIO
curl -I http://192.168.0.4:9000/health/live

# FAL AI
python -c "import os; print('FAL_KEY set:', bool(os.getenv('FAL_KEY')))"
```

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```bash
# –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
python scripts/admin/add_balance.py --list | grep "174171680"

# –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
python -c "
from app.core.database import get_session
from app.database.models import ImageGeneration, User
# SELECT count(*) FROM image_generation WHERE user_id = ...
"
```

#### –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–µ–π
```bash
# Redis –∫—ç—à
redis-cli -h 192.168.0.3 FLUSHALL

# Python –∫—ç—à
find . -name "__pycache__" -type d -exec rm -rf {} +
find . -name "*.pyc" -delete
```

## üÜò –≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ —Å–∏—Ç—É–∞—Ü–∏–∏

### –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞
```bash
# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
pkill -f "python -m app.main"

# –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–µ–π
redis-cli -h 192.168.0.3 FLUSHALL

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫
python -m app.main
```

### –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –±—ç–∫–∞–ø–∞
```bash
# –ë–î (–µ—Å–ª–∏ –µ—Å—Ç—å –±—ç–∫–∞–ø)
pg_restore -h 192.168.0.4 -U aisha -d aisha_db backup.sql

# MinIO (–µ—Å–ª–∏ –µ—Å—Ç—å –±—ç–∫–∞–ø)
mc cp --recursive backup/ local/imagen4/
```

### –û—Ç–∫–∞—Ç –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏
```bash
# Git –æ—Ç–∫–∞—Ç
git log --oneline -10
git reset --hard <commit_hash>

# Docker –æ—Ç–∫–∞—Ç
docker pull registry:5000/aisha-backend:previous
docker-compose up -d
```

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏**: `tail -f logs/app.log`
2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤**: –∫–æ–º–∞–Ω–¥—ã –≤—ã—à–µ
3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é**: –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
4. **–°–æ–∑–¥–∞–π—Ç–µ issue**: —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –æ–ø–∏—Å–∞–Ω–∏–µ–º –∏ –ª–æ–≥–∞–º–∏ 
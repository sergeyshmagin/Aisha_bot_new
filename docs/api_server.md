# üöÄ Aisha Bot FAL Webhook API Server

–û—Ç–¥–µ–ª—å–Ω—ã–π FastAPI —Å–µ—Ä–≤–µ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ—Ç FAL AI —Å SSL –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π.

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
api_server/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.py      # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è API —Å–µ—Ä–≤–µ—Ä–∞
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ logger.py      # –°–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ routers/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ fal_webhook.py # Webhook —Ä–æ—É—Ç–µ—Ä
‚îÇ   ‚îî‚îÄ‚îÄ main.py            # –û—Å–Ω–æ–≤–Ω–æ–µ FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
‚îú‚îÄ‚îÄ ssl/                   # SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
‚îú‚îÄ‚îÄ logs/                  # –õ–æ–≥–∏ API —Å–µ—Ä–≤–µ—Ä–∞
‚îú‚îÄ‚îÄ requirements.txt       # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ env.example           # –ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
‚îî‚îÄ‚îÄ run_api_server.py     # –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞
```

## üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
```bash
cd api_server
pip install -r requirements.txt
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
```bash
cp env.example .env
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env —Ñ–∞–π–ª —Å –≤–∞—à–∏–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
```

### 3. SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã —É–∂–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –ø–∞–ø–∫—É `ssl/`:
- `aibots_kz.crt` - –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
- `aibots.kz.key` - –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á
- `aibots_kz.ca-bundle` - –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã

## üöÄ –ó–∞–ø—É—Å–∫

### –ü—Ä–æ–¥–∞–∫—à–Ω —Ä–µ–∂–∏–º (—Å SSL)
```bash
python run_api_server.py
```

### –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ (–±–µ–∑ SSL)
```bash
# –í .env —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ SSL_ENABLED=false
python -m app.main
```

## üì° Endpoints

### Webhook
- **POST** `/api/v1/avatar/status_update` - –û—Å–Ω–æ–≤–Ω–æ–π webhook –¥–ª—è FAL AI
- **GET** `/api/v1/health` - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–µ—Ä–∞
- **GET** `/api/v1/webhook/status` - –°—Ç–∞—Ç—É—Å webhook —Å–∏—Å—Ç–µ–º—ã

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- **GET** `/` - –ö–æ—Ä–Ω–µ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å–µ—Ä–≤–µ—Ä–µ

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- **SSL/TLS** - –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è FAL AI webhook
- **TrustedHost** - –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ–º–µ–Ω–æ–≤
- **CORS** - –ù–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω
- **IP —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è** - –¢–æ–ª—å–∫–æ IP –∞–¥—Ä–µ—Å–∞ FAL AI

## üìä –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–õ–æ–≥–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ø–∞–ø–∫–µ `logs/`:
- `api_server.log` - –û–±—â–∏–µ –ª–æ–≥–∏ API —Å–µ—Ä–≤–µ—Ä–∞
- `webhook.log` - –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏ webhook

## üîÑ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –æ—Å–Ω–æ–≤–Ω—ã–º –±–æ—Ç–æ–º

API —Å–µ—Ä–≤–µ—Ä –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Å –æ—Å–Ω–æ–≤–Ω—ã–º –ø—Ä–æ–µ–∫—Ç–æ–º —á–µ—Ä–µ–∑:
- –û–±—â—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
- –°–µ—Ä–≤–∏—Å—ã –æ–±—É—á–µ–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–æ–≤
- Telegram Bot –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è
curl https://aibots.kz:8443/health

# –°—Ç–∞—Ç—É—Å webhook
curl https://aibots.kz:8443/api/v1/webhook/status

# –¢–µ—Å—Ç–æ–≤—ã–π webhook (POST)
curl -X POST https://aibots.kz:8443/api/v1/avatar/status_update \
  -H "Content-Type: application/json" \
  -d '{"request_id": "test_123", "status": "completed"}'
```

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ `app/core/config.py`:

- `API_HOST` - –•–æ—Å—Ç —Å–µ—Ä–≤–µ—Ä–∞ (0.0.0.0)
- `API_PORT` - –ü–æ—Ä—Ç —Å–µ—Ä–≤–µ—Ä–∞ (8443)
- `SSL_ENABLED` - –í–∫–ª—é—á–µ–Ω–∏–µ SSL (true)
- `DATABASE_URL` - URL –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- `TELEGRAM_TOKEN` - –¢–æ–∫–µ–Ω Telegram –±–æ—Ç–∞
- `FAL_API_KEY` - API –∫–ª—é—á FAL AI

## üö® –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **SSL –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω** - FAL AI —Ç—Ä–µ–±—É–µ—Ç HTTPS –¥–ª—è webhook
2. **–ü–æ—Ä—Ç 8443** - –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π HTTPS –ø–æ—Ä—Ç –¥–ª—è webhook
3. **–î–æ–º–µ–Ω aibots.kz** - –ù–∞—Å—Ç—Ä–æ–µ–Ω –≤ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞—Ö
4. **–§–æ–Ω–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** - Webhook –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
5. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram

## üîÑ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

### Systemd —Å–µ—Ä–≤–∏—Å (Linux)
```bash
# –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª /etc/systemd/system/aisha-webhook-api.service
[Unit]
Description=Aisha Bot FAL Webhook API
After=network.target

[Service]
Type=simple
User=aisha
WorkingDirectory=/path/to/api_server
ExecStart=/path/to/python run_api_server.py
Restart=always

[Install]
WantedBy=multi-user.target
```

### Docker (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
```dockerfile
FROM python:3.11-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt
COPY . .
EXPOSE 8443
CMD ["python", "run_api_server.py"]
``` 
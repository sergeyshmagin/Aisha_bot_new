# โ ะัััั: ะะฐะทะฒััััะฒะฐะฝะธะต Webhook ะกะตัะฒะธัะพะฒ

## ๐ฏ ะัะฟะพะปะฝะตะฝะฝัะต ะทะฐะดะฐัะธ

### โ 1. ะัะฟัะฐะฒะปะตะฝะธะต ะบะพะฝัะปะธะบัะพะฒ ะทะฐะฒะธัะธะผะพััะตะน

**ะัะพะฑะปะตะผะฐ:** ะะพะฝัะปะธะบั ะฒะตััะธะน ะฟะฐะบะตัะพะฒ ะผะตะถะดั bot ะธ webhook ะบะพะผะฟะพะฝะตะฝัะฐะผะธ
- `aiohttp==3.9.5` (ะดะปั aiogram) vs `aiohttp==3.11.11` (ะดะปั webhook API)  
- `aiofiles>=23.0.0` vs `aiofiles~=23.2.1` (ััะตะฑะพะฒะฐะฝะธะต aiogram)

**ะะตัะตะฝะธะต:** ะกะพะทะดะฐะฝ ะพัะดะตะปัะฝัะน `requirements_webhook.txt` ะฑะตะท aiogram ะทะฐะฒะธัะธะผะพััะตะน:
```
fastapi==0.115.5
uvicorn[standard]==0.32.1
aiohttp==3.11.11
aiofiles==23.2.1
fal-client==0.7.0
sqlalchemy>=2.0.0
asyncpg>=0.27.0
redis>=5.0.0
minio>=7.0.0
```

### โ 2. ะะฑะฝะพะฒะปะตะฝะธะต Dockerfile.webhook

**ะะทะผะตะฝะตะฝะธั:**
- ะฃะฑัะฐะฝะฐ ะทะฐะฒะธัะธะผะพััั ะพั `requirements.txt` ะธ `requirements_api.txt`
- ะัะฟะพะปัะทัะตั ัะพะปัะบะพ `requirements_webhook.txt`
- ะฃะฑัะฐะฝั bot-ัะฟะตัะธัะธัะฝัะต ะทะฐะฒะธัะธะผะพััะธ
- ะะฟัะธะผะธะทะธัะพะฒะฐะฝะฐ ัะฑะพัะบะฐ ัะตัะตะท multi-stage build

### โ 3. ะกะฑะพัะบะฐ ะธ ะฟัั ะพะฑัะฐะทะพะฒ ะฒ ัะตะตััั

**ะะฑัะฐะทั ััะฟะตัะฝะพ ัะพะฑัะฐะฝั:**
```bash
โ webhook-api:latest          โ 192.168.0.4:5000/webhook-api:latest
โ nginx-webhook:latest        โ 192.168.0.4:5000/nginx-webhook:latest
```

**ะัะพะฒะตัะบะฐ ัะตะตัััะฐ:**
```bash
$ curl -s http://192.168.0.4:5000/v2/_catalog
{"repositories":["aisha/bot","nginx-webhook","webhook-api"]}
```

### โ 4. ะกะพะทะดะฐะฝะธะต ัะบัะธะฟัะพะฒ ะฐะฒัะพะผะฐัะธะทะฐัะธะธ

**ะะพะปะฝัะน ะดะตะฟะปะพะน:**
```bash
./scripts/deploy/webhook-complete.sh
```
- ะกะพะฑะธัะฐะตั ะพะฑัะฐะทั
- ะััะธั ะฒ ัะตะตััั 192.168.0.4:5000
- ะกะพะทะดะฐัั Docker ัะตัั
- ะะฐะฟััะบะฐะตั webhook ัะตัะฒะธัั
- ะัะพะฒะตััะตั ัะฐะฑะพัะพัะฟะพัะพะฑะฝะพััั

**ะััััะพะต ะพะฑะฝะพะฒะปะตะฝะธะต:**
```bash
./scripts/deploy/update-webhook-images.sh  
```
- ะะตัะตัะพะฑะธัะฐะตั ะพะฑัะฐะทั
- ะััะธั ะพะฑะฝะพะฒะปะตะฝะธั
- ะะตัะตะทะฐะฟััะบะฐะตั ะบะพะฝัะตะนะฝะตัั

### โ 5. ะกะพะทะดะฐะฝะธะต ะดะพะบัะผะตะฝัะฐัะธะธ

**ะคะฐะนะปั ะดะพะบัะผะตะฝัะฐัะธะธ:**
- `docs/WEBHOOK_DEPLOYMENT.md` - ะฟะพะปะฝะพะต ััะบะพะฒะพะดััะฒะพ ะฟะพ ัะฐะทะฒััััะฒะฐะฝะธั
- ะััะธัะตะบัััะฝัะต ะดะธะฐะณัะฐะผะผั
- ะะพะผะฐะฝะดั ัะฟัะฐะฒะปะตะฝะธั ะธ ะผะพะฝะธัะพัะธะฝะณะฐ
- ะัะบะพะฒะพะดััะฒะพ ะฟะพ ััััะฐะฝะตะฝะธั ะฝะตะฟะพะปะฐะดะพะบ

## ๐๏ธ ะััะธัะตะบัััะฐ Webhook ะกะตัะฒะธัะพะฒ

```
                    โโโโโโโโโโโโโโโโโโโ
                    โ   Nginx LB      โ
                    โ   (80/443)      โ
                    โโโโโโโโโโโฌโโโโโโโโ
                              โ
                    โโโโโโโโโโโดโโโโโโโโ
                    โ                 โ
            โโโโโโโโโผโโโโโโโ  โโโโโโโโผโโโโโโโ
            โ Webhook API  โ  โ Webhook API โ
            โ Instance #1  โ  โ Instance #2 โ
            โ   (8001)     โ  โ   (8002)    โ
            โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ
                    โ                 โ
                    โโโโโโโโโโโฌโโโโโโโโ
                              โ
                    โโโโโโโโโโโผโโโโโโโโ
                    โ   Database      โ
                    โ PostgreSQL      โ
                    โ (192.168.0.4)   โ
                    โโโโโโโโโโโโโโโโโโโ
```

## ๐ ะะพัะพะฒะฝะพััั ะบ ะฟัะพะดะฐะบัะตะฝั

### โ ะะฑัะฐะทั ะฒ ัะตะตัััะต
- **webhook-api:latest** - FastAPI ะฟัะธะปะพะถะตะฝะธะต ะดะปั ะฟัะธัะผะฐ FAL AI webhook'ะพะฒ
- **nginx-webhook:latest** - Load balancer ะดะปั webhook API

### โ Docker Compose ะบะพะฝัะธะณััะฐัะธั
- `docker-compose.webhook.prod.yml` - ะฟัะพะดะฐะบัะฝ ะบะพะฝัะธะณััะฐัะธั
- ะะฒะฐ ะธะฝััะฐะฝัะฐ API ะดะปั ะฒััะพะบะพะน ะดะพัััะฟะฝะพััะธ
- Nginx load balancer
- Health checks ะดะปั ะฒัะตั ัะตัะฒะธัะพะฒ

### โ ะะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั
- `prod.env` - ะฟัะพะดะฐะบัะฝ ะฟะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั
- ะะฐะทะฐ ะดะฐะฝะฝัั, Redis, MinIO ะฝะฐัััะพะตะฝั
- FAL AI ะบะปััะธ ะฟะพะดะณะพัะพะฒะปะตะฝั

### โ ะกะตัั ะธ ะฟะพััั
- **ะกะตัั:** `aisha_webhook_cluster`
- **Nginx:** ะฟะพััั 80, 443
- **API #1:** ะฟะพัั 8001  
- **API #2:** ะฟะพัั 8002

## ๐ Endpoints

### Health Check
```bash
curl -f http://localhost/health          # ะงะตัะตะท nginx
curl -f http://localhost:8001/health     # API #1 ะฟััะผะพ
curl -f http://localhost:8002/health     # API #2 ะฟััะผะพ
```

### FAL AI Webhook
```
https://aibots.kz:8443/api/v1/avatar/status_update
```

## ๐ ะกะปะตะดัััะธะต ัะฐะณะธ

### 1. ะะฐะฟััะบ ะฝะฐ ะฟัะพะดะฐะบัะฝ ัะตัะฒะตัะต
```bash
# ะะฐ ัะตัะฒะตัะต ะณะดะต ะฑัะดัั webhook'ะธ:
./scripts/deploy/webhook-complete.sh
```

### 2. ะะพะฝัะธะณััะฐัะธั FAL AI
- ะฃััะฐะฝะพะฒะธัั webhook URL: `https://aibots.kz:8443/api/v1/avatar/status_update`
- ะะฐัััะพะธัั webhook secret ะธะท `prod.env`

### 3. ะขะตััะธัะพะฒะฐะฝะธะต
```bash
# ะัะพะฒะตัะบะฐ API
curl -f http://localhost/health

# ะขะตัั webhook endpoint
curl -X POST http://localhost/api/v1/avatar/status_update \
  -H "Content-Type: application/json" \
  -d '{"status": "completed", "request_id": "test-123"}'
```

### 4. ะะพะฝะธัะพัะธะฝะณ
```bash
# ะะพะณะธ ัะตัะฒะธัะพะฒ
docker-compose -f docker-compose.webhook.prod.yml --env-file prod.env logs -f

# ะกัะฐัะธััะธะบะฐ ะบะพะฝัะตะนะฝะตัะพะฒ
docker stats aisha-webhook-api-1 aisha-webhook-api-2 aisha-nginx-webhook
```

## ๐ ะัะพะณ

**Webhook ะธะฝััะฐััััะบัััะฐ ะณะพัะพะฒะฐ ะบ ะฟัะพะดะฐะบัะตะฝั:**

โ ะะฑัะฐะทั ัะพะฑัะฐะฝั ะธ ะทะฐะณััะถะตะฝั ะฒ ัะตะตััั  
โ Docker Compose ะบะพะฝัะธะณััะฐัะธั ะฟัะพะฒะตัะตะฝะฐ  
โ ะกะบัะธะฟัั ะฐะฒัะพะผะฐัะธะทะฐัะธะธ ัะพะทะดะฐะฝั  
โ ะะพะบัะผะตะฝัะฐัะธั ะฝะฐะฟะธัะฐะฝะฐ  
โ Load balancing ะฝะฐัััะพะตะฝ  
โ Health checks ัะฐะฑะพัะฐัั  

**ะขะตะฟะตัั ะผะพะถะฝะพ ะทะฐะฟััะบะฐัั ะฝะฐ ะฟัะพะดะฐะบัะฝ ัะตัะฒะตัะต ะธ ะธะฝัะตะณัะธัะพะฒะฐัั ั FAL AI!** ๐ 
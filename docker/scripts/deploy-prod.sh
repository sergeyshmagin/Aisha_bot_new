#!/bin/bash

# ðŸš€ Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ñ Aisha Bot v2 Ð² Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐ½ (/opt/aisha-backend)

set -e

# Ð¦Ð²ÐµÑ‚Ð° Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð°
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log() {
    echo -e "${BLUE}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[$(date +'%Y-%m-%d %H:%M:%S')] âœ… $1${NC}"
}

log_error() {
    echo -e "${RED}[$(date +'%Y-%m-%d %H:%M:%S')] âŒ $1${NC}"
}

log_warning() {
    echo -e "${YELLOW}[$(date +'%Y-%m-%d %H:%M:%S')] âš ï¸  $1${NC}"
}

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ°, Ñ‡Ñ‚Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¸Ð· Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ð¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
if [ ! -f "docker-compose.prod.yml" ]; then
    log_error "Ð¤Ð°Ð¹Ð» docker-compose.prod.yml Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¸Ð· /opt/aisha-backend"
    exit 1
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
if [ ! -f ".env.docker.prod" ]; then
    log_error "Ð¤Ð°Ð¹Ð» .env.docker.prod Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½. Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ ÐµÐ³Ð¾ Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ env.docker.prod.template"
    exit 1
fi

log "ðŸš€ ÐÐ°Ñ‡Ð¸Ð½Ð°ÐµÐ¼ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ Aisha Bot v2 Ð² Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐ½..."

# 1. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð²Ð½ÐµÑˆÐ½Ð¸Ñ… ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²
log "ðŸ“‹ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚Ð¸ Ð²Ð½ÐµÑˆÐ½Ð¸Ñ… ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²..."
if ! ./docker/scripts/health-check.sh; then
    log_error "ÐÐµ Ð²ÑÐµ Ð²Ð½ÐµÑˆÐ½Ð¸Ðµ ÑÐµÑ€Ð²Ð¸ÑÑ‹ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹. ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ñ."
    exit 1
fi

# 2. Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹ Ð´Ð»Ñ Ð»Ð¾Ð³Ð¾Ð²
log "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð´Ð»Ñ Ð»Ð¾Ð³Ð¾Ð²..."
sudo mkdir -p /opt/aisha-backend/logs
sudo chown -R $USER:$USER /opt/aisha-backend/logs
sudo chmod 755 /opt/aisha-backend/logs

# 3. Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð´Ð»Ñ Ð»Ð¾Ð³Ð¾Ð² nginx (ÐµÑÐ»Ð¸ Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚)
if [ ! -d "/var/log/aisha" ]; then
    log "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð´Ð»Ñ Ð»Ð¾Ð³Ð¾Ð² nginx..."
    sudo mkdir -p /var/log/aisha
    sudo chown www-data:www-data /var/log/aisha
    sudo chmod 755 /var/log/aisha
fi

# 4. ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÑÑ‚Ð°Ñ€Ñ‹Ñ… ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð² (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ)
log "ðŸ›‘ ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ñ… ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²..."
docker-compose -f docker-compose.prod.yml down --remove-orphans || true

# 5. Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ ÑÑ‚Ð°Ñ€Ñ‹Ñ… Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð² (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
if [ "$1" = "--rebuild" ]; then
    log "ðŸ”„ Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ ÑÑ‚Ð°Ñ€Ñ‹Ñ… Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð²..."
    docker images | grep aisha | awk '{print $3}' | xargs docker rmi -f || true
fi

# 6. Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð²
log "ðŸ”¨ Ð¡Ð±Ð¾Ñ€ÐºÐ° Docker Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð²..."
docker-compose -f docker-compose.prod.yml build --no-cache

# 7. Ð—Ð°Ð¿ÑƒÑÐº ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²
log "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²..."
docker-compose -f docker-compose.prod.yml up -d

# 8. ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ° ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²
log "â±ï¸  ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ° ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²..."
sleep 30

# 9. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²
log "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²..."
if ! docker-compose -f docker-compose.prod.yml ps | grep -q "Up"; then
    log_error "ÐšÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ Ð½Ðµ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ð»Ð¸ÑÑŒ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾"
    docker-compose -f docker-compose.prod.yml logs --tail=50
    exit 1
fi

# 10. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° health check
log "ðŸ’Š ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° health check..."
for i in {1..12}; do
    if curl -f http://localhost:8000/health >/dev/null 2>&1; then
        log_success "API ÑÐµÑ€Ð²ÐµÑ€ Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÐµÑ‚"
        break
    fi
    if [ $i -eq 12 ]; then
        log_error "API ÑÐµÑ€Ð²ÐµÑ€ Ð½Ðµ Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÐµÑ‚ Ð¿Ð¾ÑÐ»Ðµ 60 ÑÐµÐºÑƒÐ½Ð´"
        docker-compose -f docker-compose.prod.yml logs aisha-api --tail=20
        exit 1
    fi
    log "ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ API ÑÐµÑ€Ð²ÐµÑ€Ð°... ($i/12)"
    sleep 5
done

# 11. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° nginx ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
log "ðŸŒ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° nginx ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸..."
if nginx -t 2>/dev/null; then
    log_success "ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ nginx ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð°"
    
    # 12. ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° nginx
    log "ðŸ”„ ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° nginx..."
    sudo systemctl reload nginx
    log_success "Nginx Ð¿ÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½"
else
    log_warning "ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹ Ñ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÐµÐ¹ nginx. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ."
fi

# 13. Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ/Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ systemd ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²
log "ðŸ”§ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° systemd ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²..."

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ systemd unit Ñ„Ð°Ð¹Ð»Ð° Ð´Ð»Ñ Docker Compose
cat > /tmp/aisha-v2.service << EOF
[Unit]
Description=Aisha Bot v2 Docker Compose
Requires=docker.service
After=docker.service

[Service]
Type=oneshot
RemainAfterExit=yes
WorkingDirectory=/opt/aisha-backend
ExecStart=/usr/bin/docker-compose -f docker-compose.prod.yml up -d
ExecStop=/usr/bin/docker-compose -f docker-compose.prod.yml down
TimeoutStartSec=0

[Install]
WantedBy=multi-user.target
EOF

sudo mv /tmp/aisha-v2.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable aisha-v2.service

log_success "Systemd ÑÐµÑ€Ð²Ð¸Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½"

# 14. Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ°
log "ðŸ” Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹..."
echo ""
echo "ðŸ“Š Ð¡Ñ‚Ð°Ñ‚ÑƒÑ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²:"
docker-compose -f docker-compose.prod.yml ps

echo ""
echo "ðŸŒ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° endpoints:"
if curl -s http://localhost:8000/health | grep -q "ok"; then
    log_success "âœ… Health endpoint Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚"
else
    log_warning "âš ï¸  Health endpoint Ð½Ðµ Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÐµÑ‚"
fi

if curl -k -s https://aibots.kz:8443/health | grep -q "ok"; then
    log_success "âœ… HTTPS endpoint Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚"
else
    log_warning "âš ï¸  HTTPS endpoint Ð½Ðµ Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÐµÑ‚"
fi

echo ""
log_success "ðŸŽ‰ Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾!"
echo ""
echo "ðŸ“‹ ÐŸÐ¾Ð»ÐµÐ·Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:"
echo "  - Ð›Ð¾Ð³Ð¸ Ð²ÑÐµÑ… ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²: docker-compose -f docker-compose.prod.yml logs -f"
echo "  - Ð›Ð¾Ð³Ð¸ Ð±Ð¾Ñ‚Ð°: docker-compose -f docker-compose.prod.yml logs -f aisha-bot"
echo "  - Ð›Ð¾Ð³Ð¸ API: docker-compose -f docker-compose.prod.yml logs -f aisha-api"
echo "  - Ð¡Ñ‚Ð°Ñ‚ÑƒÑ: docker-compose -f docker-compose.prod.yml ps"
echo "  - ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº: sudo systemctl restart aisha-v2"
echo "  - ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°: docker-compose -f docker-compose.prod.yml down"
echo ""
echo "ðŸ”— Endpoints:"
echo "  - Health check: https://aibots.kz:8443/health"
echo "  - Webhook: https://aibots.kz:8443/api/v1/avatar/status_update"
echo ""

log "ðŸ“ Ð›Ð¾Ð³Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÑŽÑ‚ÑÑ Ð² /opt/aisha-backend/logs/ Ð¸ /var/log/aisha/" 